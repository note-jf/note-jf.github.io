import{_ as p}from"./plugin-vue_export-helper.21dcd24c.js";import{o as e,c as o,b as n,e as c,a,d as s,r as l}from"./app.c37b87a5.js";const i={},u=a(`<h1 id="_2-\u5355\u70B9\u767B\u5F55-sso" tabindex="-1"><a class="header-anchor" href="#_2-\u5355\u70B9\u767B\u5F55-sso" aria-hidden="true">#</a> 2. \u5355\u70B9\u767B\u5F55\uFF08SSO\uFF09</h1><p>SSO\u82F1\u6587\u5168\u79F0Single Sign On\uFF0C\u5355\u70B9\u767B\u5F55\u3002</p><p>SSO\u662F\u5728\u591A\u4E2A\u5E94\u7528\u7CFB\u7EDF\u4E2D\uFF0C\u7528\u6237\u53EA\u9700\u8981\u767B\u5F55\u4E00\u6B21\u5C31\u53EF\u4EE5\u8BBF\u95EE\u6240\u6709\u76F8\u4E92\u4FE1\u4EFB\u7684\u5E94\u7528\u7CFB\u7EDF\u3002</p><h2 id="_2-1-cookie\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_2-1-cookie\u95EE\u9898" aria-hidden="true">#</a> 2.1. cookie\u95EE\u9898</h2><p>\u7535\u5546\u5E73\u53F0\u901A\u5E38\u7531\u591A\u4E2A\u5FAE\u670D\u52A1\u7EC4\u6210\uFF0C\u6BCF\u4E2A\u5FAE\u670D\u52A1\u90FD\u6709\u72EC\u7ACB\u7684\u57DF\u540D\uFF0C\u800Ccookie\u662F\u6709\u4F5C\u7528\u57DF\u7684\u3002</p><p>\u67E5\u770B\u6D4F\u89C8\u5668\u63A7\u5236\u53F0\uFF1A</p><p>domain\uFF1A\u4F5C\u7528\u57DF\u540D</p><table><thead><tr><th>domain\u53C2\u6570</th><th>atguigu.com</th><th>sso.atguigu.com</th><th>order.atguigu.com</th></tr></thead><tbody><tr><td>atguigu.com</td><td>\u221A</td><td>\u221A</td><td>\u221A</td></tr><tr><td>sso.atguigu.com</td><td>\xD7</td><td>\u221A</td><td>\xD7</td></tr><tr><td>order.atguigu.com</td><td>\xD7</td><td>\xD7</td><td>\u221A</td></tr></tbody></table><p>domain\u6709\u4E24\u70B9\u8981\u6CE8\u610F\uFF1A</p><p>\u200B 1. <strong>domain\u53C2\u6570\u53EF\u4EE5\u8BBE\u7F6E\u7236\u57DF\u540D\u4EE5\u53CA\u81EA\u8EAB\uFF0C\u4F46\u4E0D\u80FD\u8BBE\u7F6E\u5176\u5B83\u57DF\u540D\uFF0C\u5305\u62EC\u5B50\u57DF\u540D\uFF0C\u5426\u5219cookie\u4E0D\u8D77\u4F5C\u7528\u3002</strong></p><p>\u200B 2. <strong>cookie\u7684\u4F5C\u7528\u57DF\u662Fdomain\u672C\u8EAB\u4EE5\u53CAdomain\u4E0B\u7684\u6240\u6709\u5B50\u57DF\u540D\u3002</strong></p><p>Cookie\u7684\u8DEF\u5F84\uFF08Path\uFF09\uFF1A</p><p>\u200B response.addCookie\u9ED8\u8BA4\u653E\u5728\u5F53\u524D\u8DEF\u5F84\u4E0B\uFF0C\u8BBF\u95EE\u5F53\u524D\u8DEF\u5F84\u4E0B\u7684\u6240\u6709\u8BF7\u6C42\u90FD\u4F1A\u5E26</p><p>\u200B \u8BBE\u7F6E/\u6807\u8BC6\u9879\u76EE\u6839\u8DEF\u5F84\uFF0C\u8BBF\u95EE\u9879\u76EE\u4EFB\u4F55\u4F4D\u7F6E\u90FD\u4F1A\u643A\u5E26</p><h2 id="_2-2-\u6F14\u793A\u6848\u4F8B" tabindex="-1"><a class="header-anchor" href="#_2-2-\u6F14\u793A\u6848\u4F8B" aria-hidden="true">#</a> 2.2. \u6F14\u793A\u6848\u4F8B</h2><p>\u628A\u8BFE\u524D\u8D44\u6599\u4E2D\u7684sso\u6F14\u793A\u5DE5\u7A0B \u300Asso-example\u300B\u5BFC\u5165idea\uFF0C\u5E76\u4E14\u542F\u52A8\u3002</p><p>\u5728hosts\u6587\u4EF6\u4E2D\u914D\u7F6E\u57DF\u540D\u7684\u6620\u5C04\uFF1A</p><p>\u8FFD\u52A0\u914D\u7F6E\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>127.0.0.1 client.atguigu.com
127.0.0.1 sso.atguigu.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-1-\u6D4B\u8BD5\u4E00-\u4E0D\u80FD\u8BBF\u95EE\u5144\u5F1F\u57DF\u540Dcookie" tabindex="-1"><a class="header-anchor" href="#_2-2-1-\u6D4B\u8BD5\u4E00-\u4E0D\u80FD\u8BBF\u95EE\u5144\u5F1F\u57DF\u540Dcookie" aria-hidden="true">#</a> 2.2.1. \u6D4B\u8BD5\u4E00\uFF1A\u4E0D\u80FD\u8BBF\u95EE\u5144\u5F1F\u57DF\u540Dcookie</h3><p>\u8BBF\u95EE\uFF1Ahttp://client.atguigu.com:8080/hello</p><p>\u7531\u4E8E\u6CA1\u6709\u767B\u5F55\u4F1A\u91CD\u5B9A\u5411\u5230\u767B\u5F55\u9875\u9762\uFF1A</p><p>\u8F93\u5165\u7528\u6237\u540D\u5BC6\u7801\uFF08\u4EFB\u610F\uFF09\u70B9\u51FB\u767B\u5F55\uFF0C\u53C8\u56DE\u5230\u4E86\u4E0A\u8FF0\u9875\u9762\u3002</p><p>\u67E5\u770B\u6D4F\u89C8\u5668cookie\uFF0C\u53D1\u73B0\uFF1A</p><p>sso.atguigu.com\u4E0B\u5DF2\u7ECF\u6709token\u4FE1\u606F\u3002\u90A3\u4E48\u4E3A\u4EC0\u4E48\u53C8\u56DE\u5230\u4E86\u767B\u5F55\u9875\u9762\u5462\uFF1F</p><p>\u8FD9\u662F\u7531\u4E8E\u70B9\u51FB\u767B\u5F55\u65F6\uFF0Ccookie\u653E\u5165\u4E86sso.atguigu.com\u8FD9\u4E2A\u4F5C\u7528\u57DF\uFF0Cclient\u57DF\u4E0B\u6CA1\u6709cookie\u5BFC\u81F4\uFF0C\u518D\u6B21\u8BBF\u95EEclient\u65F6\uFF0Cclient\u8BA4\u4E3A\u6CA1\u6709\u767B\u5F55\uFF0C\u53C8\u91CD\u5B9A\u5411\u5230\u767B\u5F55\u9875\u9762</p><h3 id="_2-2-2-\u6D4B\u8BD5\u4E8C-\u53EF\u4EE5\u8BBF\u95EE\u7236\u57DF\u540D\u7684cookie" tabindex="-1"><a class="header-anchor" href="#_2-2-2-\u6D4B\u8BD5\u4E8C-\u53EF\u4EE5\u8BBF\u95EE\u7236\u57DF\u540D\u7684cookie" aria-hidden="true">#</a> 2.2.2. \u6D4B\u8BD5\u4E8C\uFF1A\u53EF\u4EE5\u8BBF\u95EE\u7236\u57DF\u540D\u7684cookie</h3><p>\u4FEE\u6539sso-service\u5DE5\u7A0BLoginController\u7C7B\u7684login\u65B9\u6CD5\uFF0C\u628Acookie\u7684\u4F5C\u7528\u57DF\u8BBE\u7F6E\u4E3A<code>atguigu.com</code></p><p>\u91CD\u542Fsso-service\u3002</p><p>\u5E76\u6E05\u7406\u6389\u6D4F\u89C8\u5668\u4E2D\u7684cookie\uFF1A</p><p>\u8BBF\u95EE\uFF1Ahttp://client.atguigu.com:8080/hello</p><p>\u4F9D\u7136\u91CD\u5B9A\u5411\u5230\u767B\u5F55\u9875\u9762\uFF1A</p><p>\u8F93\u5165\u4EFB\u610F\u5185\u5BB9\uFF0C\u70B9\u51FB\u767B\u5F55\uFF1A</p><p>\u53EF\u4EE5\u767B\u5F55\u6210\u529F\uFF01\uFF01</p><h3 id="_2-2-3-\u6D4B\u8BD5\u4E09-cookie\u7684\u4F5C\u7528\u8DEF\u5F84" tabindex="-1"><a class="header-anchor" href="#_2-2-3-\u6D4B\u8BD5\u4E09-cookie\u7684\u4F5C\u7528\u8DEF\u5F84" aria-hidden="true">#</a> 2.2.3. \u6D4B\u8BD5\u4E09\uFF1Acookie\u7684\u4F5C\u7528\u8DEF\u5F84</h3><p>\u4FEE\u6539sso-service\u5DE5\u7A0BLoginController\u7C7B\u7684login\u65B9\u6CD5\uFF0C\u628Acookie\u7684\u4F5C\u7528\u8DEF\u5F84\u8BBE\u7F6E\u4E3A<code>/hello</code></p><p>\u91CD\u542Fsso-service\u670D\u52A1\uFF0C\u5E76\u6E05\u7406\u6389cookie\u4FE1\u606F\u3002</p><p>\u5728\u6D4F\u89C8\u5668\u4E2D\u8BBF\u95EE\uFF1Ahttp://client.atguigu.com:8080/hello</p><p>\u4F9D\u7136\u91CD\u5B9A\u5411\u5230\u767B\u5F55\u9875\u9762\uFF0C\u8F93\u5165\u4EFB\u610F\u5185\u5BB9\uFF0C\u70B9\u51FB\u767B\u5F55\uFF1A</p><p>\u53EF\u4EE5\u767B\u5F55\u6210\u529F\uFF0C\u4F46\u662Fcookie\u7684\u4F5C\u7528\u8DEF\u5F84\u662F/hello\u3002</p><p>\u6B64\u65F6\u8BBF\u95EE\uFF1Ahttp://client.atguigu.com:8080/hello1</p><p>\u53C8\u4F1A\u8DF3\u8F6C\u5230\u767B\u5F55\u9875\u9762\u3002\u539F\u56E0\uFF1Acookie\u53EA\u80FD\u5728/hello\u8DEF\u5F84\u53CA\u5176\u5B50\u8DEF\u5F84\u4E0B\u53EF\u4EE5\u6B63\u5E38\u8BBF\u95EE\u3002</p><h2 id="_2-3-\u6709\u72B6\u6001\u767B\u5F55" tabindex="-1"><a class="header-anchor" href="#_2-3-\u6709\u72B6\u6001\u767B\u5F55" aria-hidden="true">#</a> 2.3. \u6709\u72B6\u6001\u767B\u5F55</h2><p>\u4E3A\u4E86\u4FDD\u8BC1\u5BA2\u6237\u7AEFcookie\u7684\u5B89\u5168\u6027\uFF0C\u670D\u52A1\u7AEF\u9700\u8981\u8BB0\u5F55\u6BCF\u6B21\u4F1A\u8BDD\u7684\u5BA2\u6237\u7AEF\u4FE1\u606F\uFF0C\u4ECE\u800C\u8BC6\u522B\u5BA2\u6237\u7AEF\u8EAB\u4EFD\uFF0C\u6839\u636E\u7528\u6237\u8EAB\u4EFD\u8FDB\u884C\u8BF7\u6C42\u7684\u5904\u7406\uFF0C\u5178\u578B\u7684\u8BBE\u8BA1\u5982tomcat\u4E2D\u7684session\u3002</p><p>\u4F8B\u5982\u767B\u5F55\uFF1A\u7528\u6237\u767B\u5F55\u540E\uFF0C\u6211\u4EEC\u628A\u767B\u5F55\u8005\u7684\u4FE1\u606F\u4FDD\u5B58\u5728\u670D\u52A1\u7AEFsession\u4E2D\uFF0C\u5E76\u4E14\u7ED9\u7528\u6237\u4E00\u4E2Acookie\u503C\uFF0C\u8BB0\u5F55\u5BF9\u5E94\u7684session\u3002\u7136\u540E\u4E0B\u6B21\u8BF7\u6C42\uFF0C\u7528\u6237\u643A\u5E26cookie\u503C\u6765\uFF0C\u6211\u4EEC\u5C31\u80FD\u8BC6\u522B\u5230\u5BF9\u5E94session\uFF0C\u4ECE\u800C\u627E\u5230\u7528\u6237\u7684\u4FE1\u606F\u3002</p><p>\u7F3A\u70B9\u662F\u4EC0\u4E48\uFF1F</p><ul><li>\u670D\u52A1\u7AEF\u4FDD\u5B58\u5927\u91CF\u6570\u636E\uFF0C\u589E\u52A0\u670D\u52A1\u7AEF\u538B\u529B</li><li>\u670D\u52A1\u7AEF\u4FDD\u5B58\u7528\u6237\u72B6\u6001\uFF0C\u65E0\u6CD5\u8FDB\u884C\u6C34\u5E73\u6269\u5C55</li><li>\u5BA2\u6237\u7AEF\u8BF7\u6C42\u4F9D\u8D56\u670D\u52A1\u7AEF\uFF0C\u591A\u6B21\u8BF7\u6C42\u5FC5\u987B\u8BBF\u95EE\u540C\u4E00\u53F0\u670D\u52A1\u5668</li></ul><p>\u5373\u4F7F\u4F7F\u7528redis\u4FDD\u5B58\u7528\u6237\u7684\u4FE1\u606F\uFF0C\u4E5F\u4F1A\u635F\u8017\u670D\u52A1\u5668\u8D44\u6E90\u3002</p><h2 id="_2-4-\u65E0\u72B6\u6001\u767B\u5F55" tabindex="-1"><a class="header-anchor" href="#_2-4-\u65E0\u72B6\u6001\u767B\u5F55" aria-hidden="true">#</a> 2.4. \u65E0\u72B6\u6001\u767B\u5F55</h2><p>\u5FAE\u670D\u52A1\u96C6\u7FA4\u4E2D\u7684\u6BCF\u4E2A\u670D\u52A1\uFF0C\u5BF9\u5916\u63D0\u4F9B\u7684\u90FD\u662FRest\u98CE\u683C\u7684\u63A5\u53E3\u3002\u800CRest\u98CE\u683C\u7684\u4E00\u4E2A\u6700\u91CD\u8981\u7684\u89C4\u8303\u5C31\u662F\uFF1A\u670D\u52A1\u7684\u65E0\u72B6\u6001\u6027\uFF0C\u5373\uFF1A</p><ul><li>\u670D\u52A1\u7AEF\u4E0D\u4FDD\u5B58\u4EFB\u4F55\u5BA2\u6237\u7AEF\u8BF7\u6C42\u8005\u4FE1\u606F</li><li>\u5BA2\u6237\u7AEF\u7684\u6BCF\u6B21\u8BF7\u6C42\u5FC5\u987B\u5177\u5907\u81EA\u63CF\u8FF0\u4FE1\u606F\uFF0C\u901A\u8FC7\u8FD9\u4E9B\u4FE1\u606F\u8BC6\u522B\u5BA2\u6237\u7AEF\u8EAB\u4EFD</li></ul><p>\u5E26\u6765\u7684\u597D\u5904\u662F\u4EC0\u4E48\u5462\uFF1F</p><ul><li>\u5BA2\u6237\u7AEF\u8BF7\u6C42\u4E0D\u4F9D\u8D56\u670D\u52A1\u7AEF\u7684\u4FE1\u606F\uFF0C\u4EFB\u4F55\u591A\u6B21\u8BF7\u6C42\u4E0D\u9700\u8981\u5FC5\u987B\u8BBF\u95EE\u5230\u540C\u4E00\u53F0\u670D\u52A1</li><li>\u670D\u52A1\u7AEF\u7684\u96C6\u7FA4\u548C\u72B6\u6001\u5BF9\u5BA2\u6237\u7AEF\u900F\u660E</li><li>\u670D\u52A1\u7AEF\u53EF\u4EE5\u4EFB\u610F\u7684\u8FC1\u79FB\u548C\u4F38\u7F29</li><li>\u51CF\u5C0F\u670D\u52A1\u7AEF\u5B58\u50A8\u538B\u529B</li></ul><h2 id="_2-5-\u65E0\u72B6\u6001\u767B\u5F55\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_2-5-\u65E0\u72B6\u6001\u767B\u5F55\u6D41\u7A0B" aria-hidden="true">#</a> 2.5. \u65E0\u72B6\u6001\u767B\u5F55\u6D41\u7A0B</h2><p>\u65E0\u72B6\u6001\u767B\u5F55\u7684\u6D41\u7A0B\uFF1A</p><ul><li>\u5F53\u5BA2\u6237\u7AEF\u7B2C\u4E00\u6B21\u8BF7\u6C42\u670D\u52A1\u65F6\uFF0C\u670D\u52A1\u7AEF\u5BF9\u7528\u6237\u8FDB\u884C\u4FE1\u606F\u8BA4\u8BC1\uFF08\u767B\u5F55\uFF09</li><li>\u8BA4\u8BC1\u901A\u8FC7\uFF0C\u5C06\u7528\u6237\u4FE1\u606F\u8FDB\u884C\u52A0\u5BC6\u5F62\u6210token\uFF0C\u8FD4\u56DE\u7ED9\u5BA2\u6237\u7AEF\uFF0C\u4F5C\u4E3A\u767B\u5F55\u51ED\u8BC1</li><li>\u4EE5\u540E\u6BCF\u6B21\u8BF7\u6C42\uFF0C\u5BA2\u6237\u7AEF\u90FD\u643A\u5E26\u8BA4\u8BC1\u7684token</li><li>\u670D\u52A1\u7684\u5BF9token\u8FDB\u884C\u89E3\u5BC6\uFF0C\u5224\u65AD\u662F\u5426\u6709\u6548\u3002</li></ul><p>\u6D41\u7A0B\u56FE\uFF1A</p><p>\u6574\u4E2A\u767B\u5F55\u8FC7\u7A0B\u4E2D\uFF0C\u6700\u5173\u952E\u7684\u70B9\u662F\u4EC0\u4E48\uFF1F</p><p><strong>token\u7684\u5B89\u5168\u6027</strong></p><p>token\u662F\u8BC6\u522B\u5BA2\u6237\u7AEF\u8EAB\u4EFD\u7684\u552F\u4E00\u6807\u793A\uFF0C\u5982\u679C\u52A0\u5BC6\u4E0D\u591F\u4E25\u5BC6\uFF0C\u88AB\u4EBA\u4F2A\u9020\u90A3\u5C31\u5B8C\u86CB\u4E86\u3002</p><p>\u91C7\u7528\u4F55\u79CD\u65B9\u5F0F\u52A0\u5BC6\u624D\u662F\u5B89\u5168\u53EF\u9760\u7684\u5462\uFF1F</p><p>\u6211\u4EEC\u5C06\u91C7\u7528<code>JWT + RSA\u975E\u5BF9\u79F0\u52A0\u5BC6</code></p><h1 id="_3-jwt\u5B9E\u73B0\u65E0\u72B6\u6001\u767B\u5F55" tabindex="-1"><a class="header-anchor" href="#_3-jwt\u5B9E\u73B0\u65E0\u72B6\u6001\u767B\u5F55" aria-hidden="true">#</a> 3. jwt\u5B9E\u73B0\u65E0\u72B6\u6001\u767B\u5F55</h1><p>JWT\uFF0C\u5168\u79F0\u662FJson Web Token\uFF0C \u662FJSON\u98CE\u683C\u8F7B\u91CF\u7EA7\u7684\u6388\u6743\u548C\u8EAB\u4EFD\u8BA4\u8BC1\u89C4\u8303\uFF0C\u53EF\u5B9E\u73B0\u65E0\u72B6\u6001\u3001\u5206\u5E03\u5F0F\u7684Web\u5E94\u7528\u6388\u6743\uFF1B\u5B98\u7F51\uFF1Ahttps://jwt.io</p><p>GitHub\u4E0Ajwt\u7684java\u5BA2\u6237\u7AEF\uFF1Ahttps://github.com/jwtk/jjwt</p><h2 id="_3-1-\u6570\u636E\u683C\u5F0F" tabindex="-1"><a class="header-anchor" href="#_3-1-\u6570\u636E\u683C\u5F0F" aria-hidden="true">#</a> 3.1. \u6570\u636E\u683C\u5F0F</h2><p>JWT\u5305\u542B\u4E09\u90E8\u5206\u6570\u636E\uFF1A</p><ul><li><p>Header\uFF1A\u5934\u90E8\uFF0C\u901A\u5E38\u5934\u90E8\u6709\u4E24\u90E8\u5206\u4FE1\u606F\uFF1A</p><ul><li>token\u7C7B\u578B\uFF1AJWT</li><li>\u52A0\u5BC6\u65B9\u5F0F\uFF1Abase64\uFF08HS256\uFF09</li></ul></li><li><p>Payload\uFF1A\u8F7D\u8377\uFF0C\u5C31\u662F\u6709\u6548\u6570\u636E\uFF0C\u4E00\u822C\u5305\u542B\u4E0B\u9762\u4FE1\u606F\uFF1A</p><ul><li>\u7528\u6237\u8EAB\u4EFD\u4FE1\u606F\uFF08\u6CE8\u610F\uFF0C\u8FD9\u91CC\u56E0\u4E3A\u91C7\u7528base64\u7F16\u7801\uFF0C\u53EF\u89E3\u7801\uFF0C\u56E0\u6B64\u4E0D\u8981\u5B58\u653E\u654F\u611F\u4FE1\u606F\uFF09</li><li>\u6CE8\u518C\u58F0\u660E\uFF1A\u5982token\u7684\u7B7E\u53D1\u65F6\u95F4\uFF0C\u8FC7\u671F\u65F6\u95F4\uFF0C\u7B7E\u53D1\u4EBA\u7B49</li></ul><p>\u8FD9\u90E8\u5206\u4E5F\u4F1A\u91C7\u7528base64\u7F16\u7801\uFF0C\u5F97\u5230\u7B2C\u4E8C\u90E8\u5206\u6570\u636E</p></li><li><p>Signature\uFF1A\u7B7E\u540D\uFF0C\u662F\u6574\u4E2A\u6570\u636E\u7684\u8BA4\u8BC1\u4FE1\u606F\u3002\u6839\u636E\u524D\u4E24\u6B65\u7684\u6570\u636E\uFF0C\u518D\u52A0\u4E0A\u6307\u5B9A\u7684\u5BC6\u94A5\uFF08secret\uFF09\uFF08\u4E0D\u8981\u6CC4\u6F0F\uFF0C\u6700\u597D\u5468\u671F\u6027\u66F4\u6362\uFF09\uFF0C\u901A\u8FC7base64\u7F16\u7801\u751F\u6210\u3002\u7528\u4E8E\u9A8C\u8BC1\u6574\u4E2A\u6570\u636E\u5B8C\u6574\u548C\u53EF\u9760\u6027</p></li></ul><h2 id="_3-2-jwt\u4EA4\u4E92\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_3-2-jwt\u4EA4\u4E92\u6D41\u7A0B" aria-hidden="true">#</a> 3.2. JWT\u4EA4\u4E92\u6D41\u7A0B</h2><p>\u6D41\u7A0B\u56FE\uFF1A</p><p>\u6B65\u9AA4\u7FFB\u8BD1\uFF1A</p><ul><li>1\u3001\u7528\u6237\u767B\u5F55</li><li>2\u3001\u670D\u52A1\u7684\u8BA4\u8BC1\uFF0C\u901A\u8FC7\u540E\u6839\u636Esecret\u751F\u6210token</li><li>3\u3001\u5C06\u751F\u6210\u7684token\u8FD4\u56DE\u7ED9\u6D4F\u89C8\u5668</li><li>4\u3001\u7528\u6237\u6BCF\u6B21\u8BF7\u6C42\u643A\u5E26token</li><li>5\u3001\u670D\u52A1\u7AEF\u5229\u7528\u516C\u94A5\u89E3\u8BFBjwt\u7B7E\u540D\uFF0C\u5224\u65AD\u7B7E\u540D\u6709\u6548\u540E\uFF0C\u4ECEPayload\u4E2D\u83B7\u53D6\u7528\u6237\u4FE1\u606F</li><li>6\u3001\u5904\u7406\u8BF7\u6C42\uFF0C\u8FD4\u56DE\u54CD\u5E94\u7ED3\u679C</li></ul><p>\u56E0\u4E3AJWT\u7B7E\u53D1\u7684token\u4E2D\u5DF2\u7ECF\u5305\u542B\u4E86\u7528\u6237\u7684\u8EAB\u4EFD\u4FE1\u606F\uFF0C\u5E76\u4E14\u6BCF\u6B21\u8BF7\u6C42\u90FD\u4F1A\u643A\u5E26\uFF0C\u8FD9\u6837\u670D\u52A1\u7684\u5C31\u65E0\u9700\u4FDD\u5B58\u7528\u6237\u4FE1\u606F\uFF0C\u751A\u81F3\u65E0\u9700\u53BB\u6570\u636E\u5E93\u67E5\u8BE2\uFF0C\u5B8C\u5168\u7B26\u5408\u4E86Rest\u7684\u65E0\u72B6\u6001\u89C4\u8303\u3002</p><h2 id="_3-3-\u975E\u5BF9\u79F0\u52A0\u5BC6" tabindex="-1"><a class="header-anchor" href="#_3-3-\u975E\u5BF9\u79F0\u52A0\u5BC6" aria-hidden="true">#</a> 3.3. \u975E\u5BF9\u79F0\u52A0\u5BC6</h2><p>\u52A0\u5BC6\u6280\u672F\u662F\u5BF9\u4FE1\u606F\u8FDB\u884C\u7F16\u7801\u548C\u89E3\u7801\u7684\u6280\u672F\uFF0C\u7F16\u7801\u662F\u628A\u539F\u6765\u53EF\u8BFB\u4FE1\u606F\uFF08\u53C8\u79F0\u660E\u6587\uFF09\u8BD1\u6210\u4EE3\u7801\u5F62\u5F0F\uFF08\u53C8\u79F0\u5BC6\u6587\uFF09\uFF0C\u5176\u9006\u8FC7\u7A0B\u5C31\u662F\u89E3\u7801\uFF08\u89E3\u5BC6\uFF09\uFF0C\u52A0\u5BC6\u6280\u672F\u7684\u8981\u70B9\u662F\u52A0\u5BC6\u7B97\u6CD5\uFF0C\u52A0\u5BC6\u7B97\u6CD5\u53EF\u4EE5\u5206\u4E3A\u4E09\u7C7B\uFF1A</p>`,75),k=a("<li>\u5BF9\u79F0\u52A0\u5BC6\uFF0C\u5982AES <ul><li>\u57FA\u672C\u539F\u7406\uFF1A\u5C06\u660E\u6587\u5206\u6210N\u4E2A\u7EC4\uFF0C\u7136\u540E\u4F7F\u7528\u5BC6\u94A5\u5BF9\u5404\u4E2A\u7EC4\u8FDB\u884C\u52A0\u5BC6\uFF0C\u5F62\u6210\u5404\u81EA\u7684\u5BC6\u6587\uFF0C\u6700\u540E\u628A\u6240\u6709\u7684\u5206\u7EC4\u5BC6\u6587\u8FDB\u884C\u5408\u5E76\uFF0C\u5F62\u6210\u6700\u7EC8\u7684\u5BC6\u6587\u3002</li><li>\u4F18\u52BF\uFF1A\u7B97\u6CD5\u516C\u5F00\u3001\u8BA1\u7B97\u91CF\u5C0F\u3001\u52A0\u5BC6\u901F\u5EA6\u5FEB\u3001\u52A0\u5BC6\u6548\u7387\u9AD8</li><li>\u7F3A\u9677\uFF1A\u53CC\u65B9\u90FD\u4F7F\u7528\u540C\u6837\u5BC6\u94A5\uFF0C\u5B89\u5168\u6027\u5F97\u4E0D\u5230\u4FDD\u8BC1</li></ul></li><li>\u975E\u5BF9\u79F0\u52A0\u5BC6\uFF0C\u5982RSA <ul><li>\u57FA\u672C\u539F\u7406\uFF1A\u540C\u65F6\u751F\u6210\u4E24\u628A\u5BC6\u94A5\uFF1A\u79C1\u94A5\u548C\u516C\u94A5\uFF0C\u79C1\u94A5\u9690\u79D8\u4FDD\u5B58\uFF0C\u516C\u94A5\u53EF\u4EE5\u4E0B\u53D1\u7ED9\u4FE1\u4EFB\u5BA2\u6237\u7AEF <ul><li>\u79C1\u94A5\u52A0\u5BC6\uFF0C\u6301\u6709\u516C\u94A5\u624D\u53EF\u4EE5\u89E3\u5BC6</li><li>\u516C\u94A5\u52A0\u5BC6\uFF0C\u6301\u6709\u79C1\u94A5\u624D\u53EF\u89E3\u5BC6</li></ul></li><li>\u4F18\u70B9\uFF1A\u5B89\u5168\uFF0C\u96BE\u4EE5\u7834\u89E3</li><li>\u7F3A\u70B9\uFF1A\u7B97\u6CD5\u6BD4\u8F83\u8017\u65F6</li></ul></li>",2),r=s("\u4E0D\u53EF\u9006\u52A0\u5BC6\uFF0C\u5982MD5\uFF0CSHA "),d=s("\u57FA\u672C\u539F\u7406\uFF1A\u52A0\u5BC6\u8FC7\u7A0B\u4E2D\u4E0D\u9700\u8981\u4F7F\u7528"),v={href:"https://baike.baidu.com/item/%E5%AF%86%E9%92%A5",target:"_blank",rel:"noopener noreferrer"},m=s("\u5BC6\u94A5"),b=s("\uFF0C\u8F93\u5165\u660E\u6587\u540E\u7531\u7CFB\u7EDF\u76F4\u63A5\u7ECF\u8FC7\u52A0\u5BC6\u7B97\u6CD5\u5904\u7406\u6210\u5BC6\u6587\uFF0C\u8FD9\u79CD\u52A0\u5BC6\u540E\u7684\u6570\u636E\u662F\u65E0\u6CD5\u88AB\u89E3\u5BC6\u7684\uFF0C\u65E0\u6CD5\u6839\u636E\u5BC6\u6587\u63A8\u7B97\u51FA\u660E\u6587\u3002"),g=a(`<p>RSA\u7B97\u6CD5\u5386\u53F2\uFF1A</p><p>1977\u5E74\uFF0C\u4E09\u4F4D\u6570\u5B66\u5BB6Rivest\u3001Shamir \u548C Adleman \u8BBE\u8BA1\u4E86\u4E00\u79CD\u7B97\u6CD5\uFF0C\u53EF\u4EE5\u5B9E\u73B0\u975E\u5BF9\u79F0\u52A0\u5BC6\u3002\u8FD9\u79CD\u7B97\u6CD5\u7528\u4ED6\u4EEC\u4E09\u4E2A\u4EBA\u7684\u540D\u5B57\u7F29\u5199\uFF1ARSA</p><h1 id="_4-\u642D\u5EFA\u6388\u6743\u4E2D\u5FC3" tabindex="-1"><a class="header-anchor" href="#_4-\u642D\u5EFA\u6388\u6743\u4E2D\u5FC3" aria-hidden="true">#</a> 4. \u642D\u5EFA\u6388\u6743\u4E2D\u5FC3</h1><p>\u7528\u6237\u9274\u6743\uFF1A</p><ul><li>\u63A5\u6536\u7528\u6237\u7684\u767B\u5F55\u8BF7\u6C42\uFF0C\u901A\u8FC7\u7528\u6237\u4E2D\u5FC3\u7684\u63A5\u53E3\u8FDB\u884C\u6821\u9A8C\uFF0C\u901A\u8FC7\u540E\u751F\u6210JWT</li><li>\u4F7F\u7528\u79C1\u94A5\u751F\u6210JWT\u5E76\u8FD4\u56DE</li></ul><p>\u6709\u4E00\u4E9B\u751F\u6210jwt\uFF0C\u89E3\u6790jwt\u8FD9\u6837\u884C\u4E3A\u7684\u5DE5\u5177\u7C7B\uFF0C\u4EE5\u540E\u5728\u5176\u5B83\u5FAE\u670D\u52A1\u4E2D\u4E5F\u4F1A\u7528\u5230\uFF0C\u56E0\u6B64\u653E\u5728gmall-core\u4E2D\u3002</p><h2 id="_4-1-\u521B\u5EFA\u5DE5\u7A0B" tabindex="-1"><a class="header-anchor" href="#_4-1-\u521B\u5EFA\u5DE5\u7A0B" aria-hidden="true">#</a> 4.1. \u521B\u5EFA\u5DE5\u7A0B</h2><p>pom.xml\u4E2D\u6DFB\u52A0gmall-common\u53CAgmall-ums-interface\u7684\u4F9D\u8D56</p><p>\u542F\u52A8\u7C7B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GmallAuthApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GmallAuthApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>bootstrap.yml\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> auth<span class="token punctuation">-</span>service
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>application.yml\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">18089</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8179</span>
  <span class="token key atrule">zipkin</span><span class="token punctuation">:</span>
    <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>9411/
    <span class="token key atrule">sender</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> web
    <span class="token key atrule">discovery-client-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">sleuth</span><span class="token punctuation">:</span>
    <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
      <span class="token key atrule">probability</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">thymeleaf</span><span class="token punctuation">:</span>
    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7F51\u5173\u5DE5\u7A0Bgmall-gateway\u6DFB\u52A0\u7528\u6237\u6388\u6743\u7684\u7F51\u5173\u8DEF\u7531\uFF1A</p><p>\u5728nginx\u4E2D\u6DFB\u52A0\uFF1Asso.gmall.com</p><p>\u5728hosts\u6587\u4EF6\u4E2D\u6DFB\u52A0sso.gmall.com\u7684\u57DF\u540D\u6620\u5C04\u3002</p><p>\u6CE8\u610F\uFF1A\u4E0D\u8981\u5FD8\u8BB0\u91CD\u542F\u7F51\u5173\uFF0C\u91CD\u65B0\u52A0\u8F7Dnginx\u914D\u7F6E\u3002</p><h2 id="_4-2-jwt\u5DE5\u5177\u7C7B" tabindex="-1"><a class="header-anchor" href="#_4-2-jwt\u5DE5\u5177\u7C7B" aria-hidden="true">#</a> 4.2. JWT\u5DE5\u5177\u7C7B</h2><p>gmall-common\u5DE5\u7A0B\u4E2D\u5DF2\u7ECF\u5C01\u88C5\u4E86jwt\u76F8\u5173\u7684\u5DE5\u5177\u7C7B\uFF1A</p><p>\u5E76\u5728gmall-common\u4E2D\u7684pom.xml\u4E2D\u5F15\u5165\u4E86jwt\u76F8\u5173\u7684\u4F9D\u8D56\uFF1A</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.10.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt-impl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.10.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt-jackson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.10.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>joda-time<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>joda-time<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.10.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-3-\u6D4B\u8BD5\u5DE5\u5177\u7C7B" tabindex="-1"><a class="header-anchor" href="#_4-3-\u6D4B\u8BD5\u5DE5\u5177\u7C7B" aria-hidden="true">#</a> 4.3. \u6D4B\u8BD5\u5DE5\u5177\u7C7B</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtTest</span> <span class="token punctuation">{</span>

    <span class="token comment">// \u522B\u5FD8\u4E86\u521B\u5EFAD:\\\\project\\rsa\u76EE\u5F55</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> pubKeyPath <span class="token operator">=</span> <span class="token string">&quot;D:\\\\project\\\\rsa\\\\rsa.pub&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> priKeyPath <span class="token operator">=</span> <span class="token string">&quot;D:\\\\project\\\\rsa\\\\rsa.pri&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">PublicKey</span> publicKey<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">PrivateKey</span> privateKey<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRsa</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">RsaUtils</span><span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span>pubKeyPath<span class="token punctuation">,</span> priKeyPath<span class="token punctuation">,</span> <span class="token string">&quot;234&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">//    @BeforeEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGetRsa</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>publicKey <span class="token operator">=</span> <span class="token class-name">RsaUtils</span><span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span>pubKeyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>privateKey <span class="token operator">=</span> <span class="token class-name">RsaUtils</span><span class="token punctuation">.</span><span class="token function">getPrivateKey</span><span class="token punctuation">(</span>priKeyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGenerateToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;11&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;liuyan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u751F\u6210token</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> privateKey<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;token = &quot;</span> <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testParseToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiJ9.eyJpZCI6IjExIiwidXNlcm5hbWUiOiJsaXV5YW4iLCJleHAiOjE1ODYwOTg0MDd9.Gjt968x1OhFVUSDvnKK_TdNgau6wFCLXF98Teosidf__FewtOW3ytA5I1H9jU3DVzrhDfZl0fFfxNJrPPb75_WNKj06f6lB2yRy8fbazzVDrtzsBcPqEa1HeVoNA3NmUVQNlPC3ckYhZ-yu9BT3km3lY0eGum_jPivBHLsXLMbFnSnpXIjYi3kguJfXXRZYKuanGttCV6t7uCWd10GWhEBbXhIi81houaALr2cDWtqHUBC6FbJ0oVdxAaZixwnZJm_vSUjmYjM062H3CJwX44WCxLZXhSRCWhWo3HGpSU2LuUyfd_IJw8MDdI5w31P3dRczAjMjMykAhGBlOCGwy7Q&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">// \u89E3\u6790token</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">getInfoFromToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;id: &quot;</span> <span class="token operator">+</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;userName: &quot;</span> <span class="token operator">+</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6D4B\u8BD5\u751F\u6210\u516C\u94A5\u548C\u79C1\u94A5\uFF0C\u6211\u4EEC\u8FD0\u884CtestRsa\u65B9\u6CD5\uFF1A<strong>\u6CE8\u610F\u9700\u8981\u628A@Before\u65B9\u6CD5\u6CE8\u91CA\u6389</strong></p><p>\u8FD0\u884C\u4E4B\u540E\uFF0C\u67E5\u770B\u76EE\u6807\u76EE\u5F55\uFF1A</p><p>\u6D4B\u8BD5testGenerateToken\u751F\u6210token\uFF1A\u6CE8\u610F\u628A@BeforeEach\u7684\u6CE8\u91CA\u53BB\u6389\u7684</p><p>\u6D4B\u8BD5\u89E3\u6790token\uFF1A</p><p>\u6B63\u5E38\u60C5\u51B5\uFF1A</p><p>\u4EFB\u610F\u6539\u52A8\u4E00\u4E0B\uFF1A</p><h2 id="_4-4-\u914D\u7F6E\u516C\u94A5\u548C\u79C1\u94A5" tabindex="-1"><a class="header-anchor" href="#_4-4-\u914D\u7F6E\u516C\u94A5\u548C\u79C1\u94A5" aria-hidden="true">#</a> 4.4. \u914D\u7F6E\u516C\u94A5\u548C\u79C1\u94A5</h2><p>\u6211\u4EEC\u9700\u8981\u5728\u6388\u6743\u4E2D\u5FC3\u751F\u6210\u771F\u6B63\u7684\u516C\u94A5\u548C\u79C1\u94A5\u3002\u53EF\u4EE5\u628A\u76F8\u5173\u914D\u7F6E\u5185\u5BB9\u914D\u7F6E\u5230gmall-auth\u5DE5\u7A0B\u7684<code>application.yml</code>\u4E2D\u6216\u8005\u914D\u7F6E\u4E2D\u5FC3\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">auth</span><span class="token punctuation">:</span>
  <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
    <span class="token key atrule">pubKeyPath</span><span class="token punctuation">:</span> D<span class="token punctuation">:</span>\\\\project<span class="token punctuation">-</span>1010\\\\rsa\\\\rsa.pub
    <span class="token key atrule">priKeyPath</span><span class="token punctuation">:</span> D<span class="token punctuation">:</span>\\\\project<span class="token punctuation">-</span>1010\\\\rsa\\\\rsa.pri
    <span class="token key atrule">secret</span><span class="token punctuation">:</span> 30489ouerweljrLROE@<span class="token comment">#)(@$*343jlsdf</span>
    <span class="token key atrule">cookieName</span><span class="token punctuation">:</span> GMALL<span class="token punctuation">-</span>TOKEN
    <span class="token key atrule">expire</span><span class="token punctuation">:</span> <span class="token number">180</span>
    <span class="token key atrule">unick</span><span class="token punctuation">:</span> unick
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u7F16\u5199\u5C5E\u6027\u7C7B\u8BFB\u53D6jwt\u914D\u7F6E\uFF0C\u5E76\u4ECE\u79D8\u94A5\u914D\u7F6E\u6587\u4EF6\u4E2D\u8BFB\u53D6\u51FA\u54CD\u5E94\u7684\u516C\u94A5\u53CA\u79C1\u94A5\uFF0C\u52A0\u8F7D\u8FD9\u4E9B\u6570\u636E\uFF1A</p><p>\u5185\u5BB9\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;auth.jwt&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtProperties</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> pubKeyPath<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> priKeyPath<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> secret<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> cookieName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> expire<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> unick<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">PublicKey</span> publicKey<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">PrivateKey</span> privateKey<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u8BE5\u65B9\u6CD5\u5728\u6784\u9020\u65B9\u6CD5\u6267\u884C\u4E4B\u540E\u6267\u884C
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">File</span> pubFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>pubKeyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">File</span> priFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>priKeyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u5982\u679C\u516C\u94A5\u6216\u8005\u79C1\u94A5\u4E0D\u5B58\u5728\uFF0C\u91CD\u65B0\u751F\u6210\u516C\u94A5\u548C\u79C1\u94A5</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pubFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>priFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">RsaUtil</span><span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span>pubKeyPath<span class="token punctuation">,</span> priKeyPath<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>publicKey <span class="token operator">=</span> <span class="token class-name">RsaUtil</span><span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span>pubKeyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>privateKey <span class="token operator">=</span> <span class="token class-name">RsaUtil</span><span class="token punctuation">.</span><span class="token function">getPrivateKey</span><span class="token punctuation">(</span>priKeyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u751F\u6210\u516C\u94A5\u548C\u79C1\u94A5\u51FA\u9519&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_5-\u5B8C\u6210\u767B\u5F55\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#_5-\u5B8C\u6210\u767B\u5F55\u529F\u80FD" aria-hidden="true">#</a> 5. \u5B8C\u6210\u767B\u5F55\u529F\u80FD</h1><h2 id="_5-1-\u8DF3\u8F6C\u5230\u767B\u5F55\u9875" tabindex="-1"><a class="header-anchor" href="#_5-1-\u8DF3\u8F6C\u5230\u767B\u5F55\u9875" aria-hidden="true">#</a> 5.1. \u8DF3\u8F6C\u5230\u767B\u5F55\u9875</h2><p>\u53C2\u7167\u4EAC\u4E1C\uFF0C\u5F53\u70B9\u51FB\u767B\u5F55\u8DF3\u8F6C\u5230\u767B\u5F55\u9875\u9762\u65F6\uFF0C\u5982\u4E0B\uFF1As</p><p>\u4F1A\u8BB0\u5F55\u8DF3\u8F6C\u5230\u767B\u5F55\u9875\u9762\u524D\u7684\u9875\u9762\u5730\u5740\uFF0C\u767B\u5F55\u6210\u529F\u540E\u8981\u56DE\u5230\u539F\u6765\u7684\u9875\u9762\u3002</p><p>\u628A\u8BFE\u524D\u8D44\u6599\u52A8\u6001\u9875\u9762\u4E2D\u7684common\u76EE\u5F55\u53CAlogin.html\u62F7\u8D1D\u5230templates\u76EE\u5F55\u4E0B</p><p>\u6DFB\u52A0AuthController\uFF0C\u5E76\u6DFB\u52A0\u9875\u9762\u8DF3\u8F6C\u65B9\u6CD5\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;toLogin.html&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toLogin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;returnUrl&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> returnUrl<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token comment">// \u628A\u767B\u5F55\u524D\u7684\u9875\u9762\u5730\u5740\uFF0C\u8BB0\u5F55\u5230\u767B\u5F55\u9875\u9762\uFF0C\u4EE5\u5907\u5C06\u6765\u767B\u5F55\u6210\u529F\uFF0C\u56DE\u5230\u767B\u5F55\u524D\u7684\u9875\u9762</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;returnUrl&quot;</span><span class="token punctuation">,</span> returnUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728login.html\u9875\u9762\u4F1A\u8BB0\u5F55returnUrl\u5730\u5740\uFF0C\u5C06\u6765\u767B\u5F55\u6210\u529F\u540E\u91CD\u5B9A\u5411\u5230\u8BE5\u5730\u5740\uFF1A</p><p>\u5728\u6D4F\u89C8\u5668\u8F93\u5165\uFF1Ahttp://sso.gmall.com/toLogin.html?returnUrl=http://www.gmall.com</p><p>\u6548\u679C\u5982\u4E0B\uFF1A</p><h2 id="_5-2-\u5B8C\u6210\u767B\u5F55\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#_5-2-\u5B8C\u6210\u767B\u5F55\u529F\u80FD" aria-hidden="true">#</a> 5.2. \u5B8C\u6210\u767B\u5F55\u529F\u80FD</h2><p>\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u9700\u8981\u5728<code>gmall-auth</code>\u7F16\u5199\u767B\u5F55\u4EE3\u7801\u3002\u57FA\u672C\u6D41\u7A0B\u5982\u4E0B\uFF1A</p><ul><li>\u5BA2\u6237\u7AEF\u643A\u5E26\u7528\u6237\u540D\u548C\u5BC6\u7801\u8BF7\u6C42\u767B\u5F55 \uFF0C\u5E76\u643A\u5E26\u767B\u5F55\u524D\u9875\u9762\u7684\u8DEF\u5F84</li><li>\u6388\u6743\u4E2D\u5FC3\u8C03\u7528\u7528\u6237\u4E2D\u5FC3\u63A5\u53E3\uFF0C\u6839\u636E\u7528\u6237\u540D\u548C\u5BC6\u7801\u67E5\u8BE2\u7528\u6237\u4FE1\u606F</li><li>\u7528\u6237\u540D\u5BC6\u7801\u4E0D\u6B63\u786E\uFF0C\u4E0D\u80FD\u83B7\u53D6\u7528\u6237\uFF0C\u767B\u5F55\u5931\u8D25</li><li>\u5982\u679C\u6821\u9A8C\u6210\u529F\uFF0C\u5219\u751F\u6210JWT\uFF0Cjwt\u8981\u9632\u6B62\u522B\u4EBA\u76D7\u53D6</li><li>\u628Ajwt\u653E\u5165cookie</li><li>\u4E3A\u4E86\u65B9\u4FBF\u9875\u9762\u5C55\u793A\u767B\u5F55\u7528\u6237\u6635\u79F0\uFF0C\u5411cookie\u4E2D\u5355\u72EC\u5199\u5165\u6635\u79F0\uFF08\u4F8B\u5982\u4EAC\u4E1Ccookie\u4E2D\u7684\u7684<strong>unick</strong>\uFF09</li><li>\u91CD\u5B9A\u5411 \u56DE\u5230\u767B\u5F55\u524D\u7684\u9875\u9762</li></ul><h3 id="_5-2-1-authcontroller" tabindex="-1"><a class="header-anchor" href="#_5-2-1-authcontroller" aria-hidden="true">#</a> 5.2.1. AuthController</h3><p>\u7F16\u5199\u6388\u6743\u63A5\u53E3\uFF0C\u6211\u4EEC\u63A5\u6536\u767B\u5F55\u540D\u548C\u5BC6\u7801\u53CA\u767B\u9646\u524D\u7684\u9875\u9762\u5730\u5740\uFF0C\u767B\u5F55\u6210\u529F\u540E\u91CD\u5B9A\u5411\u5230\u767B\u9646\u524D\u9875\u9762\u3002</p><ul><li>\u8BF7\u6C42\u65B9\u5F0F\uFF1Apost</li><li>\u8BF7\u6C42\u8DEF\u5F84\uFF1A/login</li><li>\u8BF7\u6C42\u53C2\u6570\uFF1AloginName\u548Cpassword</li><li>\u8FD4\u56DE\u7ED3\u679C\uFF1A\u65E0</li></ul><p>\u4EE3\u7801\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthService</span> authService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtProperties</span> jwtProperties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;toLogin.html&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toLogin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;returnUrl&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> returnUrl<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token comment">// \u628A\u767B\u5F55\u524D\u7684\u9875\u9762\u5730\u5740\uFF0C\u8BB0\u5F55\u5230\u767B\u5F55\u9875\u9762\uFF0C\u4EE5\u5907\u5C06\u6765\u767B\u5F55\u6210\u529F\uFF0C\u56DE\u5230\u767B\u5F55\u524D\u7684\u9875\u9762</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;returnUrl&quot;</span><span class="token punctuation">,</span> returnUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;loginName&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> loginName<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> password<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;returnUrl&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> returnUrl<span class="token punctuation">,</span>
            <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response
    <span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">accredit</span><span class="token punctuation">(</span>loginName<span class="token punctuation">,</span> password<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u767B\u5F55\u6210\u529F\u91CD\u5B9A\u5411\u5230\u767B\u5F55\u524D\u9875\u9762</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:&quot;</span> <span class="token operator">+</span> returnUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-2-authservice" tabindex="-1"><a class="header-anchor" href="#_5-2-2-authservice" aria-hidden="true">#</a> 5.2.2. AuthService</h3><p>\u5728gmall-auth\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">JwtProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">GmallUmsClient</span> umsClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtProperties</span> jwtProperties<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accredit</span><span class="token punctuation">(</span><span class="token class-name">String</span> loginName<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1. \u5B8C\u6210\u8FDC\u7A0B\u8BF7\u6C42\uFF0C\u83B7\u53D6\u7528\u6237\u4FE1\u606F</span>
            <span class="token class-name">ResponseVo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> userEntityResponseVo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>umsClient<span class="token punctuation">.</span><span class="token function">queryUser</span><span class="token punctuation">(</span>loginName<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">UserEntity</span> userEntity <span class="token operator">=</span> userEntityResponseVo<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 2. \u5224\u65AD\u7528\u6237\u4FE1\u606F\u662F\u5426\u4E3A\u7A7A</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>userEntity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserException</span><span class="token punctuation">(</span><span class="token string">&quot;\u7528\u6237\u540D\u6216\u8005\u5BC6\u7801\u6709\u8BEF\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 3. \u628A\u7528\u6237id\u53CA\u7528\u6237\u540D\u653E\u5165\u8F7D\u8377</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> userEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> userEntity<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 4. \u4E3A\u4E86\u9632\u6B62jwt\u88AB\u522B\u4EBA\u76D7\u53D6\uFF0C\u8F7D\u8377\u4E2D\u52A0\u5165\u7528\u6237ip\u5730\u5740</span>
            <span class="token class-name">String</span> ipAddress <span class="token operator">=</span> <span class="token class-name">IpUtil</span><span class="token punctuation">.</span><span class="token function">getIpAddress</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;ip&quot;</span><span class="token punctuation">,</span> ipAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 5. \u5236\u4F5Cjwt\u7C7B\u578B\u7684token\u4FE1\u606F</span>
            <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtProperties<span class="token punctuation">.</span><span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtProperties<span class="token punctuation">.</span><span class="token function">getExpire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 6. \u628Ajwt\u653E\u5165cookie\u4E2D</span>
            <span class="token class-name">CookieUtil</span><span class="token punctuation">.</span><span class="token function">setCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtProperties<span class="token punctuation">.</span><span class="token function">getCookieName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtProperties<span class="token punctuation">.</span><span class="token function">getExpire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 7.\u7528\u6237\u6635\u79F0\u653E\u5165cookie\u4E2D\uFF0C\u65B9\u4FBF\u9875\u9762\u5C55\u793A\u6635\u79F0</span>
            <span class="token class-name">CookieUtil</span><span class="token punctuation">.</span><span class="token function">setCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtProperties<span class="token punctuation">.</span><span class="token function">getUnick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userEntity<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtProperties<span class="token punctuation">.</span><span class="token function">getExpire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserException</span><span class="token punctuation">(</span><span class="token string">&quot;\u7528\u6237\u540D\u6216\u8005\u5BC6\u7801\u51FA\u9519\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-3-gmallumsclient" tabindex="-1"><a class="header-anchor" href="#_5-2-3-gmallumsclient" aria-hidden="true">#</a> 5.2.3. GmallUmsClient</h3><p>\u63A5\u4E0B\u6765\u6211\u4EEC\u80AF\u5B9A\u8981\u5BF9\u7528\u6237\u5BC6\u7801\u8FDB\u884C\u6821\u9A8C\uFF0C\u6240\u4EE5\u6211\u4EEC\u9700\u8981\u901A\u8FC7FeignClient\u53BB\u8BBF\u95EE ums-service\u5FAE\u670D\u52A1\uFF1A</p><p>\u5728gmall-auth\u4E2D\u5F15\u5165gmall-ums-interface\u4F9D\u8D56\uFF1A</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>gmall-ums-interface<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7F16\u5199GmallUmsClient\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;ums-service&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GmallUmsClient</span> <span class="token keyword">extends</span> <span class="token class-name">GmallUmsApi</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-4-\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#_5-2-4-\u6D4B\u8BD5" aria-hidden="true">#</a> 5.2.4. \u6D4B\u8BD5</h3><p>\u6B64\u65F6\uFF0C\u5728\u767B\u5F55\u9875\u9762\u8F93\u5165\u6B63\u786E\u7684\u7528\u6237\u540D\u548C\u5BC6\u7801\u4FE1\u606F\uFF0C\u53EF\u4EE5\u767B\u5F55\u6210\u529F\u5E76\u8DF3\u8F6C\u5230\u9996\u9875\uFF1A</p><p>\u4F46\u662F\u67E5\u770Bcookie\u4FE1\u606F\u53D1\u73B0cookie\u4E3A\u7A7A\u3002</p><p>\u518D\u67E5\u770BHeaders\u4E2D\u7684Set-Cookie\u4FE1\u606F\u4E2D\u7684Domain\u53D1\u73B0\u662Fip\u5730\u5740\uFF0C\u4E0D\u662F\u5730\u5740\u680F\u7684\u57DF\u540D\u3002</p><p>\u7531\u4E8E\u6D4F\u89C8\u5668\u5730\u5740\u680F\u5730\u5740\uFF1Ahttp://www.gmall.com\uFF0C\u800C\u8BBE\u7F6Ecookie\u7684domain\u57DF\u662Fip\u5730\u5740\uFF0C\u76F8\u5F53\u4E8E\u5144\u5F1F\u57DF\u540D\u3002</p><p>\u5144\u5F1F\u4E4B\u95F4\u4E0D\u80FD\u64CD\u4F5Ccookie\u3002\u5BFC\u81F4cookie\u6CA1\u6709\u5199\u5165\u6210\u529F\uFF01</p><p>\u4E3A\u4EC0\u4E48\u662FSet-Cookie\u7684Domain\u662FIP\u5730\u5740\uFF1F</p><h2 id="_5-3-\u89E3\u51B3cookie\u5199\u5165\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_5-3-\u89E3\u51B3cookie\u5199\u5165\u95EE\u9898" aria-hidden="true">#</a> 5.3. \u89E3\u51B3cookie\u5199\u5165\u95EE\u9898</h2><p>\u89E3\u51B3cookie\u5199\u5165\u95EE\u9898\uFF0C\u8981\u6CE8\u610F\u4E24\u70B9\uFF1A</p><ol><li>cookie\u4E2D\u7684domain\u57DF\u5FC5\u987B\u548C\u5730\u5740\u680F\uFF08\u6216\u8005\u662F\u7236\u57DF\u540D\uFF09\u4E00\u81F4\u3002</li><li>cors\u8DE8\u57DF\u6EE1\u8DB3\u643A\u5E26cookie\u7684\u751F\u6548\u6761\u4EF6 <ul><li>\u670D\u52A1\u7684\u54CD\u5E94\u5934\u4E2D\u9700\u8981\u643A\u5E26Access-Control-Allow-Credentials\u5E76\u4E14\u4E3Atrue\u3002\uFF08\u7F51\u5173\u4E2D\u5DF2\u8BBE\u7F6E\uFF09</li><li>\u54CD\u5E94\u5934\u4E2D\u7684Access-Control-Allow-Origin\u4E00\u5B9A\u4E0D\u80FD\u4E3A*\uFF0C\u5FC5\u987B\u662F\u6307\u5B9A\u7684\u57DF\u540D\u3002\uFF08\u7F51\u5173\u4E2D\u5DF2\u8BBE\u7F6E\u5177\u4F53\u57DF\u540D\uFF09</li><li>\u6D4F\u89C8\u5668\u53D1\u8D77ajax\u9700\u8981\u6307\u5B9AwithCredentials \u4E3Atrue\u3002\uFF08\u524D\u7AEF\u5DE5\u7A0B\uFF1Agmall-admin\\src\\utils\\httpRequest.js\u6587\u4EF6\u5DF2\u7ECF\u8BBE\u7F6E\uFF09</li></ul></li></ol><h3 id="_5-3-1-\u8DDF\u8E2Acookieutils" tabindex="-1"><a class="header-anchor" href="#_5-3-1-\u8DDF\u8E2Acookieutils" aria-hidden="true">#</a> 5.3.1. \u8DDF\u8E2ACookieUtils</h3><p>\u5728gmall-auth\u4E2DAuthController\u7684authentication\u65B9\u6CD5\u6253\u4E00\u4E2A\u65AD\u70B9\uFF1A</p><p>F7\u8FDB\u5165setCookie\u65B9\u6CD5\uFF1A</p><p>\u53D1\u73B0\u5B83\u8C03\u7528\u4E86\u91CD\u8F7D\u7684setCookie\u65B9\u6CD5\uFF0C\u518D\u6B21F7\uFF1A</p><p>142\u884C\u53EF\u4EE5\u53D1\u73B0\u83B7\u53D6domian\u57DF\u5E76\u8BBE\u7F6Edomain\u57DF\u3002F7\u8FDB\u5165getDomainName\u65B9\u6CD5\uFF0C\u67E5\u770B\u6700\u7EC8\u83B7\u53D6\u7684domain\u662F\u4EC0\u4E48</p><p>160\u884C\u83B7\u53D6\u7684serverName\u662Fip\u5730\u5740\u3002\u4E5F\u5C31\u662F\u8BF4\u8FD9\u65F6\u5019\u53EA\u80FD\u83B7\u53D6ip\u5730\u5740\u4E86\uFF0C\u83B7\u53D6\u4E0D\u5230\u57DF\u540D\u4FE1\u606F\u3002</p><h3 id="_5-3-2-domain\u5730\u5740\u53D8\u5316\u539F\u56E0" tabindex="-1"><a class="header-anchor" href="#_5-3-2-domain\u5730\u5740\u53D8\u5316\u539F\u56E0" aria-hidden="true">#</a> 5.3.2. domain\u5730\u5740\u53D8\u5316\u539F\u56E0</h3><p>\u90A3\u4E48\u95EE\u9898\u6765\u4E86\uFF1A\u4E3A\u4EC0\u4E48\u6211\u4EEC\u8FD9\u91CC\u7684\u8BF7\u6C42serverName\u53D8\u6210\u4E86pi\u5730\u5740\u4E86\u5462\uFF1F</p><p>\u8FD9\u662F\u56E0\u4E3A\u5728\u5730\u5740\u680F\u8F93\u5165\u57DF\u540D\u65F6\uFF0C\u7ECF\u8FC7\u4E86\u4E24\u6B21\u8F6C\u53D1\uFF1A</p><ul><li>\u6211\u4EEC\u4F7F\u7528\u4E86nginx\u53CD\u5411\u4EE3\u7406\uFF0C\u5F53\u76D1\u542C\u5230sso.gmall.com\u7684\u65F6\u5019\uFF0C\u4F1A\u81EA\u52A8\u5C06\u8BF7\u6C42\u8F6C\u53D1\u81F3\u4EE3\u7406ip\u5730\u5740\uFF0C\u5373gateway\u670D\u52A1\u5668\u5730\u5740\u3002</li><li>\u800C\u540E\u8BF7\u6C42\u5230\u8FBE\u6211\u4EEC\u7684gateway\u7F51\u5173\uFF0Cgateway\u7F51\u5173\u5C31\u4F1A\u6839\u636E\u8DEF\u5F84\u5339\u914D\uFF0C\u6211\u4EEC\u7684\u8BF7\u6C42\u662F/api/auth\uFF0C\u6839\u636E\u89C4\u5219\u88AB\u8F6C\u53D1\u5230\u4E86auth\u670D\u52A1\u5730\u5740 \uFF0C\u5373\u6211\u4EEC\u7684\u6388\u6743\u4E2D\u5FC3\u3002</li></ul><p>\u6BCF\u6B21\u8F6C\u53D1\u90FD\u4F1A\u4E22\u5931\u57DF\u540D\u4FE1\u606F\u3002</p><h3 id="_5-3-3-nginx\u8F6C\u53D1\u65F6\u8981\u643A\u5E26\u57DF\u540D" tabindex="-1"><a class="header-anchor" href="#_5-3-3-nginx\u8F6C\u53D1\u65F6\u8981\u643A\u5E26\u57DF\u540D" aria-hidden="true">#</a> 5.3.3. nginx\u8F6C\u53D1\u65F6\u8981\u643A\u5E26\u57DF\u540D</h3><p>\u9996\u5148nginx\u8F6C\u53D1\u8BF7\u6C42\u7ED9\u7F51\u5173\u65F6\uFF0C\u8981\u643A\u5E26\u57DF\u540D\u4FE1\u606F\u3002\u9700\u8981\u5728nginx\u914D\u7F6E\u6587\u4EF6\u4E2D\u914D\u7F6E\u4EE3\u7406\u5934\u4FE1\u606F\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>proxy_set_header Host $host;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4FEE\u6539\u5B8C\u6210\u4E4B\u540E\uFF0C\u91CD\u65B0\u52A0\u8F7Dnginx\u914D\u7F6E\uFF1Anginx -s reload</p><p>\u8FD9\u6837\u5C31\u89E3\u51B3\u4E86nginx\u8F6C\u53D1\u65F6\u7684\u57DF\u540D\u95EE\u9898\u3002</p><h3 id="_5-3-4-\u7F51\u5173\u8F6C\u53D1\u65F6\u8981\u643A\u5E26\u57DF\u540D" tabindex="-1"><a class="header-anchor" href="#_5-3-4-\u7F51\u5173\u8F6C\u53D1\u65F6\u8981\u643A\u5E26\u57DF\u540D" aria-hidden="true">#</a> 5.3.4. \u7F51\u5173\u8F6C\u53D1\u65F6\u8981\u643A\u5E26\u57DF\u540D</h3><p>\u5728\u7F51\u5173\u8F6C\u53D1\u8BF7\u6C42\u7ED9\u670D\u52A1\u65F6\uFF0C\u8981\u643A\u5E26\u5730\u5740\u4FE1\u606F\uFF1A</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">spring.cloud.gateway.x-forwarded.host-enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4FEE\u6539\u4E4B\u540E\u518D\u6B21\u91CD\u542F\uFF0C\u6D4B\u8BD5</p><p>\u53D1\u73B0serverName\u4F9D\u7136\u65F6ip\u5730\u5740\u3002</p><p>\u8FD9\u662F\u56E0\u4E3A\u7F51\u5173\u8F6C\u53D1\u540E\uFF0C\u4F1A\u628A\u57DF\u540D\u901A\u8FC7X-Forwarded-Host\u5934\u4FE1\u606F\u8F6C\u53D1\u7ED9\u670D\u52A1\u3002\u6240\u4EE5\uFF0C\u9700\u8981\u4FEE\u6539160\u884C\u7684\u4EE3\u7801\uFF0C\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> serverName <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Forwarded-Host&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_5-3-5-\u518D\u6B21\u767B\u5F55\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#_5-3-5-\u518D\u6B21\u767B\u5F55\u6D4B\u8BD5" aria-hidden="true">#</a> 5.3.5. \u518D\u6B21\u767B\u5F55\u6D4B\u8BD5</h3><p>\u5B8C\u7F8E\uFF01\uFF01\uFF01\uFF01\uFF01</p><h2 id="_5-4-\u516C\u5171\u9875\u5934\u663E\u793A\u7528\u6237\u540D" tabindex="-1"><a class="header-anchor" href="#_5-4-\u516C\u5171\u9875\u5934\u663E\u793A\u7528\u6237\u540D" aria-hidden="true">#</a> 5.4. \u516C\u5171\u9875\u5934\u663E\u793A\u7528\u6237\u540D</h2><p>js\u5B9E\u73B0\uFF1A</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script th<span class="token operator">:</span>inline<span class="token operator">=</span><span class="token string">&quot;javascript&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">var</span> item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">&#39;#header&#39;</span><span class="token punctuation">,</span>

        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">keyword</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>searchParam<span class="token operator">?.</span>keyword<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">nickName</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token function">showInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// debugger</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>auth<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>nickName <span class="token operator">=</span> auth<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>

            <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>keyword <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keyword <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
                window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&#39;http://search.gmall.com/search?keyword=&#39;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keyword
            <span class="token punctuation">}</span><span class="token punctuation">,</span>

            <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&#39;http://sso.gmall.com/toLogin.html?returnUrl=&#39;</span><span class="token operator">+</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href
            <span class="token punctuation">}</span><span class="token punctuation">,</span>

            <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//debugger</span>
                auth<span class="token punctuation">.</span><span class="token function">removeToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                auth<span class="token punctuation">.</span><span class="token function">removeUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token comment">//\u8DF3\u8F6C\u9875\u9762</span>
                window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_6-\u7F51\u5173\u8FC7\u6EE4\u5668\u9A8C\u8BC1\u767B\u5F55\u72B6\u6001" tabindex="-1"><a class="header-anchor" href="#_6-\u7F51\u5173\u8FC7\u6EE4\u5668\u9A8C\u8BC1\u767B\u5F55\u72B6\u6001" aria-hidden="true">#</a> 6. \u7F51\u5173\u8FC7\u6EE4\u5668\u9A8C\u8BC1\u767B\u5F55\u72B6\u6001</h1><p>gateway\u7F51\u5173\u8FC7\u6EE4\u5668\u5305\u542B\u4E24\u79CD\uFF1A<strong>\u5168\u5C40\u8FC7\u6EE4\u5668</strong>\u548C<strong>\u5C40\u90E8\u8FC7\u6EE4\u5668</strong>\u3002</p><h2 id="_6-1-\u81EA\u5B9A\u4E49\u5168\u5C40\u8FC7\u6EE4\u5668" tabindex="-1"><a class="header-anchor" href="#_6-1-\u81EA\u5B9A\u4E49\u5168\u5C40\u8FC7\u6EE4\u5668" aria-hidden="true">#</a> 6.1. \u81EA\u5B9A\u4E49\u5168\u5C40\u8FC7\u6EE4\u5668</h2><p>\u81EA\u5B9A\u4E49\u5168\u5C40\u8FC7\u6EE4\u5668\u975E\u5E38\u7B80\u5355\uFF1A\u5B9E\u73B0GlobalFilter\u63A5\u53E3\u5373\u53EF\uFF0C\u65E0\u5DEE\u522B\u62E6\u622A\u6240\u6709\u5FAE\u670D\u52A1\u7684\u8BF7\u6C42</p><p>\u5185\u5BB9\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestGatewayFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\u65E0\u9700\u914D\u7F6E\uFF0C\u62E6\u622A\u6240\u6709\u7ECF\u8FC7\u7F51\u5173\u7684\u8BF7\u6C42\uFF01\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u653E\u884C</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u901A\u8FC7\u5B9E\u73B0Orderer\u63A5\u53E3\u7684getOrder\u65B9\u6CD5\u63A7\u5236\u5168\u5C40\u8FC7\u6EE4\u5668\u7684\u6267\u884C\u987A\u5E8F
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-2-\u81EA\u5B9A\u4E49\u5C40\u90E8\u8FC7\u6EE4\u5668" tabindex="-1"><a class="header-anchor" href="#_6-2-\u81EA\u5B9A\u4E49\u5C40\u90E8\u8FC7\u6EE4\u5668" aria-hidden="true">#</a> 6.2. \u81EA\u5B9A\u4E49\u5C40\u90E8\u8FC7\u6EE4\u5668</h2><p>\u81EA\u5B9A\u4E49\u5C40\u90E8\u8FC7\u6EE4\u5668\u7A0D\u5FAE\u9EBB\u70E6\u4E00\u70B9\uFF1A</p><ol><li>\u9700\u8981\u7F16\u5199\u8FC7\u6EE4\u5668\u5DE5\u5382\u7C7B\u7EE7\u627FAbstractGatewayFilterFactory\u62BD\u8C61\u7C7B</li><li>\u5728\u9700\u8981\u8FC7\u6EE4\u7684\u5FAE\u670D\u52A1\u8DEF\u7531\u4E2D\u914D\u7F6E\u8BE5\u8FC7\u6EE4\u5668</li></ol><p>\u53EF\u4EE5\u505A\u5230\u5B9A\u70B9\u62E6\u622A\u3002</p><h3 id="_6-2-1-\u8FC7\u6EE4\u5668\u5DE5\u5382authgatewayfilterfactory" tabindex="-1"><a class="header-anchor" href="#_6-2-1-\u8FC7\u6EE4\u5668\u5DE5\u5382authgatewayfilterfactory" aria-hidden="true">#</a> 6.2.1. \u8FC7\u6EE4\u5668\u5DE5\u5382AuthGatewayFilterFactory</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthGatewayFilterFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractGatewayFilterFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">GatewayFilter</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Object</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5B9E\u73B0GatewaFilter\u63A5\u53E3</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\u81EA\u5B9A\u4E49\u8FC7\u6EE4\u5668\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u653E\u884C</span>
                <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-2-\u5728\u914D\u7F6E\u6587\u4EF6\u4E2D\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#_6-2-2-\u5728\u914D\u7F6E\u6587\u4EF6\u4E2D\u4F7F\u7528" aria-hidden="true">#</a> 6.2.2. \u5728\u914D\u7F6E\u6587\u4EF6\u4E2D\u4F7F\u7528</h3><p>\u73B0\u5728\u62FFgmall-auth\u5DE5\u7A0B\u5C1D\u8BD5\u4F7F\u7528\u5427</p><p>\u8FC7\u6EE4\u5668\u540D\u79F0\u5C31\u662F<code>Auth</code>\uFF0C\u5373\u81EA\u5B9A\u4E49\u8FC7\u6EE4\u5668\u5DE5\u5382<code>\u7C7B\u540D\u79F0</code> \u53BB\u6389 <code>GatewayFilterFactory</code></p><h3 id="_6-2-3-\u8BFB\u53D6\u8FC7\u6EE4\u5668\u914D\u7F6E\u5185\u5BB9" tabindex="-1"><a class="header-anchor" href="#_6-2-3-\u8BFB\u53D6\u8FC7\u6EE4\u5668\u914D\u7F6E\u5185\u5BB9" aria-hidden="true">#</a> 6.2.3. \u8BFB\u53D6\u8FC7\u6EE4\u5668\u914D\u7F6E\u5185\u5BB9</h3><p>\u6B64\u65F6\uFF0C\u867D\u7136\u53EF\u4EE5\u4F7F\u7528\u8FD9\u4E2A\u62E6\u622A\u5668\u4E86\uFF0C\u4F46\u662F\u6211\u4EEC\u7684\u62E6\u622A\u5668\u8FD8\u662F\u5149\u79C3\u79C3\u7684\uFF0C\u4E0D\u80FD\u6307\u5B9A\u5185\u5BB9\u3002</p><p>\u5982\u679C\u50CF\u4E0B\u9762\u4E00\u6837\u6307\u5B9A<code>\u62E6\u622A\u8DEF\u5F84</code>\uFF0C\u5E76\u5728\u8FC7\u6EE4\u5668\u4E2D\u83B7\u53D6<code>\u62E6\u622A\u8DEF\u5F84</code>\uFF0C\u518D\u53BB\u5224\u65AD\u5F53\u524D\u8DEF\u5F84\u662F\u5426\u9700\u8981\u62E6\u622A</p><p>\u5047\u8BBE\u5982\u4E0B\uFF1A</p><p>\u6539\u9020AuthGatewayFilterFactory\u8FC7\u6EE4\u5668\u5DE5\u5382\u7C7B\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthGatewayFilterFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractGatewayFilterFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthGatewayFilterFactory<span class="token punctuation">.</span>PathConfig</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * \u4E00\u5B9A\u8981\u91CD\u5199\u6784\u9020\u65B9\u6CD5
     * \u544A\u8BC9\u7236\u7C7B\uFF0C\u8FD9\u91CC\u4F7F\u7528PathConfig\u5BF9\u8C61\u63A5\u6536\u914D\u7F6E\u5185\u5BB9
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthGatewayFilterFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">PathConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">GatewayFilter</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">PathConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5B9E\u73B0GatewaFilter\u63A5\u53E3</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\u81EA\u5B9A\u4E49\u8FC7\u6EE4\u5668\uFF01&quot;</span> <span class="token operator">+</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u653E\u884C</span>
                <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u6307\u5B9A\u5B57\u6BB5\u987A\u5E8F
     * \u53EF\u4EE5\u901A\u8FC7\u4E0D\u540C\u7684\u5B57\u6BB5\u5206\u522B\u8BFB\u53D6\uFF1A/toLogin.html,/login
     * \u5728\u8FD9\u91CC\u5E0C\u671B\u901A\u8FC7\u4E00\u4E2A\u96C6\u5408\u5B57\u6BB5\u8BFB\u53D6\u6240\u6709\u7684\u8DEF\u5F84
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">shortcutFieldOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;authPaths&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u6307\u5B9A\u8BFB\u53D6\u5B57\u6BB5\u7684\u7ED3\u679C\u96C6\u7C7B\u578B
     * \u9ED8\u8BA4\u901A\u8FC7map\u7684\u65B9\u5F0F\uFF0C\u628A\u914D\u7F6E\u8BFB\u53D6\u5230\u4E0D\u540C\u5B57\u6BB5
     *  \u4F8B\u5982\uFF1A/toLogin.html,/login
     *      \u7531\u4E8E\u53EA\u6307\u5B9A\u4E86\u4E00\u4E2A\u5B57\u6BB5\uFF0C\u53EA\u80FD\u63A5\u6536/toLogin.html
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ShortcutType</span> <span class="token function">shortcutType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ShortcutType</span><span class="token punctuation">.</span>GATHER_LIST<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u8BFB\u53D6\u914D\u7F6E\u7684\u5185\u90E8\u7C7B
     */</span>
    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PathConfig</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> authPaths<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6D4B\u8BD5\u6548\u679C\u5982\u4E0B\uFF1A\u5DF2\u7ECF\u53EF\u4EE5\u62FF\u5230\u914D\u7F6E\u5185\u5BB9</p><h2 id="_6-3-\u901A\u8FC7\u81EA\u5B9A\u4E49\u5C40\u90E8\u8FC7\u6EE4\u5668\u5B8C\u6210\u767B\u5F55\u9A8C\u8BC1" tabindex="-1"><a class="header-anchor" href="#_6-3-\u901A\u8FC7\u81EA\u5B9A\u4E49\u5C40\u90E8\u8FC7\u6EE4\u5668\u5B8C\u6210\u767B\u5F55\u9A8C\u8BC1" aria-hidden="true">#</a> 6.3. \u901A\u8FC7\u81EA\u5B9A\u4E49\u5C40\u90E8\u8FC7\u6EE4\u5668\u5B8C\u6210\u767B\u5F55\u9A8C\u8BC1</h2><p>\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u5728gmall-gateway\u7F16\u5199\u8FC7\u6EE4\u5668\uFF0C\u5BF9\u7528\u6237\u7684token\u8FDB\u884C\u6821\u9A8C\uFF0C\u5982\u679C\u53D1\u73B0\u672A\u767B\u5F55\uFF0C\u5219\u8FDB\u884C\u62E6\u622A\u3002</p><p>\u601D\u8DEF\uFF1A</p><ol><li>\u5224\u65AD\u8BF7\u6C42\u8DEF\u5F84\u5728\u4E0D\u5728\u62E6\u622A\u540D\u5355\u4E2D\uFF0C\u4E0D\u5728\u76F4\u63A5\u653E\u884C</li><li>\u83B7\u53D6\u8BF7\u6C42\u4E2D\u7684token\u3002\u540C\u6B65\u8BF7\u6C42\u4ECEcookie\u4E2D\u83B7\u53D6\uFF0C\u5F02\u6B65\u8BF7\u6C42\u4ECEheader\u4E2D\u83B7\u53D6\uFF08\u8D70cookie\u592A\u91CD\uFF0C\u4E00\u4E2A\u7F51\u7AD9\u5F80\u5F80\u6709\u5F88\u591Acookie\uFF0C\u5982\u679C\u901A\u8FC7\u643A\u5E26cookie\u7684\u65B9\u5F0F\u4F20\u9012token\uFF0C\u7F51\u7EDC\u4F20\u8F93\u538B\u529B\u592A\u5927\uFF09</li><li>\u5224\u65ADtoken\u662F\u5426\u4E3A\u7A7A\u3002\u4E3A\u7A7A\u76F4\u63A5\u62E6\u622A</li><li>\u5982\u679C\u4E0D\u4E3A\u7A7A\uFF0C\u89E3\u6790jwt\u83B7\u53D6\u767B\u5F55\u4FE1\u606F</li><li>\u5224\u65AD\u662F\u5426\u88AB\u76D7\u7528\u3002\u901A\u8FC7\u767B\u5F55\u4FE1\u606F\u4E2D\u7684ip\u548C\u5F53\u524D\u8BF7\u6C42\u7684ip\u6BD4\u8F83</li><li>\u4F20\u9012\u767B\u5F55\u4FE1\u606F\u7ED9\u540E\u7EED\u670D\u52A1\u3002\u540E\u7EED\u5404\u670D\u52A1\u5C31\u4E0D\u7528\u518D\u53BB\u89E3\u6790\u4E86</li><li>\u653E\u884C</li></ol><h3 id="_6-3-1-\u5F15\u5165jwt\u76F8\u5173\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#_6-3-1-\u5F15\u5165jwt\u76F8\u5173\u914D\u7F6E" aria-hidden="true">#</a> 6.3.1. \u5F15\u5165jwt\u76F8\u5173\u914D\u7F6E</h3><p>\u65E2\u7136\u662F\u767B\u5F55\u62E6\u622A\uFF0C\u4E00\u5B9A\u9700\u8981\u516C\u94A5\u89E3\u6790jwt\uFF0C\u6211\u4EEC\u5728<code>gmall-gateway</code>\u4E2D\u914D\u7F6E\u3002</p><p>\u9996\u5148\u5728pom.xml\u4E2D\uFF0C\u5F15\u5165\u6240\u9700\u8981\u7684\u4F9D\u8D56\uFF1A</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>gmall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u7F16\u5199application.yml\u5C5E\u6027\u6587\u4EF6\uFF0C\u6DFB\u52A0\u5982\u4E0B\u5185\u5BB9\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">auth</span><span class="token punctuation">:</span>
  <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
    <span class="token key atrule">pubKeyPath</span><span class="token punctuation">:</span> D<span class="token punctuation">:</span>\\\\project\\\\rsa\\\\rsa.pub <span class="token comment"># \u516C\u94A5\u5730\u5740</span>
    <span class="token key atrule">cookieName</span><span class="token punctuation">:</span> GMALL<span class="token punctuation">-</span>TOKEN
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7F16\u5199\u5C5E\u6027\u7C7B\uFF0C\u8BFB\u53D6\u516C\u94A5\uFF1A</p><p>jwtProperties\u5185\u5BB9\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;auth.jwt&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtProperties</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> pubKeyPath<span class="token punctuation">;</span><span class="token comment">// \u516C\u94A5</span>

    <span class="token keyword">private</span> <span class="token class-name">PublicKey</span> publicKey<span class="token punctuation">;</span> <span class="token comment">// \u516C\u94A5</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> cookieName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u83B7\u53D6\u516C\u94A5\u548C\u79C1\u94A5</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>publicKey <span class="token operator">=</span> <span class="token class-name">RsaUtils</span><span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span>pubKeyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u521D\u59CB\u5316\u516C\u94A5\u5931\u8D25\uFF01&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-2-\u7F16\u5199\u4EE3\u7801\u5B9E\u73B0\u767B\u5F55\u62E6\u622A" tabindex="-1"><a class="header-anchor" href="#_6-3-2-\u7F16\u5199\u4EE3\u7801\u5B9E\u73B0\u767B\u5F55\u62E6\u622A" aria-hidden="true">#</a> 6.3.2. \u7F16\u5199\u4EE3\u7801\u5B9E\u73B0\u767B\u5F55\u62E6\u622A</h3><p>\u6539\u9020AuthGatewayFilterFactory</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">JwtProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthGatewayFilterFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractGatewayFilterFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthGatewayFilterFactory<span class="token punctuation">.</span>PathConfig</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtProperties</span> properties<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u4E00\u5B9A\u8981\u91CD\u5199\u6784\u9020\u65B9\u6CD5
     * \u544A\u8BC9\u7236\u7C7B\uFF0C\u8FD9\u91CC\u4F7F\u7528PathConfig\u5BF9\u8C61\u63A5\u6536\u914D\u7F6E\u5185\u5BB9
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthGatewayFilterFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">PathConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">GatewayFilter</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">PathConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5B9E\u73B0GatewaFilter\u63A5\u53E3</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">// \u83B7\u53D6request\u548Cresponse\uFF0C\u6CE8\u610F\uFF1A\u4E0D\u662FHttpServletRequest\u53CAHttpServletResponse</span>
                <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u83B7\u53D6\u5F53\u524D\u8BF7\u6C42\u7684path\u8DEF\u5F84</span>
                <span class="token class-name">String</span> path <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 1.\u5224\u65AD\u8BF7\u6C42\u8DEF\u5F84\u5728\u4E0D\u5728\u62E6\u622A\u540D\u5355\u4E2D\uFF0C\u4E0D\u5728\u76F4\u63A5\u653E\u884C</span>
                <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> authPath <span class="token operator">:</span> config<span class="token punctuation">.</span><span class="token function">getAuthPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// \u5982\u679C\u767D\u540D\u5355\u4E2D\u6709\u4E00\u4E2A\u5305\u542B\u5F53\u524D\u8DEF\u5F84</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>authPath<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// \u4E0D\u5728\u62E6\u622A\u540D\u5355\u4E2D\uFF0C\u653E\u884C</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 2.\u83B7\u53D6\u8BF7\u6C42\u4E2D\u7684token</span>
                <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
                <span class="token comment">// \u5F02\u6B65\u8BF7\u6C42\uFF0C\u901A\u8FC7\u5934\u4FE1\u606F\u83B7\u53D6token</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tokenList <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>tokenList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    token <span class="token operator">=</span> tokenList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// \u540C\u6B65\u8BF7\u6C42\u901A\u8FC7cookie</span>
                    <span class="token class-name">MultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HttpCookie</span><span class="token punctuation">&gt;</span></span> cookies <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>cookies<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>cookies<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getCookieName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// \u62E6\u622A</span>
                        <span class="token comment">// \u91CD\u5B9A\u5411\u5230\u767B\u5F55</span>
                        <span class="token comment">// 303\u72B6\u6001\u7801\u8868\u793A\u7531\u4E8E\u8BF7\u6C42\u5BF9\u5E94\u7684\u8D44\u6E90\u5B58\u5728\u7740\u53E6\u4E00\u4E2AURI\uFF0C\u5E94\u4F7F\u7528\u91CD\u5B9A\u5411\u83B7\u53D6\u8BF7\u6C42\u7684\u8D44\u6E90</span>
                        response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>SEE_OTHER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span>LOCATION<span class="token punctuation">,</span> <span class="token string">&quot;http://sso.gmall.com/toLogin.html?returnUrl=&quot;</span><span class="token operator">+</span>request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// \u8BBE\u7F6E\u54CD\u5E94\u72B6\u6001\u7801\u4E3A\u672A\u8BA4\u8BC1</span>
<span class="token comment">//                        response.setStatusCode(HttpStatus.UNAUTHORIZED);</span>
                        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// \u83B7\u53D6cookie\u4E2D\u7684jwt</span>
                    <span class="token class-name">HttpCookie</span> cookie <span class="token operator">=</span> cookies<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getCookieName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    token <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 3.\u5224\u65ADtoken\u662F\u5426\u4E3A\u7A7A</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// \u53BB\u767B\u5F55</span>
                    response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>SEE_OTHER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span>LOCATION<span class="token punctuation">,</span> <span class="token string">&quot;http://sso.gmall.com/toLogin.html?returnUrl=&quot;</span><span class="token operator">+</span>request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 4.\u89E3\u6790jwt\uFF0C\u83B7\u53D6\u767B\u5F55\u4FE1\u606F</span>
                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token function">getInfoFromToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> properties<span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 5.\u5224\u65ADtoken\u662F\u5426\u88AB\u76D7\u7528</span>
                    <span class="token class-name">String</span> ip <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;ip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// \u5F53\u524D\u8BF7\u6C42\u7684ip</span>
                    <span class="token class-name">String</span> curIp <span class="token operator">=</span> <span class="token class-name">IpUtil</span><span class="token punctuation">.</span><span class="token function">getIpAddressAtGateway</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> curIp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token comment">// \u53BB\u767B\u9646</span>
                        response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>SEE_OTHER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span>LOCATION<span class="token punctuation">,</span> <span class="token string">&quot;http://sso.gmall.com/toLogin.html?returnUrl=&quot;</span><span class="token operator">+</span>request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// 6.\u4F20\u9012\u767B\u5F55\u4FE1\u606F\u7ED9\u540E\u7EED\u670D\u52A1</span>
                    <span class="token class-name">String</span> userId <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// \u5C06userId\u8F6C\u53D8\u6210request\u5BF9\u8C61\u3002mutate\uFF1A\u8F6C\u53D8\u7684\u610F\u601D</span>
                    request<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// \u653E\u884C</span>
                    <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 7.\u5F02\u5E38\uFF0C\u53BB\u767B\u5F55</span>
                    response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>SEE_OTHER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span>LOCATION<span class="token punctuation">,</span> <span class="token string">&quot;http://sso.gmall.com/toLogin.html?returnUrl=&quot;</span><span class="token operator">+</span>request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u6307\u5B9A\u5B57\u6BB5\u987A\u5E8F
     * \u53EF\u4EE5\u901A\u8FC7\u4E0D\u540C\u7684\u5B57\u6BB5\u5206\u522B\u8BFB\u53D6\uFF1A/toLogin.html,/login
     * \u5728\u8FD9\u91CC\u5E0C\u671B\u901A\u8FC7\u4E00\u4E2A\u96C6\u5408\u5B57\u6BB5\u8BFB\u53D6\u6240\u6709\u7684\u8DEF\u5F84
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">shortcutFieldOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;authPaths&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u6307\u5B9A\u8BFB\u53D6\u5B57\u6BB5\u7684\u7ED3\u679C\u96C6\u7C7B\u578B
     * \u9ED8\u8BA4\u901A\u8FC7map\u7684\u65B9\u5F0F\uFF0C\u628A\u914D\u7F6E\u8BFB\u53D6\u5230\u4E0D\u540C\u5B57\u6BB5
     *  \u4F8B\u5982\uFF1A/toLogin.html,/login
     *      \u7531\u4E8E\u53EA\u6307\u5B9A\u4E86\u4E00\u4E2A\u5B57\u6BB5\uFF0C\u53EA\u80FD\u63A5\u6536/toLogin.html
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ShortcutType</span> <span class="token function">shortcutType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ShortcutType</span><span class="token punctuation">.</span>GATHER_LIST<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u8BFB\u53D6\u914D\u7F6E\u7684\u5185\u90E8\u7C7B
     */</span>
    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PathConfig</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> authPaths<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-3-\u914D\u7F6E\u8FC7\u6EE4\u5668\u5E76\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#_6-3-3-\u914D\u7F6E\u8FC7\u6EE4\u5668\u5E76\u6D4B\u8BD5" aria-hidden="true">#</a> 6.3.3. \u914D\u7F6E\u8FC7\u6EE4\u5668\u5E76\u6D4B\u8BD5</h3><p>\u5728\u7F51\u5173\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684\u914D\u7F6E\u5982\u4E0B\uFF1A</p><p>\u5728\u6D4F\u89C8\u5668\u4E0A\u8BBF\u95EE\uFF1Ahttp://sso.gmall.com/xxx</p><p>\u91CD\u5B9A\u5411\u5230\u4E86\u767B\u5F55\u9875\u9762</p><p>\u8F93\u5165\u7528\u6237\u540D\u53CA\u5BC6\u7801\u767B\u5F55\u540E</p><p>\u51FA\u73B0404\uFF0C\u8BF4\u660E\u767B\u5F55\u60C5\u51B5\u4E0B\u7F51\u5173\u653E\u884C\u4E86\uFF0C\u7531\u4E8E\u6CA1\u6709\u8BE5\u8DEF\u5F84\u5BF9\u5E94\u7684\u63A5\u53E3\uFF0C\u6240\u6709\u51FA\u73B0\u4E86404</p><h2 id="_6-4-\u5E38\u89C1\u5F02\u5E38\u89E3\u51B3" tabindex="-1"><a class="header-anchor" href="#_6-4-\u5E38\u89C1\u5F02\u5E38\u89E3\u51B3" aria-hidden="true">#</a> 6.4. \u5E38\u89C1\u5F02\u5E38\u89E3\u51B3</h2><p>\u5982\u679C\u7F51\u5173\u62A5\u5982\u4E0B\u9519\u8BEF\uFF1A</p><p>\u539F\u56E0\uFF1AspringCloud-gateway\u5185\u90E8\u96C6\u6210\u7684\u662Fwebflux\u800C\u4E0D\u662Fservlet\uFF0C\u6240\u4EE5\u9700\u8981\u6392\u9664servlet\u76F8\u5173\u7684\u4F9D\u8D56\u3002</p><p>tomcat\u662Fservlet\u5BB9\u5668</p>`,149);function h(y,w){const t=l("ExternalLinkIcon");return e(),o("div",null,[u,n("ul",null,[k,n("li",null,[r,n("ul",null,[n("li",null,[d,n("a",v,[m,c(t)]),b])])])]),g])}var q=p(i,[["render",h],["__file","single-sign-on.html.vue"]]);export{q as default};
