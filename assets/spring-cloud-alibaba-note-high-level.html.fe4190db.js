import{_ as n}from"./plugin-vue_export-helper.21dcd24c.js";import{o as s,c as a,a as t}from"./app.c37b87a5.js";var p="/assets/true-image-20210604131952296.11fdaa89.png",e="/assets/true-image-20210604132012980.e5e1feb9.png",o="/assets/true-image-20210912091935588.036b5631.png",c="/assets/true-image-20210912115033523.42e020a1.png",l="/assets/true-image-20210912115114599.63405b2c.png",i="/assets/true-image-20210912125255950.d3f61c72.png",u="/assets/true-image-20210912125306914.e9179f4f.png",k="/assets/true-image-20210912155154018.755b7d22.png",r="/assets/true-image-20210912155207647.f500933c.png",d="/assets/true-image-20210912164205853.1c2fa8df.png",m="/assets/true-image-20210926173348217.7b0065c0.png",v="/assets/true-\u8BA2\u5355\u4E2D\u5FC3.6c461187.png",b="/assets/true-image-20211004160657576.8da80a1e.png",g="/assets/true-image-20211004175207905.4d5c57c6.png",f="/assets/true-image-20211004180806491.921bde67.png",h="/assets/true-image-20211004181324416.edb9a4a1.png",y="/assets/true-image-20211004192550633.82f8b758.png",q="/assets/true-image-20211004194440103.58dbb1e9.png",S="/assets/true-image-20211004212537610.9a77105a.png",w="/assets/true-image-20211004212605590.e0fc2498.png",I="/assets/true-image-20211004214057804.b29c18d1.png",_="/assets/true-image-20211116210606144.5bb28053.png",x="/assets/true-image-20211116215716456.d4d6addc.png",T="/assets/true-image-20211116215727891.c5a80972.png",E="/assets/true-image-20211116220459730.77206648.png",C="/assets/true-image-20211118125418053.07a1f614.png",j="/assets/true-image-20211118130052716.d60fcf8d.png",V="/assets/true-image-20211118130031288.4a446989.png",O="/assets/true-image-20211118130142204.b77f085c.png",R="/assets/true-image-20211118141952959.52f6d9db.png",A="/assets/true-image-20211118141137454.85399d00.png",L="/assets/true-image-20211118141454410.2bb1a63c.png";const P={},M=t('<h2 id="es\u96C6\u7FA4" tabindex="-1"><a class="header-anchor" href="#es\u96C6\u7FA4" aria-hidden="true">#</a> ES\u96C6\u7FA4</h2><p><img src="'+p+'" alt="image-20210604131952296"></p><p><img src="'+e+`" alt="image-20210604132012980"></p><h1 id="\u4E03\u3001\u5546\u54C1\u4E0A\u67B6" tabindex="-1"><a class="header-anchor" href="#\u4E03\u3001\u5546\u54C1\u4E0A\u67B6" aria-hidden="true">#</a> \u4E03\u3001\u5546\u54C1\u4E0A\u67B6</h1><p><strong>\u5546\u54C1\u4E0A\u67B6 \uFF1A\u628A\u6570\u636E\u4FDD\u5B58\u5230es</strong> \uFF1Aspu</p><h2 id="\u6784\u9020sku\u68C0\u7D22\u5C5E\u6027" tabindex="-1"><a class="header-anchor" href="#\u6784\u9020sku\u68C0\u7D22\u5C5E\u6027" aria-hidden="true">#</a> -- \u6784\u9020sku\u68C0\u7D22\u5C5E\u6027</h2><h3 id="_1\u3001\u4E0A\u67B6-product-spuinfo-list-spuid-up" tabindex="-1"><a class="header-anchor" href="#_1\u3001\u4E0A\u67B6-product-spuinfo-list-spuid-up" aria-hidden="true">#</a> 1\u3001\u4E0A\u67B6 product/spuinfo/list/{spuId}/up</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>spuInfoService<span class="token punctuation">.</span><span class="token function">up</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
skuInfoService<span class="token punctuation">.</span><span class="token function">getSkusBySpuId</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">-&gt;</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> skuInfoEntityList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;spu_id&quot;</span><span class="token punctuation">,</span> spuId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//\u7EC4\u88C5\u9700\u8981\u7684\u6570\u636E</span>
skus<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>sku <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">SkuEsModel</span> esModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>sku<span class="token punctuation">,</span> esModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TODO 1\u3001\u53D1\u9001\u8FDC\u7A0B\u8C03\u7528\uFF0C\u5E93\u5B58\u7CFB\u7EDF\u67E5\u8BE2\u662F\u5426\u6709\u5E93\u5B58</span>
    <span class="token comment">//TODO 2\u3001\u70ED\u5EA6\u8BC4\u5206\u3002e,</span>
    <span class="token function">setHotScore</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TODO 3 \u67E5\u8BE2\u54C1\u724C\u548C\u5206\u7C7B\u7684\u540D\u5B57\u4FE1\u606F</span>
    brandService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>esModel<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//setSkuPrice/setSkuImg/setHotScore(0L)/setBrandName(brand.getName());</span>
    <span class="token comment">//esModel.setBrandImg(brand.getLogo());</span>
    categoryService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>esModel<span class="token punctuation">.</span><span class="token function">getCatalogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//setCatalogName(categoryServiceById.getName());</span>
    <span class="token function">setAttrs</span><span class="token punctuation">(</span>attrsList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">///////////////////</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> searchAttrIds <span class="token operator">=</span> attrService<span class="token punctuation">.</span><span class="token function">selectSearchAttrIds</span><span class="token punctuation">(</span>attrIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">--</span><span class="token operator">&gt;</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectSearchAttrIds</span><span class="token punctuation">(</span>attrIds<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectSearchAttrIds</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;attrIds&quot;</span><span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> attrIds<span class="token punctuation">)</span><span class="token punctuation">;</span> 
             <span class="token operator">--</span><span class="token operator">&gt;</span> SELECT attr_id FROM pms_attr WHERE attr_id IN <span class="token operator">&lt;</span>foreach collection<span class="token operator">=</span><span class="token string">&quot;attrIds&quot;</span> item<span class="token operator">=</span><span class="token string">&quot;id&quot;</span> separator<span class="token operator">=</span><span class="token string">&quot;,&quot;</span> <span class="token keyword">open</span><span class="token operator">=</span><span class="token string">&quot;(&quot;</span> close<span class="token operator">=</span><span class="token string">&quot;)&quot;</span><span class="token operator">&gt;</span> #<span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>foreach<span class="token operator">&gt;</span> <span class="token class-name">AND</span> search_type <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">//////////////////                  </span>
                  
<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> idSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>searchAttrIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attrs</span><span class="token punctuation">&gt;</span></span> attrsList <span class="token operator">=</span> baseAttrs<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> idSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getAttrId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attrs</span> attrs1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attrs1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> attrs1<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u53D1\u9001\u8FDC\u7A0B\u8C03\u7528-\u5E93\u5B58\u7CFB\u7EDF\u67E5\u8BE2\u662F\u5426\u6709\u5E93\u5B58" tabindex="-1"><a class="header-anchor" href="#\u53D1\u9001\u8FDC\u7A0B\u8C03\u7528-\u5E93\u5B58\u7CFB\u7EDF\u67E5\u8BE2\u662F\u5426\u6709\u5E93\u5B58" aria-hidden="true">#</a> -- \u53D1\u9001\u8FDC\u7A0B\u8C03\u7528\uFF0C\u5E93\u5B58\u7CFB\u7EDF\u67E5\u8BE2\u662F\u5426\u6709\u5E93\u5B58</h2><p>/ware/waresku/hasstock</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token function">getSkusHasStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wareSkuService<span class="token punctuation">.</span><span class="token function">getSkusHasStock</span><span class="token punctuation">(</span>skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//////////////getSkusHasStock:</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> skuIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>skuId <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">SkuHasStockVo</span> vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuHasStockVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u67E5\u8BE2\u5F53\u524Dsku\u7684\u603B\u5E93\u5B58\u91CF</span>
        <span class="token comment">//SELECT SUM(stock-stock_ locked) FROM\u3001 wms_ _ware_ sku^ WHERE sku_ id=1</span>
            <span class="token keyword">long</span> count <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">getSkuStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            vo<span class="token punctuation">.</span><span class="token function">setSkuld</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            vo<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> vo<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token operator">--</span><span class="token operator">&gt;</span> getSkuStock<span class="token operator">:</span>
    	<span class="token class-name">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>stock<span class="token operator">-</span>stock_ locked<span class="token punctuation">)</span> FROM wms_ _ware_ sku <span class="token class-name">WHERE</span> sku_id<span class="token operator">=</span>#<span class="token punctuation">{</span>skuId<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFA WareFeignService</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ware/waresku/hasstock&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkusHasStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> stockMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> skusHasStock <span class="token operator">=</span> wareFeignService<span class="token punctuation">.</span><span class="token function">getSkusHasStock</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stockMap <span class="token operator">=</span> skusHasStock<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">SkuHasStockVo</span><span class="token operator">::</span><span class="token function">getSkuld</span><span class="token punctuation">,</span> item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u670D\u52A1\u67E5\u8BE2\u5F02\u5E38:\u539F\u56E0{}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> finalStockMap <span class="token operator">=</span> stockMap<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>finalStockMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                esModel<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                esModel<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span>finalStockMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u5C06\u6570\u636E\u53D1\u9001\u7ED9es\u8FDB\u884C\u4FDD\u5B58-yumall-search" tabindex="-1"><a class="header-anchor" href="#\u5C06\u6570\u636E\u53D1\u9001\u7ED9es\u8FDB\u884C\u4FDD\u5B58-yumall-search" aria-hidden="true">#</a> -- \u5C06\u6570\u636E\u53D1\u9001\u7ED9es\u8FDB\u884C\u4FDD\u5B58;yumall-search</h2><p>/ElasticSavaController::productStatusUp</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u4FDD\u5B58\u5230es\uFF0C</span>
<span class="token comment">//1\u3001\u7ED9es\u4E2D\u5EFA\u7ACB\u7D22\u5F15\u3002product,\u5EFA\u7ACB\u597D\u6620\u5C04\u5173\u7CFB\u3002</span>
<span class="token comment">//2\u3001\u7ED9es\u4E2D\u4FDD\u5B58\u8FD9\u4E9B\u6570\u636E</span>
productStatusUp<span class="token operator">-&gt;</span><span class="token class-name">BulkRequest</span><span class="token operator">-&gt;</span><span class="token keyword">for</span><span class="token operator">-&gt;</span><span class="token class-name">IndexRequest</span><span class="token operator">-&gt;</span>restHighLevelClient<span class="token punctuation">.</span>bulk
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+o+`" alt="image-20210912091935588"></p><p>//BizCodeEnume :: PRODUCT_UP_EXCEPTION(11000, &quot;\u5546\u54C1\u4E0A\u67B6\u5F02\u5E38&quot;);</p><p>\u5546\u54C1\u670D\u52A1\u8C03\u7528Search</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>yumall<span class="token operator">-</span>product\uFF1Afeign\uFF1A<span class="token class-name">SearchFeignService</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;yumall-search&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SearchFeignService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/search/save/product&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">R</span> <span class="token function">productStatusUp</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>//SpuInfoServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//TODO 5\u3001\u5C06\u6570\u636E\u53D1\u9001\u7ED9es\u8FDB\u884C\u4FDD\u5B58;yumall-search</span>
<span class="token class-name">R</span> r <span class="token operator">=</span> searchFeignService<span class="token punctuation">.</span><span class="token function">productStatusUp</span><span class="token punctuation">(</span>upProducts<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6210\u529F\uFF1A\u4FEE\u6539spu\u72B6\u6001</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u679A\u4E3E\u7C7B\uFF1Ayumall.common.constant.ProductConstant.StatusEnum</span>
<span class="token function">NEW_SPU</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;\u65B0\u5EFA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">SPU_UP</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;\u4E0A\u67B6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">SPU_DOWN</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;\u4E0B\u67B6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">////////////////</span>
baseMapper<span class="token punctuation">.</span><span class="token function">updateStatusBySPUId</span><span class="token punctuation">(</span>spuId<span class="token punctuation">,</span> <span class="token class-name">ProductConstant<span class="token punctuation">.</span>StatusEnum</span><span class="token punctuation">.</span>SPU_UP<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UPDATE pms_spu_info <span class="token class-name">SET</span> publish_status<span class="token operator">=</span>#<span class="token punctuation">{</span>code<span class="token punctuation">}</span><span class="token punctuation">,</span> update_time<span class="token operator">=</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name">WHERE</span> id<span class="token operator">=</span>#<span class="token punctuation">{</span>spuId<span class="token punctuation">}</span>        
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5931\u8D25\uFF1A\u91CD\u590D\u64CD\u4F5C\uFF1F</p><h2 id="\u4F18\u5316\u5E93\u5B58" tabindex="-1"><a class="header-anchor" href="#\u4F18\u5316\u5E93\u5B58" aria-hidden="true">#</a> -- \u4F18\u5316\u5E93\u5B58\uFF1A</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">R</span><span class="token operator">::</span><span class="token operator">::</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> typeReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> data <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u9ED8\u8BA4\u662Fmap</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">T</span> t <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token punctuation">)</span> typeReference<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> t<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">Object</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token comment">//\u67E5\u8BE2sku\u662F\u5426\u6709\u5E93\u5B58</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hasstock&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getSkusHasStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span></span> skuHasStockVos <span class="token operator">=</span> wareSkuService<span class="token punctuation">.</span><span class="token function">getSkusHasStock</span><span class="token punctuation">(</span>skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>skuHasStockVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>    
 <span class="token class-name">R</span> skusHasStock <span class="token operator">=</span> wareFeignService<span class="token punctuation">.</span><span class="token function">getSkusHasStock</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> listTypeReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            stockMap <span class="token operator">=</span> skusHasStock<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span>listTypeReference<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">SkuHasStockVo</span><span class="token operator">::</span><span class="token function">getSkuld</span><span class="token punctuation">,</span> item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u516B\u3001\u9996\u9875-nginx" tabindex="-1"><a class="header-anchor" href="#\u516B\u3001\u9996\u9875-nginx" aria-hidden="true">#</a> \u516B\u3001\u9996\u9875&amp;nginx</h1><h2 id="\u5546\u54C1-product" tabindex="-1"><a class="header-anchor" href="#\u5546\u54C1-product" aria-hidden="true">#</a> -- \u5546\u54C1\uFF1Aproduct</h2><h3 id="\u5BFC\u5165thymeleaf" tabindex="-1"><a class="header-anchor" href="#\u5BFC\u5165thymeleaf" aria-hidden="true">#</a> --- \u5BFC\u5165thymeleaf</h3><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u5BFC\u5165\u9996\u9875" tabindex="-1"><a class="header-anchor" href="#\u5BFC\u5165\u9996\u9875" aria-hidden="true">#</a> --- \u5BFC\u5165\u9996\u9875</h3><p><img src="`+c+`" alt="image-20210912115033523"></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>spring.thymeleaf.cache=false
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+l+`" alt="image-20210912115114599"></p><p>\u521B\u5EFA\uFF1Aapp\u3001web\u6587\u4EF6\u5939</p><p>\u70ED\u63D2\u4EF6\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;
    &lt;optional&gt;true&lt;/optional&gt;
&lt;/dependency&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u67E5\u51FA\u6240\u6709\u76841\u7EA7\u5206\u7C7B" tabindex="-1"><a class="header-anchor" href="#\u67E5\u51FA\u6240\u6709\u76841\u7EA7\u5206\u7C7B" aria-hidden="true">#</a> --- \u67E5\u51FA\u6240\u6709\u76841\u7EA7\u5206\u7C7B</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>getLevel1Categorys:-&gt; List&lt;CategoryEntity&gt; categoryEntities = baseMapper.selectList(new QueryWrapper&lt;CategoryEntity&gt;().eq(&quot;parent_ .cid&quot;, 0));
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>index\u5F15\u5165: &lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;</p><p><img src="`+i+'" alt="image-20210912125255950"></p><p><img src="'+u+`" alt="image-20210912125306914"></p><h3 id="\u663E\u793A\u4E8C\u7EA7-\u4E09\u7EA7\u5206\u7C7B" tabindex="-1"><a class="header-anchor" href="#\u663E\u793A\u4E8C\u7EA7-\u4E09\u7EA7\u5206\u7C7B" aria-hidden="true">#</a> --- \u663E\u793A\u4E8C\u7EA7&amp;\u4E09\u7EA7\u5206\u7C7B</h3><p>json\u6570\u636E</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
 <span class="token property">&quot;21&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;catalog1Id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;21&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;catalog3List&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;catalog2Id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;143&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1259&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\u9762\u5305\u8F66\uFF08\u4E8C\u624B\uFF09&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;143&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\u4E8C\u624B\u8F66&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>        
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Catalog2Vo</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * \u4E00\u7EA7\u7236\u5206\u7C7BID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> catalog1Id<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * \u4E09\u7EA7\u5B50\u5206\u7C7B
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catalog3Vo</span><span class="token punctuation">&gt;</span></span> catalog3List<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u4E09\u7EA7\u5B50\u5206\u7C7B
     */</span>
    <span class="token annotation punctuation">@NoArgsConstructor</span>
    <span class="token annotation punctuation">@AllArgsConstructor</span>
    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Catalog3Vo</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * \u4E8C\u7EA7\u7236\u5206\u7C7Bid
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> catalog2Id<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>@RequestMapping(&quot;index/catalog.json&quot;)
getCataLogJson\uFF1A\uFF1AcategoryService.getCataLogJson();
1\u3001\u67E5\u51FA\u6240\u67091\u7EA7\u5206\u7C7B\uFF1A\uFF1A2\u3001\u5C01\u88C5\u6570\u636E\uFF1A\uFF1A
	2.1 \u6BCF\u4E00\u4E2A\u7684\u4E00\u7EA7\u5206\u7C7B\uFF0C\u67E5\u5230\u8FD9\u4E2A\u4E00\u7EA7\u5206\u7C7B\u7684\u4E8C\u7EA7\u5206\u7C7B
	2.2 \u5C01\u88C5\u4E0A\u9762\u7684\u7ED3\u679C
	2.2.1 \u67E5\u5230\u8FD9\u4E2A\u4E8C\u7EA7\u5206\u7C7B\u7684\u4E09\u7EA7\u5206\u7C7B
return 2\u3001\uFF1B	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+k+'" alt="image-20210912155154018"></p><p><img src="'+r+`" alt="image-20210912155207647"></p><h2 id="nginx" tabindex="-1"><a class="header-anchor" href="#nginx" aria-hidden="true">#</a> -- nginx</h2><h3 id="\u9759\u6001\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#\u9759\u6001\u914D\u7F6E" aria-hidden="true">#</a> --- \u9759\u6001\u914D\u7F6E</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name yumall.com<span class="token punctuation">;</span>
    charset utf-8<span class="token punctuation">;</span>
 	root html<span class="token punctuation">;</span>
  	index index.html index.htm<span class="token punctuation">;</span>
    access_log  logs/yumall.com.log  main<span class="token punctuation">;</span>

   	location / <span class="token punctuation">{</span>
		proxy_pass http://192.168.101.6:8100<span class="token punctuation">;</span>
  	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u5206\u5E03\u5F0F\u7F51\u5173\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#\u5206\u5E03\u5F0F\u7F51\u5173\u914D\u7F6E" aria-hidden="true">#</a> --- \u5206\u5E03\u5F0F\u7F51\u5173\u914D\u7F6E</h3><p><strong>nginx\u4EE3\u7406\u5230\u7F51\u517350000,\u7F51\u5173\u4EE3\u7406\u5230\u5176\u4ED6\u670D\u52A1</strong></p><p>nginx.conf</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>##\u8D1F\u8F7D\u5747\u8861
upstream yumall{
  server 192.168.101.6:50000; #\u7F51\u5173port\uFF1A50000
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>yumall.conf</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>location / {
	proxy_pass http://yumall;
    proxy_set_header Host $host;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7F51\u5173\u670D\u52A1\u914D\u7F6E</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>##########################uri: lb\uFF1A\u8D1F\u8F7D\u5747\u8861\uFF0C\u5230\u54EA\u4E2A\u670D\u52A1#####################
        - id: product_route
          uri: lb://yumall-product
          predicates:
            - Path=/api/product/**
          filters:
            - RewritePath=/api/(?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>segment</span><span class="token punctuation">&gt;</span></span>.*),/$\\{segment}
##########################\u7F51\u5173\u914D\u7F6E\u653E\u5728\u6700\u540E\u9762#################################
        - id: yumall_nginx_host
          uri: lb://yumall-product
          predicates:
            - Host=**.yumall.com,yumall.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>http://yumall.com/api/product/category/list/tree</p><p><img src="`+d+`" alt="image-20210912164205853"></p><h1 id="\u5341\u4E00\u3001\u68C0\u7D22\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#\u5341\u4E00\u3001\u68C0\u7D22\u670D\u52A1" aria-hidden="true">#</a> \u5341\u4E00\u3001\u68C0\u7D22\u670D\u52A1</h1><h2 id="\u6A21\u578B\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#\u6A21\u578B\u5206\u6790" aria-hidden="true">#</a> - - \u6A21\u578B\u5206\u6790</h2><p>1\u3001\u524D\u7AEF\u8BBE\u7F6E list.html</p><p>2\u3001\u540E\u7AEFes\u68C0\u7D22\u63A5\u53E3</p><p>3\u3001\u521B\u5EFAvo\uFF0CSearchParamVo\u3001SearchResultVo</p><h2 id="es\u68C0\u7D22\u7B80\u5355\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#es\u68C0\u7D22\u7B80\u5355\u6D4B\u8BD5" aria-hidden="true">#</a> - - es\u68C0\u7D22\u7B80\u5355\u6D4B\u8BD5</h2><p>\u7ED3\u6784\uFF1A</p><p>must\uFF1A\u6A21\u7CCA\u5173\u952E\u5B57\u67E5\u8BE2</p><p>filter\u8FC7\u6EE4\uFF1A\u5C5E\u6027\u3001\u5206\u7C7B\u3001\u54C1\u724C\u3001\u4EF7\u683C\u3001\u5E93\u5B58...</p><p>sort\uFF1A\u6392\u5E8F</p><p>\u5206\u9875\uFF0C\u9AD8\u4EAE\uFF0C\u805A\u5408</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>GET /product/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;bool&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;must&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;skuTitle&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;\u534E\u4E3A&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>,
      <span class="token string">&quot;filter&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;catalogId&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;225&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;terms&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;brandId&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
              <span class="token string">&quot;1&quot;</span>,
              <span class="token string">&quot;2&quot;</span>,
              <span class="token string">&quot;9&quot;</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;nested&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;path&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;attrs&quot;</span>,
            <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;bool&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;must&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                  <span class="token punctuation">{</span>
                    <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                      <span class="token string">&quot;attrs.attrId&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                        <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;15&quot;</span>
                      <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>,
                  <span class="token punctuation">{</span>
                    <span class="token string">&quot;terms&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                      <span class="token string">&quot;attrs.attrValue&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                        <span class="token string">&quot;\u534E\u4E3A&quot;</span>,
                        <span class="token string">&quot;navo 7 5G&quot;</span>
                      <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;hasStock&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;range&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;skuPrice&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;gte&quot;</span><span class="token builtin class-name">:</span> <span class="token number">100</span>,
              <span class="token string">&quot;lte&quot;</span><span class="token builtin class-name">:</span> <span class="token number">70000</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;sort&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;skuPrice&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;order&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;desc&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">20</span>,
  <span class="token string">&quot;highlight&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;skuTitle&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,
    <span class="token string">&quot;pre_tags&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&lt;b style=&#39;color:red&#39;&gt;&quot;</span>,
    <span class="token string">&quot;post_tags&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&lt;/b&gt;&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u805A\u5408\u67E5\u8BE2" tabindex="-1"><a class="header-anchor" href="#\u805A\u5408\u67E5\u8BE2" aria-hidden="true">#</a> - - \u805A\u5408\u67E5\u8BE2</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//1\u3001\u6784\u5EFA\u8BF7\u6C42\uFF1B2\u3001\u6784\u5EFA\u67E5\u8BE2\u6761\u4EF6
SearchRequest searchRequest = buildSearchRequest();
//3\u3001\u6267\u884C\u67E5\u8BE2
   SearchResponse response = client.search(searchRequest, ElasticSearchConfig.COMMON_OPTIONS);
//4\u3001\u6570\u636E\u5206\u6790\u5C01\u88C5
   result = buildSearchResult(response);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u6784\u5EFA\u8BF7\u6C42" tabindex="-1"><a class="header-anchor" href="#\u6784\u5EFA\u8BF7\u6C42" aria-hidden="true">#</a> --- \u6784\u5EFA\u8BF7\u6C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SearchSourceBuilder</span> sourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="must-\u6A21\u7CCA\u5173\u952E\u5B57\u67E5\u8BE2" tabindex="-1"><a class="header-anchor" href="#must-\u6A21\u7CCA\u5173\u952E\u5B57\u67E5\u8BE2" aria-hidden="true">#</a> - - must\uFF1A\u6A21\u7CCA\u5173\u952E\u5B57\u67E5\u8BE2</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>paramVo<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;skuTitle&quot;</span><span class="token punctuation">,</span> paramVo<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="filter-\u5206\u7C7B" tabindex="-1"><a class="header-anchor" href="#filter-\u5206\u7C7B" aria-hidden="true">#</a> - - filter\uFF1A\u5206\u7C7B</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> paramVo<span class="token punctuation">.</span><span class="token function">getCatalog3Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">,</span> paramVo<span class="token punctuation">.</span><span class="token function">getCatalog3Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="filter-\u54C1\u724Cid" tabindex="-1"><a class="header-anchor" href="#filter-\u54C1\u724Cid" aria-hidden="true">#</a> - - filter\uFF1A\u54C1\u724Cid</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> paramVo<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token number">0</span> <span class="token operator">&lt;</span> paramVo<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;brandId&quot;</span><span class="token punctuation">,</span> paramVo<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="filter-\u5C5E\u6027" tabindex="-1"><a class="header-anchor" href="#filter-\u5C5E\u6027" aria-hidden="true">#</a> - - filter\uFF1A<em>\u5C5E\u6027</em></h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> paramVo<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token number">0</span> <span class="token operator">&lt;</span> paramVo<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token comment">//1.2\u3001bool - filter -\u6309\u7167\u6240\u6709\u6307\u5B9A\u7684\u5C5E\u6027\u8FDB\u884C\u67E5\u8BE2</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> attrStr <span class="token operator">:</span> paramVo<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token comment">//attrs=1_ .5\u5BF8 :8\u5BF8&amp;attrs=2_ 166:8G</span>
				<span class="token class-name">BoolQueryBuilder</span> nestedboolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//attr = 1_ .5\u5BF8:8\u5BF8</span>
				<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> attrStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//\u68C0\u7D22\u7684\u5C5E\u6027id</span>
				<span class="token class-name">String</span> attrId <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token comment">//\u8FD9\u4E2A\u5C5E\u6027\u7684\u68C0\u7D22\u7528\u7684\u503C</span>
				<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> attrValues <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				nestedboolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;attrs . attrId&quot;</span><span class="token punctuation">,</span> attrId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				nestedboolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termsQuery</span><span class="token punctuation">(</span><span class="token string">&quot;attrs . attrValue&quot;</span><span class="token punctuation">,</span> attrValues<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//\u6BCF\u4E00\u4E2A\u5FC5\u987B\u90FD\u5F97\u751F\u62101\u4E2Anested\u67E5\u8BE2</span>
				boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">nestedQuery</span><span class="token punctuation">(</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">,</span> nestedboolQuery<span class="token punctuation">,</span> <span class="token class-name">ScoreMode<span class="token punctuation">.</span>None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="filter-\u5E93\u5B58" tabindex="-1"><a class="header-anchor" href="#filter-\u5E93\u5B58" aria-hidden="true">#</a> - - filter\uFF1A\u5E93\u5B58</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> paramVo<span class="token punctuation">.</span><span class="token function">getHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;hasStock&quot;</span><span class="token punctuation">,</span> paramVo<span class="token punctuation">.</span><span class="token function">getHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="filter-\u4EF7\u683C" tabindex="-1"><a class="header-anchor" href="#filter-\u4EF7\u683C" aria-hidden="true">#</a> - - filter\uFF1A\u4EF7\u683C</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>paramVo<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token class-name">RangeQueryBuilder</span> rangeQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;skuPrice&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strings <span class="token operator">=</span> paramVo<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				rangeQuery<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span>strings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span>strings<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>paramVo<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					rangeQuery<span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span>strings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>paramVo<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					rangeQuery<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span>strings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>rangeQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="from-\u5206\u9875" tabindex="-1"><a class="header-anchor" href="#from-\u5206\u9875" aria-hidden="true">#</a> - - from \u5206\u9875</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// \u5206\u9875\uFF0Cfrom\uFF08\u5F00\u59CB\u4F4D\u7F6E\uFF09\uFF0Csize\uFF08\u6BCF\u6B21\u51E0\u6761\uFF09</span>
		sourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>paramVo<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		sourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="highlighter-\u9AD8\u4EAE" tabindex="-1"><a class="header-anchor" href="#highlighter-\u9AD8\u4EAE" aria-hidden="true">#</a> - - highlighter \u9AD8\u4EAE</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>paramVo<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token class-name">HighlightBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			builder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;skuTit1e&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			builder<span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;b sty1e=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			builder<span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/b&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			sourceBuilder<span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u805A\u5408\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#\u805A\u5408\u5206\u6790" aria-hidden="true">#</a> - - \u805A\u5408\u5206\u6790</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//1\u3001\u54C1\u724C\u805A\u5408 brand_agg</span>
<span class="token class-name">TermsAggregationBuilder</span> brand_agg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;brand_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
brand_agg<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;brandId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//\u54C1\u724C\u805A\u5408\u7684\u5B50\u805A\u5408</span>
brand_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;brand_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;brandName.keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
brand_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;brand_img_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;brandImg.keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>brand_agg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2\u3001\u5206\u7C7B\u805A\u5408 catalog_agg</span>
<span class="token class-name">TermsAggregationBuilder</span> catalog_agg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;catalog_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
catalog_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;catalog_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;catalogName.keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>catalog_agg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//3\u3001\u5C5E\u6027\u805A\u5408 attr_agg</span>
<span class="token class-name">NestedAggregationBuilder</span> attr_agg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">nested</span><span class="token punctuation">(</span><span class="token string">&quot;attr_agg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;attrs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TermsAggregationBuilder</span> attr_id_agg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;attr_id_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;attrs.attrId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
attr_id_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;attr_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;attrs.attrName.keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
attr_id_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;attr_value_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;attrs.attrValue.keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
attr_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>attr_id_agg<span class="token punctuation">)</span><span class="token punctuation">;</span>
sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>attr_agg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u6570\u636E\u54CD\u5E94\u5C01\u88C5" tabindex="-1"><a class="header-anchor" href="#\u6570\u636E\u54CD\u5E94\u5C01\u88C5" aria-hidden="true">#</a> --- \u6570\u636E\u54CD\u5E94\u5C01\u88C5</h3><h4 id="\u5C01\u88C5searchresultvo\u4E3B\u8981\u53C2\u6570" tabindex="-1"><a class="header-anchor" href="#\u5C01\u88C5searchresultvo\u4E3B\u8981\u53C2\u6570" aria-hidden="true">#</a> - - \u5C01\u88C5SearchResultVo\u4E3B\u8981\u53C2\u6570\uFF1A</h4><p>List&lt;SkuEsModel&gt; products; List&lt;BrandVo&gt; brands; List&lt;CatalogVo&gt; catalogs; List&lt;AttrVo&gt; attrs;</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BrandVo</span><span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> brandId<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> brandName<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> brandImg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CatalogVo</span><span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> catalogId<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> catalogName<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AttrVo</span><span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> attrId<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> attrName<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> attrValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SearchResultVo result = new SearchResultVo();</p><h4 id="_1\u3001\u8FD4\u56DE\u7684\u6240\u6709\u67E5\u8BE2\u5230\u7684\u5546\u54C1" tabindex="-1"><a class="header-anchor" href="#_1\u3001\u8FD4\u56DE\u7684\u6240\u6709\u67E5\u8BE2\u5230\u7684\u5546\u54C1" aria-hidden="true">#</a> - - 1\u3001\u8FD4\u56DE\u7684\u6240\u6709\u67E5\u8BE2\u5230\u7684\u5546\u54C1</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> esModels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SkuEsModel</span> esModel <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">SkuEsModel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u662F\u68C0\u7D22\u65F6\uFF0C\u83B7\u53D6\u9AD8\u4EAE\u4FE1\u606F</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>paramVo<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token class-name">String</span> string <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;skuTitle&quot;</span><span class="token punctuation">)</span>
							<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					esModel<span class="token punctuation">.</span><span class="token function">setSkuTitle</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
    esModels<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>esModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>    
result<span class="token punctuation">.</span><span class="token function">setProducts</span><span class="token punctuation">(</span>esModels<span class="token punctuation">)</span><span class="token punctuation">;</span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2\u3001\u5F53\u524D\u6240\u6709\u5546\u54C1\u6D89\u53CA\u5230\u7684\u6240\u6709\u5C5E\u6027\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#_2\u3001\u5F53\u524D\u6240\u6709\u5546\u54C1\u6D89\u53CA\u5230\u7684\u6240\u6709\u5C5E\u6027\u4FE1\u606F" aria-hidden="true">#</a> - - 2\u3001\u5F53\u524D\u6240\u6709\u5546\u54C1\u6D89\u53CA\u5230\u7684\u6240\u6709\u5C5E\u6027\u4FE1\u606F</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResultVo<span class="token punctuation">.</span>AttrVo</span><span class="token punctuation">&gt;</span></span> attrVos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ParsedNested</span> attrAgg <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;attr_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ParsedLongTerms</span> attrIdAgg <span class="token operator">=</span> attrAgg<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;attr_id_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> attrIdAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SearchResultVo<span class="token punctuation">.</span>AttrVo</span> attrVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResultVo<span class="token punctuation">.</span>AttrVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//1\u3001\u5F97\u5230\u5C5E\u6027\u7684id</span>
			<span class="token keyword">long</span> attrId <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//2\u3001\u5F97\u5230\u5C5E\u6027\u7684\u540D\u5B57</span>
			<span class="token class-name">String</span> attrName <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ParsedStringTerms</span><span class="token punctuation">)</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;attr_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//3\u3001\u5F97\u5230\u5C5E\u6027\u7684\u6240\u6709\u503C.</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> attrValues <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ParsedStringTerms</span><span class="token punctuation">)</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;attr_value_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
						<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">)</span> item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    attrVo<span class="token punctuation">.</span>set<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    attrVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>attrVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
result<span class="token punctuation">.</span><span class="token function">setAttrs</span><span class="token punctuation">(</span>attrVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3\u3001\u5F53\u524D\u6240\u6709\u5546\u54C1\u6D89\u53CA\u5230\u7684\u6240\u6709\u54C1\u724C\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#_3\u3001\u5F53\u524D\u6240\u6709\u5546\u54C1\u6D89\u53CA\u5230\u7684\u6240\u6709\u54C1\u724C\u4FE1\u606F" aria-hidden="true">#</a> - - 3\u3001\u5F53\u524D\u6240\u6709\u5546\u54C1\u6D89\u53CA\u5230\u7684\u6240\u6709\u54C1\u724C\u4FE1\u606F</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResultVo<span class="token punctuation">.</span>BrandVo</span><span class="token punctuation">&gt;</span></span> brandVos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ParsedLongTerms</span> brandAgg <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;brand_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> brandAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token class-name">SearchResultVo<span class="token punctuation">.</span>BrandVo</span> brandVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResultVo<span class="token punctuation">.</span>BrandVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//1\u3001\u5F97\u5230\u54C1\u724C\u7684id</span>
			<span class="token keyword">long</span> brandId <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//2\u3001\u5F97\u5230\u54C1\u724C\u7684\u540D</span>
			<span class="token class-name">String</span> brandName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ParsedStringTerms</span><span class="token punctuation">)</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;brand_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//3\u3001\u5F97\u5230\u54C1\u724C\u7684\u56FE\u7247</span>
			<span class="token class-name">String</span> brandImg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ParsedStringTerms</span><span class="token punctuation">)</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;brand_img_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			brandVo<span class="token punctuation">.</span>set<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			brandVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>brandVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
result<span class="token punctuation">.</span><span class="token function">setBrands</span><span class="token punctuation">(</span>brandVos<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4\u3001\u5F53\u524D\u6240\u6709\u5546\u54C1\u6D89\u53CA\u5230\u7684\u6240\u6709\u5206\u7C7B\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#_4\u3001\u5F53\u524D\u6240\u6709\u5546\u54C1\u6D89\u53CA\u5230\u7684\u6240\u6709\u5206\u7C7B\u4FE1\u606F" aria-hidden="true">#</a> - - 4\u3001\u5F53\u524D\u6240\u6709\u5546\u54C1\u6D89\u53CA\u5230\u7684\u6240\u6709\u5206\u7C7B\u4FE1\u606F</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResultVo<span class="token punctuation">.</span>CatalogVo</span><span class="token punctuation">&gt;</span></span> catalogVos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ParsedLongTerms</span> cataLogAgg <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;catalog_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">&gt;</span></span> buckets <span class="token operator">=</span> cataLogAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token class-name">SearchResultVo<span class="token punctuation">.</span>CatalogVo</span> catalogVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResultVo<span class="token punctuation">.</span>CatalogVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//\u5F97\u5230\u5206\u7C7Bid</span>
			catalogVo<span class="token punctuation">.</span><span class="token function">setCatalogId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//\u5F97\u5230\u5206\u7C7B\u540D</span>
			<span class="token class-name">String</span> catalogNameAgg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ParsedStringTerms</span><span class="token punctuation">)</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;catalog_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			catalogVo<span class="token punctuation">.</span><span class="token function">setCatalogName</span><span class="token punctuation">(</span>catalogNameAgg<span class="token punctuation">)</span><span class="token punctuation">;</span>
			catalogVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>catalogVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		result<span class="token punctuation">.</span><span class="token function">setCatalogs</span><span class="token punctuation">(</span>catalogVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5\u3001\u5206\u9875\u4FE1\u606F-pagenum-total-totalpages-pagenavs" tabindex="-1"><a class="header-anchor" href="#_5\u3001\u5206\u9875\u4FE1\u606F-pagenum-total-totalpages-pagenavs" aria-hidden="true">#</a> - - 5\u3001\u5206\u9875\u4FE1\u606F pageNum total totalPages pageNavs</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//5\u3001\u5206\u9875\u4FE1\u606F-\u9875\u7801</span>
		result<span class="token punctuation">.</span><span class="token function">setPageNum</span><span class="token punctuation">(</span>paramVo<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//5\u3001\u5206\u9875\u4FE1\u606F-\u603B\u8BB0\u5F55\u6811</span>
		<span class="token keyword">long</span> total <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
		result<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//5\u3001\u5206\u9875\u4FE1\u606F\u603B\u9875\u7801-\u8BA1\u7B9711/2 = 5.. 1</span>
		<span class="token comment">//5\u30012\u5206\u9875\u4FE1\u606F-\u603B\u9875\u7801-\u8BA1\u7B97</span>
		<span class="token keyword">int</span> totalPages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> total<span class="token operator">%</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> total<span class="token operator">/</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE
				<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> total<span class="token operator">/</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result<span class="token punctuation">.</span><span class="token function">setTotalPages</span><span class="token punctuation">(</span>totalPages<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> pageNavs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> totalPages<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			pageNavs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		result<span class="token punctuation">.</span><span class="token function">setPageNavs</span><span class="token punctuation">(</span>pageNavs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6\u3001\u6784\u5EFA\u9762\u5305\u5C51\u5BFC\u822A" tabindex="-1"><a class="header-anchor" href="#_6\u3001\u6784\u5EFA\u9762\u5305\u5C51\u5BFC\u822A" aria-hidden="true">#</a> - - 6\u3001\u6784\u5EFA\u9762\u5305\u5C51\u5BFC\u822A</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//6\u3001\u6784\u5EFA\u9762\u5305\u5C51\u5BFC\u822A</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> param<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResult<span class="token punctuation">.</span>NavVo</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>attr <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
				<span class="token comment">//1\u3001\u5206\u6790\u6BCF\u4E00\u4E2Aattrs\u4F20\u8FC7\u6765\u7684\u53C2\u6570\u503C</span>
				<span class="token class-name">SearchResult<span class="token punctuation">.</span>NavVo</span> navVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult<span class="token punctuation">.</span>NavVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> attr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				navVo<span class="token punctuation">.</span><span class="token function">setNavValue</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">R</span> r <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">attrInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token class-name">AttrResponseVo</span> data <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;attr&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrResponseVo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					navVo<span class="token punctuation">.</span><span class="token function">setNavName</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getAttrName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
					navVo<span class="token punctuation">.</span><span class="token function">setNavName</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token comment">//2\u3001\u53D6\u6D88\u4E86\u8FD9\u4E2A\u9762\u5305\u5C51\u4EE5\u540E\uFF0C\u6211\u4EEC\u8981\u8DF3\u8F6C\u5230\u54EA\u4E2A\u5730\u65B9\uFF0C\u5C06\u8BF7\u6C42\u7684\u5730\u5740url\u91CC\u9762\u7684\u5F53\u524D\u7F6E\u7A7A</span>
				<span class="token comment">//\u62FF\u5230\u6240\u6709\u7684\u67E5\u8BE2\u6761\u4EF6\uFF0C\u53BB\u6389\u5F53\u524D</span>
				<span class="token class-name">String</span> encode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token keyword">try</span><span class="token punctuation">{</span>
					encode <span class="token operator">=</span> <span class="token class-name">URLEncoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//\u6D4F\u89C8\u5668\u5BF9\u7A7A\u683C\u7684\u7F16\u7801\u548CJava\u4E0D\u4E00\u6837\uFF0C\u5DEE\u5F02\u5316\u5904\u7406</span>
					encode<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;+&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;%20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
					e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token class-name">String</span> replace <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">get_queryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;attrs=&quot;</span><span class="token operator">+</span>attr<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				navVo<span class="token punctuation">.</span><span class="token function">setLink</span><span class="token punctuation">(</span><span class="token string">&quot;http://search.yumall.com/list.html?&quot;</span><span class="token operator">+</span>replace<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">return</span> navVo<span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			result<span class="token punctuation">.</span><span class="token function">setNavs</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u9875\u9762\u5904\u7406" tabindex="-1"><a class="header-anchor" href="#\u9875\u9762\u5904\u7406" aria-hidden="true">#</a> - - \u9875\u9762\u5904\u7406</h2><h3 id="\u70B9\u51FB\u8DF3\u8F6C" tabindex="-1"><a class="header-anchor" href="#\u70B9\u51FB\u8DF3\u8F6C" aria-hidden="true">#</a> --- \u70B9\u51FB\u8DF3\u8F6C</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>th:href=&quot;\${&#39;javascript:searchProducts(&amp;quot;brandId&amp;quot;,&#39;+brand.brandId+&#39;)&#39;}&quot;

function searchProducts(name, value) {
        //\u539F\u4F86\u7684\u9875\u9762
        location.href = replaceParamVal(location.href,name,value,true)
    }
    
function replaceParamVal(url, paramName, replaceVal,forceAdd) {
    var oUrl = url.toString();
    var nUrl;
    if (oUrl.indexOf(paramName) != -1) {
        if( forceAdd ) {
            if (oUrl.indexOf(&quot;?&quot;) != -1) {
                nUrl = oUrl + &quot;&amp;&quot; + paramName + &quot;=&quot; + replaceVal;
            } else {
                nUrl = oUrl + &quot;?&quot; + paramName + &quot;=&quot; + replaceVal;
            }
        } else {
            var re = eval(&#39;/(&#39; + paramName + &#39;=)([^&amp;]*)/gi&#39;);
            nUrl = oUrl.replace(re, paramName + &#39;=&#39; + replaceVal);
        }
    } else {
        if (oUrl.indexOf(&quot;?&quot;) != -1) {
            nUrl = oUrl + &quot;&amp;&quot; + paramName + &quot;=&quot; + replaceVal;
        } else {
            nUrl = oUrl + &quot;?&quot; + paramName + &quot;=&quot; + replaceVal;
        }
    }
    return nUrl;
};
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u7EFC\u5408\u6392\u5E8F\u3001\u9500\u91CF\u3001\u4EF7\u683C\u3001\u8BC4\u5206\u3001\u4E0A\u67B6\u65F6\u95F4\u3001\u5206\u9875\u3001\u6392\u5E8F\u5185\u5BB9\u3001\u4EC5\u663E\u793A\u6709\u8D27" tabindex="-1"><a class="header-anchor" href="#\u7EFC\u5408\u6392\u5E8F\u3001\u9500\u91CF\u3001\u4EF7\u683C\u3001\u8BC4\u5206\u3001\u4E0A\u67B6\u65F6\u95F4\u3001\u5206\u9875\u3001\u6392\u5E8F\u5185\u5BB9\u3001\u4EC5\u663E\u793A\u6709\u8D27" aria-hidden="true">#</a> --- \u7EFC\u5408\u6392\u5E8F\u3001\u9500\u91CF\u3001\u4EF7\u683C\u3001\u8BC4\u5206\u3001\u4E0A\u67B6\u65F6\u95F4\u3001\u5206\u9875\u3001\u6392\u5E8F\u5185\u5BB9\u3001\u4EC5\u663E\u793A\u6709\u8D27...</h3><h3 id="\u9762\u5305\u5C51\u5BFC\u822A" tabindex="-1"><a class="header-anchor" href="#\u9762\u5305\u5C51\u5BFC\u822A" aria-hidden="true">#</a> --- \u9762\u5305\u5C51\u5BFC\u822A</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;div class=&quot;JD_ipone_one c&quot;&gt;
    &lt;!-- \u904D\u5386\u9762\u5305\u5C51\u529F\u80FD --&gt;
    &lt;a th:href=&quot;\${nav.link}&quot; th:each=&quot;nav:\${result.navs}&quot;&gt;&lt;span th:text=&quot;\${nav.navName}&quot;&gt;&lt;/span&gt;\uFF1A&lt;span
            th:text=&quot;\${nav.navValue}&quot;&gt;&lt;/span&gt; x&lt;/a&gt;
&lt;/div&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u5341\u4E09\u3001\u5546\u54C1\u8BE6\u60C5" tabindex="-1"><a class="header-anchor" href="#\u5341\u4E09\u3001\u5546\u54C1\u8BE6\u60C5" aria-hidden="true">#</a> \u5341\u4E09\u3001\u5546\u54C1\u8BE6\u60C5</h1><h2 id="_0\u3001\u7EBF\u7A0B\u6C60\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#_0\u3001\u7EBF\u7A0B\u6C60\u914D\u7F6E" aria-hidden="true">#</a> 0\u3001\u7EBF\u7A0B\u6C60\u914D\u7F6E</h2><h3 id="mythreadconfig" tabindex="-1"><a class="header-anchor" href="#mythreadconfig" aria-hidden="true">#</a> --- MyThreadConfig</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolConfigProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyThreadConfig</span><span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token function">threadPoolExecutor</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolConfigProperties</span> pool<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
            pool<span class="token punctuation">.</span><span class="token function">getCoreSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            pool<span class="token punctuation">.</span><span class="token function">getMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            pool<span class="token punctuation">.</span><span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="threadpoolconfigproperties" tabindex="-1"><a class="header-anchor" href="#threadpoolconfigproperties" aria-hidden="true">#</a> --- ThreadPoolConfigProperties</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;yumall.thread&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolConfigProperties</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> coreSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> maxSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> keepAliveTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="properties" tabindex="-1"><a class="header-anchor" href="#properties" aria-hidden="true">#</a> --- Properties</h3><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>#\u914D\u7F6E\u7EBF\u7A0B\u6C60
yumall.thread.coreSize=20
yumall.thread.maxSize=200
yumall.thread.keepAliveTime=10
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ThreadPoolExecutor executor;</p><h2 id="_1\u3001sku\u57FA\u672C\u4FE1\u606F\u7684\u83B7\u53D6-pms-sku-info" tabindex="-1"><a class="header-anchor" href="#_1\u3001sku\u57FA\u672C\u4FE1\u606F\u7684\u83B7\u53D6-pms-sku-info" aria-hidden="true">#</a> 1\u3001sku\u57FA\u672C\u4FE1\u606F\u7684\u83B7\u53D6 pms_sku_info</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> infoFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
   <span class="token class-name">SkuInfoEntity</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   skuItemVo<span class="token punctuation">.</span><span class="token function">setInfo</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> info<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2\u3001sku\u7684\u56FE\u7247\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#_2\u3001sku\u7684\u56FE\u7247\u4FE1\u606F" aria-hidden="true">#</a> 2\u3001sku\u7684\u56FE\u7247\u4FE1\u606F</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> imageFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuImagesEntity</span><span class="token punctuation">&gt;</span></span> imagesEntities <span class="token operator">=</span> skuImagesService<span class="token punctuation">.</span><span class="token function">getImagesBySkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   skuItemVo<span class="token punctuation">.</span><span class="token function">setImages</span><span class="token punctuation">(</span>imagesEntities<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

getImagesBySkuId<span class="token operator">::</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuImagesEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;sku_id&quot;</span><span class="token punctuation">,</span> skuId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3\u3001\u83B7\u53D6spu\u7684\u9500\u552E\u5C5E\u6027\u7EC4\u5408" tabindex="-1"><a class="header-anchor" href="#_3\u3001\u83B7\u53D6spu\u7684\u9500\u552E\u5C5E\u6027\u7EC4\u5408" aria-hidden="true">#</a> 3\u3001\u83B7\u53D6spu\u7684\u9500\u552E\u5C5E\u6027\u7EC4\u5408</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> saleAttrFuture <span class="token operator">=</span> infoFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuItemSaleAttrVo</span><span class="token punctuation">&gt;</span></span> saleAttrVos <span class="token operator">=</span> skuSaleAttrValueService<span class="token punctuation">.</span><span class="token function">getSaleAttrBySpuId</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getSpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   skuItemVo<span class="token punctuation">.</span><span class="token function">setSaleAttr</span><span class="token punctuation">(</span>saleAttrVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

getSaleAttrBySpuId<span class="token operator">::</span>
	<span class="token class-name">SkuSaleAttrValueDao</span> baseMapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBaseMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> baseMapper<span class="token punctuation">.</span><span class="token function">getSaleAttrBySpuId</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4\u3001\u83B7\u53D6spu\u7684\u4ECB\u7ECD" tabindex="-1"><a class="header-anchor" href="#_4\u3001\u83B7\u53D6spu\u7684\u4ECB\u7ECD" aria-hidden="true">#</a> 4\u3001\u83B7\u53D6spu\u7684\u4ECB\u7ECD</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> descFuture <span class="token operator">=</span> infoFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
   <span class="token class-name">SpuInfoDescEntity</span> spuInfoDescEntity <span class="token operator">=</span> spuInfoDescService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getSpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   skuItemVo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span>spuInfoDescEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5\u3001\u83B7\u53D6spu\u7684\u89C4\u683C\u53C2\u6570\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#_5\u3001\u83B7\u53D6spu\u7684\u89C4\u683C\u53C2\u6570\u4FE1\u606F" aria-hidden="true">#</a> 5\u3001\u83B7\u53D6spu\u7684\u89C4\u683C\u53C2\u6570\u4FE1\u606F</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> baseAttrFuture <span class="token operator">=</span> infoFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpuItemAttrGroupVo</span><span class="token punctuation">&gt;</span></span> attrGroupVos <span class="token operator">=</span> attrGroupService<span class="token punctuation">.</span><span class="token function">getAttrGroupWithAttrsBySpuId</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getSpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">getCatalogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   skuItemVo<span class="token punctuation">.</span><span class="token function">setGroupAttrs</span><span class="token punctuation">(</span>attrGroupVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

getAttrGroupWithAttrsBySpuId<span class="token operator">::</span>
	<span class="token comment">//1\u3001\u67E5\u51FA\u5F53\u524Dspu\u5BF9\u5E94\u7684\u6240\u6709\u5C5E\u6027\u7684\u5206\u7EC4\u4FE1\u606F\u4EE5\u53CA\u5F53\u524D\u5206\u7EC4\u4E0B\u7684\u6240\u6709\u5C5E\u6027\u5BF9\u5E94\u7684\u503C</span>
        <span class="token class-name">AttrGroupDao</span> baseMapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBaseMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> baseMapper<span class="token punctuation">.</span><span class="token function">getAttrGroupWithAttrsBySpuId</span><span class="token punctuation">(</span>spuId<span class="token punctuation">,</span>catalogId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="todo-6\u3001\u8FDC\u7A0B\u8C03\u7528\u67E5\u8BE2\u5F53\u524Dsku\u662F\u5426\u53C2\u4E0E\u79D2\u6740\u4F18\u60E0\u6D3B\u52A8" tabindex="-1"><a class="header-anchor" href="#todo-6\u3001\u8FDC\u7A0B\u8C03\u7528\u67E5\u8BE2\u5F53\u524Dsku\u662F\u5426\u53C2\u4E0E\u79D2\u6740\u4F18\u60E0\u6D3B\u52A8" aria-hidden="true">#</a> //TODO 6\u3001\u8FDC\u7A0B\u8C03\u7528\u67E5\u8BE2\u5F53\u524Dsku\u662F\u5426\u53C2\u4E0E\u79D2\u6740\u4F18\u60E0\u6D3B\u52A8</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> seckillFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
   <span class="token class-name">R</span> skuSeckilInfo <span class="token operator">=</span> seckillFeignService<span class="token punctuation">.</span><span class="token function">getSkuSeckilInfo</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>skuSeckilInfo<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u67E5\u8BE2\u6210\u529F</span>
      <span class="token class-name">SeckillSkuVo</span> seckilInfoData <span class="token operator">=</span> skuSeckilInfo<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuVo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      skuItemVo<span class="token punctuation">.</span><span class="token function">setSeckillSkuVo</span><span class="token punctuation">(</span>seckilInfoData<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span><span class="token punctuation">(</span>seckilInfoData <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>currentTime <span class="token operator">&gt;</span> seckilInfoData<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            skuItemVo<span class="token punctuation">.</span><span class="token function">setSeckillSkuVo</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>CompletableFuture.allOf(saleAttrFuture, descFuture, baseAttrFuture, imageFuture).get();</p><p>return skuItemVo;</p><h1 id="\u5341\u56DB\u3001\u8BA4\u8BC1\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#\u5341\u56DB\u3001\u8BA4\u8BC1\u670D\u52A1" aria-hidden="true">#</a> \u5341\u56DB\u3001\u8BA4\u8BC1\u670D\u52A1</h1><h2 id="_1\u3001\u521D\u59CB\u5316" tabindex="-1"><a class="header-anchor" href="#_1\u3001\u521D\u59CB\u5316" aria-hidden="true">#</a> 1\u3001\u521D\u59CB\u5316</h2><p>\u521B\u5EFAyumall-auth-server\u670D\u52A1\uFF0Cport\uFF1A20000\uFF0Cpom\u6392\u9664SQL\u4F9D\u8D56</p><p>nacos\uFF1Aother.yml\uFF0Credis.yml</p><p>nginx\uFF1Alogin\uFF0Creg\uFF0Cauth.yumall.com;</p><h2 id="_2\u3001\u7F51\u5173" tabindex="-1"><a class="header-anchor" href="#_2\u3001\u7F51\u5173" aria-hidden="true">#</a> 2\u3001\u7F51\u5173:</h2><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>- id: yumall_auth_route
  uri: lb://yumall-auth-server
  predicates:
    - Host=auth.yumall.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3\u3001\u9996\u9875" tabindex="-1"><a class="header-anchor" href="#_3\u3001\u9996\u9875" aria-hidden="true">#</a> 3\u3001\u9996\u9875</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/login.html&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>

   <span class="token comment">//\u4ECEsession\u5148\u53D6\u51FA\u6765\u7528\u6237\u7684\u4FE1\u606F\uFF0C\u5224\u65AD\u7528\u6237\u662F\u5426\u5DF2\u7ECF\u767B\u5F55\u8FC7\u4E86</span>
   <span class="token class-name">Object</span> attribute <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>LOGIN_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//\u5982\u679C\u7528\u6237\u6CA1\u767B\u5F55\u90A3\u5C31\u8DF3\u8F6C\u5230\u767B\u5F55\u9875\u9762</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>attribute <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://yumall.com&quot;</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4\u3001\u6CE8\u518C-\u83B7\u53D6\u624B\u673A\u9A8C\u8BC1\u7801-\u5012\u8BA1\u65F6" tabindex="-1"><a class="header-anchor" href="#_4\u3001\u6CE8\u518C-\u83B7\u53D6\u624B\u673A\u9A8C\u8BC1\u7801-\u5012\u8BA1\u65F6" aria-hidden="true">#</a> 4\u3001\u6CE8\u518C-\u83B7\u53D6\u624B\u673A\u9A8C\u8BC1\u7801\uFF0C\u5012\u8BA1\u65F6</h2><h3 id="_4-1-html" tabindex="-1"><a class="header-anchor" href="#_4-1-html" aria-hidden="true">#</a> 4.1 html</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;register-box&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>label <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;other_label&quot;</span><span class="token operator">&gt;</span>\u9A8C \u8BC1 \u7801
                <span class="token operator">&lt;</span>input name<span class="token operator">=</span><span class="token string">&quot;code&quot;</span> maxlength<span class="token operator">=</span><span class="token string">&quot;20&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> placeholder<span class="token operator">=</span><span class="token string">&quot;\u8BF7\u8F93\u5165\u9A8C\u8BC1\u7801&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;caa&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>a id<span class="token operator">=</span><span class="token string">&quot;sendCode&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token operator">&gt;</span> \u53D1\u9001\u9A8C\u8BC1\u7801 <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>


<span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//2\u3001\u5012\u8BA1\u65F6</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasClass</span><span class="token punctuation">(</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u6B63\u5728\u5012\u8BA1\u65F6\u4E2D</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//1\u3001\u7ED9\u6307\u5B9A\u624B\u673A\u53F7\u53D1\u9001\u9A8C\u8BC1\u7801</span>
            $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/sms/sendCode?phone=&quot;</span> <span class="token operator">+</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#phoneNum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">timeoutChangeStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> num <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">timeoutChangeStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;disabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">&quot;\u53D1\u9001\u9A8C\u8BC1\u7801&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            num <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> str <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token string">&quot;s \u540E\u518D\u6B21\u53D1\u9001&quot;</span><span class="token punctuation">;</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token string">&quot;timeoutChangeStyle()&quot;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        num<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-\u540E\u7AEF" tabindex="-1"><a class="header-anchor" href="#_4-2-\u540E\u7AEF" aria-hidden="true">#</a> 4.2 \u540E\u7AEF\uFF1A</h3><h4 id="_4-2-1-a\u3001\u63A5\u53E3\u9632\u5237-b\u3001\u9A8C\u8BC1\u7801\u7684\u518D\u6B21\u6548\u9A8C-c\u3001\u5B58\u5165redis-\u9632\u6B62\u540C\u4E00\u4E2A\u624B\u673A\u53F7\u572860\u79D2\u5185\u518D\u6B21\u53D1\u9001\u9A8C\u8BC1\u7801" tabindex="-1"><a class="header-anchor" href="#_4-2-1-a\u3001\u63A5\u53E3\u9632\u5237-b\u3001\u9A8C\u8BC1\u7801\u7684\u518D\u6B21\u6548\u9A8C-c\u3001\u5B58\u5165redis-\u9632\u6B62\u540C\u4E00\u4E2A\u624B\u673A\u53F7\u572860\u79D2\u5185\u518D\u6B21\u53D1\u9001\u9A8C\u8BC1\u7801" aria-hidden="true">#</a> 4.2.1 a\u3001\u63A5\u53E3\u9632\u5237\uFF0Cb\u3001\u9A8C\u8BC1\u7801\u7684\u518D\u6B21\u6548\u9A8C\uFF0Cc\u3001\u5B58\u5165redis\uFF0C\u9632\u6B62\u540C\u4E00\u4E2A\u624B\u673A\u53F7\u572860\u79D2\u5185\u518D\u6B21\u53D1\u9001\u9A8C\u8BC1\u7801</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/sms/sendCode&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> phone<span class="token punctuation">)</span><span class="token punctuation">{</span>

   <span class="token comment">//1\u3001\u63A5\u53E3\u9632\u5237</span>
   <span class="token class-name">String</span> redisCode <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span>SMS_CODE_CACHE_PREFIX<span class="token operator">+</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>redisCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u6D3B\u52A8\u5B58\u5165redis\u7684\u65F6\u95F4\uFF0C\u7528\u5F53\u524D\u65F6\u95F4\u51CF\u53BB\u5B58\u5165redis\u7684\u65F6\u95F4\uFF0C\u5224\u65AD\u7528\u6237\u624B\u673A\u53F7\u662F\u5426\u572860s\u5185\u53D1\u9001\u9A8C\u8BC1\u7801</span>
      <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>redisCode<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>currentTime<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token comment">//60s\u5185\u4E0D\u80FD\u518D\u53D1</span>
         <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span>SMS_CODE_EXCEPTION<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span>SMS_CODE_EXCEPTION<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//2\u3001\u9A8C\u8BC1\u7801\u7684\u518D\u6B21\u6548\u9A8C redis.\u5B58key-phone,value-code</span>
   <span class="token keyword">int</span> code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">9</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> codeNum <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> redisStorage <span class="token operator">=</span> codeNum<span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//\u5B58\u5165redis\uFF0C\u9632\u6B62\u540C\u4E00\u4E2A\u624B\u673A\u53F7\u572860\u79D2\u5185\u518D\u6B21\u53D1\u9001\u9A8C\u8BC1\u7801\uFF0C10\u5206\u949F</span>
   stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span>SMS_CODE_CACHE_PREFIX<span class="token operator">+</span>phone<span class="token punctuation">,</span>
         redisStorage<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//\u8FDB\u5165\u7B2C\u4E09\u65B9\u670D\u52A1+\u4F7F\u7528\u963F\u91CC\u53D1\u9001\u9A8C\u8BC1\u7801</span>
   thirdPartFeignService<span class="token punctuation">.</span><span class="token function">sendCode</span><span class="token punctuation">(</span>phone<span class="token punctuation">,</span> codeNum<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-2-\u8FDB\u5165\u7B2C\u4E09\u65B9\u670D\u52A1-\u4F7F\u7528\u963F\u91CC\u53D1\u9001\u9A8C\u8BC1\u7801" tabindex="-1"><a class="header-anchor" href="#_4-2-2-\u8FDB\u5165\u7B2C\u4E09\u65B9\u670D\u52A1-\u4F7F\u7528\u963F\u91CC\u53D1\u9001\u9A8C\u8BC1\u7801" aria-hidden="true">#</a> 4.2.2 \u8FDB\u5165\u7B2C\u4E09\u65B9\u670D\u52A1+\u4F7F\u7528\u963F\u91CC\u53D1\u9001\u9A8C\u8BC1\u7801</h4><p>package com.kong.yumall.authserver.feign;</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;yumall-third-party&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ThirdPartFeignService</span><span class="token punctuation">{</span>
   <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/sms/sendCode&quot;</span><span class="token punctuation">)</span>
   <span class="token class-name">R</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/sendCode&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//\u53D1\u9001\u9A8C\u8BC1\u7801</span>
    smsComponent<span class="token punctuation">.</span><span class="token function">sendCode</span><span class="token punctuation">(</span>phone<span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u963F\u91CC\u4E91</p><p>https://market.console.aliyun.com/imageconsole/index.htm?#/bizlist?_k=fxmn6k</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;
    &lt;optional&gt;true&lt;/optional&gt;
&lt;/dependency&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>spring.cloud.nacos.config.ext-config[0].data-id=oss.yml
spring.cloud.nacos.config.ext-config[0].group=DEFAULT_GROUP
spring.cloud.nacos.config.ext-config[0].refresh=true
spring.cloud.nacos.config.ext-config[1].data-id=sms.yml
spring.cloud.nacos.config.ext-config[1].group=DEFAULT_GROUP
spring.cloud.nacos.config.ext-config[1].refresh=true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>spring:
  cloud:
    alicloud:
      sms:
        host: https://dfsns.market.alicloudapi.com
        path: /data/send_sms
        appcode: 2805a9d8f3644286a74525e800288d18
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.cloud.alicloud.sms&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SmsComponent</span><span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> path<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> appcode<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> skin<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> sign<span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * <span class="token keyword">@param</span> <span class="token parameter">phone</span>
	 * <span class="token keyword">@param</span> <span class="token parameter">code</span>
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token class-name">String</span> method <span class="token operator">=</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">;</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPCODE &quot;</span><span class="token operator">+</span>appcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bodys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		bodys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;code:&quot;</span><span class="token operator">+</span>code<span class="token operator">+</span><span class="token string">&quot;,expire_at:5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		bodys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;phone_number&quot;</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
		bodys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;template_id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TPL_0001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span><span class="token punctuation">{</span>
			<span class="token class-name">HttpResponse</span> response <span class="token operator">=</span> <span class="token class-name">HttpUtils</span><span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> path<span class="token punctuation">,</span> method<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> query<span class="token punctuation">,</span> bodys<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5\u3001\u7528\u6237\u6CE8\u518C" tabindex="-1"><a class="header-anchor" href="#_5\u3001\u7528\u6237\u6CE8\u518C" aria-hidden="true">#</a> 5\u3001\u7528\u6237\u6CE8\u518C</h2><h3 id="_5-1\u3001\u7528\u6237\u5B9E\u4F53\u7C7B" tabindex="-1"><a class="header-anchor" href="#_5-1\u3001\u7528\u6237\u5B9E\u4F53\u7C7B" aria-hidden="true">#</a> 5.1\u3001\u7528\u6237\u5B9E\u4F53\u7C7B</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">UserRegisterVo</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@NotEmpty</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;\u7528\u6237\u540D\u4E0D\u80FD\u4E3A\u7A7A&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Length</span><span class="token punctuation">(</span>min <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span> max <span class="token operator">=</span> <span class="token number">19</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">&quot;\u7528\u6237\u540D\u957F\u5EA6\u57286-18\u5B57\u7B26&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@NotEmpty</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;\u5BC6\u7801\u5FC5\u987B\u586B\u5199&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Length</span><span class="token punctuation">(</span>min <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span>max <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">,</span>message <span class="token operator">=</span> <span class="token string">&quot;\u5BC6\u7801\u5FC5\u987B\u662F6\u201418\u4F4D\u5B57\u7B26&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@NotEmpty</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;\u624B\u673A\u53F7\u4E0D\u80FD\u4E3A\u7A7A&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Pattern</span><span class="token punctuation">(</span>regexp <span class="token operator">=</span> <span class="token string">&quot;^[1]([3-9])[0-9]{9}$&quot;</span><span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">&quot;\u624B\u673A\u53F7\u683C\u5F0F\u4E0D\u6B63\u786E&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@NotEmpty</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;\u9A8C\u8BC1\u7801\u4E0D\u80FD\u4E3A\u7A7A&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2\u3001\u6CE8\u518C\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_5-2\u3001\u6CE8\u518C\u6D41\u7A0B" aria-hidden="true">#</a> 5.2\u3001\u6CE8\u518C\u6D41\u7A0B</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/register&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token class-name">UserRegisterVo</span> vos<span class="token punctuation">,</span> <span class="token class-name">BindingResult</span> result<span class="token punctuation">,</span>
                  <span class="token class-name">RedirectAttributes</span> attributes<span class="token punctuation">)</span><span class="token punctuation">{</span>

   <span class="token comment">//\u5982\u679C\u6709\u9519\u8BEF\u56DE\u5230\u6CE8\u518C\u9875\u9762</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getFieldErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">FieldError</span><span class="token operator">::</span><span class="token function">getField</span><span class="token punctuation">,</span> <span class="token class-name">FieldError</span><span class="token operator">::</span><span class="token function">getDefaultMessage</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      attributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span> errors<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//\u6548\u9A8C\u51FA\u9519\u56DE\u5230\u6CE8\u518C\u9875\u9762</span>
      <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.yumall.com/reg.html&quot;</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//1\u3001\u6548\u9A8C\u9A8C\u8BC1\u7801</span>
   <span class="token class-name">String</span> code <span class="token operator">=</span> vos<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//\u83B7\u53D6\u5B58\u5165Redis\u91CC\u7684\u9A8C\u8BC1\u7801</span>
   <span class="token class-name">String</span> redisCode <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span>SMS_CODE_CACHE_PREFIX<span class="token operator">+</span>vos<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>redisCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u622A\u53D6\u5B57\u7B26\u4E32</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisCode<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token comment">//\u5220\u9664\u9A8C\u8BC1\u7801;\u4EE4\u724C\u673A\u5236</span>
         stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span>SMS_CODE_CACHE_PREFIX<span class="token operator">+</span>vos<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//\u9A8C\u8BC1\u7801\u901A\u8FC7\uFF0C\u771F\u6B63\u6CE8\u518C\uFF0C\u8C03\u7528\u8FDC\u7A0B\u670D\u52A1\u8FDB\u884C\u6CE8\u518C</span>
         <span class="token class-name">R</span> register <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>vos<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>register<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//\u6210\u529F</span>
            <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.yumall.com/login.html&quot;</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//\u5931\u8D25</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            errors<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span> register<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span> errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.yumall.com/reg.html&quot;</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>


      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
         <span class="token comment">//\u6548\u9A8C\u51FA\u9519\u56DE\u5230\u6CE8\u518C\u9875\u9762</span>
         <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         errors<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u9A8C\u8BC1\u7801\u9519\u8BEF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         attributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span> errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.yumall.com/reg.html&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">//\u6548\u9A8C\u51FA\u9519\u56DE\u5230\u6CE8\u518C\u9875\u9762</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      errors<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u9A8C\u8BC1\u7801\u9519\u8BEF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      attributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span> errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.yumall.com/reg.html&quot;</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3\u3001\u8FDC\u7A0B\u8C03\u7528\u4F1A\u5458\u670D\u52A1\u5B9E\u73B0\u6CE8\u518C" tabindex="-1"><a class="header-anchor" href="#_5-3\u3001\u8FDC\u7A0B\u8C03\u7528\u4F1A\u5458\u670D\u52A1\u5B9E\u73B0\u6CE8\u518C" aria-hidden="true">#</a> 5.3\u3001\u8FDC\u7A0B\u8C03\u7528\u4F1A\u5458\u670D\u52A1\u5B9E\u73B0\u6CE8\u518C</h3><p>/memberFeignService.register(vos);</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;yumall-member&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MemberFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/member/member/register&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">R</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">UserRegisterVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/register&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MemberUserRegisterVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">{</span>

   <span class="token keyword">try</span><span class="token punctuation">{</span>
      memberService<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">PhoneException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span>PHONE_EXIST_EXCEPTION<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span>PHONE_EXIST_EXCEPTION<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">UsernameException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span>USER_EXIST_EXCEPTION<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span>USER_EXIST_EXCEPTION<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">MemberUserRegisterVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">{</span>

   <span class="token class-name">MemberEntity</span> memberEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//\u8BBE\u7F6E\u9ED8\u8BA4\u7B49\u7EA7</span>
   <span class="token class-name">MemberLevelEntity</span> levelEntity <span class="token operator">=</span> memberLevelDao<span class="token punctuation">.</span><span class="token function">getDefaultLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   memberEntity<span class="token punctuation">.</span><span class="token function">setLevelId</span><span class="token punctuation">(</span>levelEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//\u8BBE\u7F6E\u5176\u5B83\u7684\u9ED8\u8BA4\u4FE1\u606F</span>
   <span class="token comment">//\u68C0\u67E5\u7528\u6237\u540D\u548C\u624B\u673A\u53F7\u662F\u5426\u552F\u4E00\u3002\u611F\u77E5\u5F02\u5E38\uFF0C\u5F02\u5E38\u673A\u5236</span>
   <span class="token function">checkPhoneUnique</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">checkUserNameUnique</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   memberEntity<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   memberEntity<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//\u5BC6\u7801\u8FDB\u884CMD5\u52A0\u5BC6</span>
   <span class="token class-name">BCryptPasswordEncoder</span> bCryptPasswordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> encode <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   memberEntity<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
   memberEntity<span class="token punctuation">.</span><span class="token function">setMobile</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   memberEntity<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   memberEntity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//\u4FDD\u5B58\u6570\u636E</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>memberEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>public void checkPhoneUnique(String phone) throws PhoneException{
   Integer phoneCount = this.baseMapper.selectCount(new QueryWrapper&lt;MemberEntity&gt;().eq(&quot;mobile&quot;, phone));
   if(phoneCount &gt; 0){
      throw new PhoneException();
   }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>public void checkUserNameUnique(String userName) throws UsernameException{
   Integer usernameCount = this.baseMapper.selectCount(new QueryWrapper&lt;MemberEntity&gt;().eq(&quot;username&quot;, userName));
   if(usernameCount &gt; 0){
      throw new UsernameException();
   }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6\u3001\u767B\u5F55" tabindex="-1"><a class="header-anchor" href="#_6\u3001\u767B\u5F55" aria-hidden="true">#</a> 6\u3001\u767B\u5F55</h2><p>/package com.kong.yumall.authserver.feign;</p><h3 id="_6-1\u3001\u8FDC\u7A0B-\u7528\u6237\u767B\u5F55" tabindex="-1"><a class="header-anchor" href="#_6-1\u3001\u8FDC\u7A0B-\u7528\u6237\u767B\u5F55" aria-hidden="true">#</a> 6.1\u3001\u8FDC\u7A0B-\u7528\u6237\u767B\u5F55</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">UserLoginVo</span> vo<span class="token punctuation">,</span> <span class="token class-name">RedirectAttributes</span> attributes<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//\u8FDC\u7A0B\u767B\u5F55</span>
   <span class="token class-name">R</span> login <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>login<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">MemberResponseVo</span> data <span class="token operator">=</span> login<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberResponseVo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>LOGIN_USER<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://yumall.com&quot;</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      errors<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span> login<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      attributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span> errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.yumall.com/login.html&quot;</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u8C03\u7528\u4F1A\u5458\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#\u8C03\u7528\u4F1A\u5458\u670D\u52A1" aria-hidden="true">#</a> \u8C03\u7528\u4F1A\u5458\u670D\u52A1</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;yumall-member&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MemberFeignService</span> <span class="token punctuation">{</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/member/member/login&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">R</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">UserLoginVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u4F1A\u5458\u670D\u52A1\u5B9E\u73B0\u767B\u5F55" tabindex="-1"><a class="header-anchor" href="#\u4F1A\u5458\u670D\u52A1\u5B9E\u73B0\u767B\u5F55" aria-hidden="true">#</a> \u4F1A\u5458\u670D\u52A1\u5B9E\u73B0\u767B\u5F55</h4><p>/controller</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MemberUserLoginVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">{</span>

   <span class="token class-name">MemberEntity</span> memberEntity <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span><span class="token punctuation">(</span>memberEntity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>memberEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>MemberService</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">MemberEntity</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">MemberUserLoginVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">String</span> loginacct <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getLoginacct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> password <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//1\u3001\u53BB\u6570\u636E\u5E93\u67E5\u8BE2 SELECT * FROM ums_member WHERE username = ? OR mobile = ?</span>
   <span class="token class-name">MemberEntity</span> memberEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> loginacct<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;mobile&quot;</span><span class="token punctuation">,</span> loginacct<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span><span class="token punctuation">(</span>memberEntity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u767B\u5F55\u5931\u8D25</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">//\u83B7\u53D6\u5230\u6570\u636E\u5E93\u91CC\u7684password</span>
      <span class="token class-name">String</span> password1 <span class="token operator">=</span> memberEntity<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">BCryptPasswordEncoder</span> passwordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u8FDB\u884C\u5BC6\u7801\u5339\u914D</span>
      <span class="token keyword">boolean</span> matches <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> password1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>matches<span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token comment">//\u767B\u5F55\u6210\u529F</span>
         <span class="token keyword">return</span> memberEntity<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2\u3001\u8FDC\u7A0B-\u793E\u4EA4\u7528\u6237\u7684\u767B\u5F55-\u5FAE\u4FE1" tabindex="-1"><a class="header-anchor" href="#_6-2\u3001\u8FDC\u7A0B-\u793E\u4EA4\u7528\u6237\u7684\u767B\u5F55-\u5FAE\u4FE1" aria-hidden="true">#</a> 6.2\u3001\u8FDC\u7A0B-\u793E\u4EA4\u7528\u6237\u7684\u767B\u5F55\uFF08\u5FAE\u4FE1\uFF09</h3><h4 id="controller" tabindex="-1"><a class="header-anchor" href="#controller" aria-hidden="true">#</a> controller</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u83B7\u53D6\u626B\u7801\u4EBA\u7684\u4FE1\u606F\uFF0C\u6DFB\u52A0\u6570\u636E
 *
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/callback&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> state<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
   <span class="token keyword">try</span><span class="token punctuation">{</span>
      <span class="token comment">//\u5F97\u5230\u6388\u6743\u4E34\u65F6\u7968\u636Ecode</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u4ECEredis\u4E2D\u5C06state\u83B7\u53D6\u51FA\u6765\uFF0C\u548C\u5F53\u524D\u4F20\u5165\u7684state\u4F5C\u6BD4\u8F83</span>
      <span class="token comment">//\u5982\u679C\u4E00\u81F4\u5219\u653E\u884C\uFF0C\u5982\u679C\u4E0D\u4E00\u81F4\u5219\u629B\u51FA\u5F02\u5E38\uFF1A\u975E\u6CD5\u8BBF\u95EE</span>

      <span class="token comment">//\u5411\u8BA4\u8BC1\u670D\u52A1\u5668\u53D1\u9001\u8BF7\u6C42\u6362\u53D6access_token</span>
      <span class="token comment">//2\u3001\u62FF\u7740code\u8BF7\u6C42 \u5FAE\u4FE1\u56FA\u5B9A\u7684\u5730\u5740\uFF0C\u5F97\u5230\u4E24\u4E2A access_token \u548C openid</span>
      <span class="token class-name">String</span> baseAccessTokenUrl <span class="token operator">=</span> <span class="token string">&quot;https://api.weixin.qq.com/sns/oauth2/access_token&quot;</span><span class="token operator">+</span>
            <span class="token string">&quot;?appid=%s&quot;</span><span class="token operator">+</span>
            <span class="token string">&quot;&amp;secret=%s&quot;</span><span class="token operator">+</span>
            <span class="token string">&quot;&amp;code=%s&quot;</span><span class="token operator">+</span>
            <span class="token string">&quot;&amp;grant_type=authorization_code&quot;</span><span class="token punctuation">;</span>

      <span class="token comment">//\u62FC\u63A5\u4E09\u4E2A\u53C2\u6570\uFF1Aid \u79D8\u94A5 \u548C code \u503C</span>
      <span class="token class-name">String</span> accessTokenUrl <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
            baseAccessTokenUrl<span class="token punctuation">,</span>
            <span class="token class-name">ConstantWxUtils</span><span class="token punctuation">.</span>WX_OPEN_APP_ID<span class="token punctuation">,</span>
            <span class="token class-name">ConstantWxUtils</span><span class="token punctuation">.</span>WX_OPEN_APP_SECRET<span class="token punctuation">,</span>
            code
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">String</span> accessTokenInfo <span class="token operator">=</span> <span class="token class-name">HttpClientUtils</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>accessTokenUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">R</span> r <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">weixinLogin</span><span class="token punctuation">(</span>accessTokenInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token class-name">MemberResponseVo</span> data <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberResponseVo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u767B\u5F55\u6210\u529F\uFF1A\u7528\u6237\u4FE1\u606F\uFF1A{}&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">//1\u3001\u7B2C\u4E00\u6B21\u4F7F\u7528session\uFF0C\u547D\u4EE4\u6D4F\u89C8\u5668\u4FDD\u5B58\u5361\u53F7\uFF0CJSESSIONID\u8FD9\u4E2Acookie</span>
         <span class="token comment">//\u4EE5\u540E\u6D4F\u89C8\u5668\u8BBF\u95EE\u54EA\u4E2A\u7F51\u7AD9\u5C31\u4F1A\u5E26\u4E0A\u8FD9\u4E2A\u7F51\u7AD9\u7684cookie</span>
         <span class="token comment">//TODO 1\u3001\u9ED8\u8BA4\u53D1\u7684\u4EE4\u724C\u3002\u5F53\u524D\u57DF\uFF08\u89E3\u51B3\u5B50\u57DFsession\u5171\u4EAB\u95EE\u9898\uFF09</span>
         <span class="token comment">//TODO 2\u3001\u4F7F\u7528JSON\u7684\u5E8F\u5217\u5316\u65B9\u5F0F\u6765\u5E8F\u5217\u5316\u5BF9\u8C61\u5230Redis\u4E2D</span>
         session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>LOGIN_USER<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">//2\u3001\u767B\u5F55\u6210\u529F\u8DF3\u56DE\u9996\u9875</span>
         <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://yumall.com&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>

         <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.yumall.com/login.html&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

   <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.yumall.com/login.html&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * \u751F\u6210\u5FAE\u4FE1\u626B\u63CF\u4E8C\u7EF4\u7801
 *
 * <span class="token keyword">@return</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">UnsupportedEncodingException</span></span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getWxCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span><span class="token punctuation">{</span>

   <span class="token comment">//\u5FAE\u4FE1\u5F00\u53D1\u5E73\u53F0\u6388\u6743baseUrl   %s\u76F8\u5F53\u4E8E\uFF1F\u8868\u793A\u5360\u4F4D\u7B26</span>
   <span class="token class-name">String</span> baseUrl <span class="token operator">=</span> <span class="token string">&quot;https://open.weixin.qq.com/connect/qrconnect&quot;</span><span class="token operator">+</span>
         <span class="token string">&quot;?appid=%s&quot;</span><span class="token operator">+</span>
         <span class="token string">&quot;&amp;redirect_uri=%s&quot;</span><span class="token operator">+</span>
         <span class="token string">&quot;&amp;response_type=code&quot;</span><span class="token operator">+</span>
         <span class="token string">&quot;&amp;scope=snsapi_login&quot;</span><span class="token operator">+</span>
         <span class="token string">&quot;&amp;state=%s&quot;</span><span class="token operator">+</span>
         <span class="token string">&quot;#wechat_redirect&quot;</span><span class="token punctuation">;</span>

   <span class="token comment">//\u5BF9redirect_url\u8FDB\u884CURLEncoder\u7F16\u7801</span>
   <span class="token class-name">String</span> redirect_url <span class="token operator">=</span> <span class="token class-name">ConstantWxUtils</span><span class="token punctuation">.</span>WX_OPEN_REDIRECT_URL<span class="token punctuation">;</span>
   redirect_url <span class="token operator">=</span> <span class="token class-name">URLEncoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>redirect_url<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// \u9632\u6B62csrf\u653B\u51FB\uFF08\u8DE8\u7AD9\u8BF7\u6C42\u4F2A\u9020\u653B\u51FB\uFF09</span>
   <span class="token comment">// \u4E00\u822C\u60C5\u51B5\u4E0B\u4F1A\u4F7F\u7528\u4E00\u4E2A\u968F\u673A\u6570</span>
   <span class="token comment">//String state = UUID.randomUUID().toString().replaceAll(&quot;-&quot;, &quot;&quot;);</span>

   <span class="token comment">//\u4E3A\u4E86\u8BA9\u5927\u5BB6\u80FD\u591F\u4F7F\u7528\u6211\u642D\u5EFA\u7684\u5916\u7F51\u7684\u5FAE\u4FE1\u56DE\u8C03\u8DF3\u8F6C\u670D\u52A1\u5668\uFF0C\u8FD9\u91CC\u586B\u5199\u4F60\u5728 ngrok \u7684\u524D\u7F6E\u57DF\u540D</span>
   <span class="token class-name">String</span> state <span class="token operator">=</span> <span class="token string">&quot;hjl.mynatapp.cc&quot;</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;state = &quot;</span><span class="token operator">+</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// \u91C7\u7528redis\u7B49\u8FDB\u884C\u7F13\u5B58state \u4F7F\u7528sessionId\u4E3Akey 30\u5206\u949F\u540E\u8FC7\u671F\uFF0C\u53EF\u914D\u7F6E</span>
   <span class="token comment">//\u952E\uFF1A &quot;wechar-open-state-&quot; + httpServletRequest.getSession().getId()</span>
   <span class="token comment">//\u503C\uFF1A satte</span>
   <span class="token comment">//\u8FC7\u671F\u65F6\u95F4\uFF1A 30\u5206\u949F</span>
   <span class="token comment">//\u751F\u6210qrcodeUrl</span>

   <span class="token comment">//\u8BBE\u7F6E%s\u4E2D\u7684\u503C</span>
   <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
         baseUrl<span class="token punctuation">,</span>
         <span class="token class-name">ConstantWxUtils</span><span class="token punctuation">.</span>WX_OPEN_APP_ID<span class="token punctuation">,</span>
         redirect_url<span class="token punctuation">,</span>
         <span class="token string">&quot;kong&quot;</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//\u91CD\u5B9A\u5411\u5230\u8BF7\u6C42\u5FAE\u4FE1\u5730\u5740</span>
   <span class="token keyword">return</span> <span class="token string">&quot;redirect:&quot;</span><span class="token operator">+</span>url<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u8FDC\u7A0B\u8C03\u7528" tabindex="-1"><a class="header-anchor" href="#\u8FDC\u7A0B\u8C03\u7528" aria-hidden="true">#</a> \u8FDC\u7A0B\u8C03\u7528</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/member/member/weixin/login&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">R</span> <span class="token function">weixinLogin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;accessTokenInfo&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> accessTokenInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u4F1A\u5458\u670D\u52A1\u5B9E\u73B0\u5FAE\u4FE1\u767B\u5F55" tabindex="-1"><a class="header-anchor" href="#\u4F1A\u5458\u670D\u52A1\u5B9E\u73B0\u5FAE\u4FE1\u767B\u5F55" aria-hidden="true">#</a> \u4F1A\u5458\u670D\u52A1\u5B9E\u73B0\u5FAE\u4FE1\u767B\u5F55</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u5FAE\u4FE1\u767B\u5F55
 *
 * <span class="token keyword">@param</span> <span class="token parameter">accessTokenInfo</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/weixin/login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">weixinLogin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;accessTokenInfo&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> accessTokenInfo<span class="token punctuation">)</span><span class="token punctuation">{</span>

   <span class="token class-name">MemberEntity</span> memberEntity <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>accessTokenInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>memberEntity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>memberEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span>LOGINACCT_PASSWORD_EXCEPTION<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span>LOGINACCT_PASSWORD_EXCEPTION<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u5FAE\u4FE1\u767B\u5F55
 *
 * <span class="token keyword">@param</span> <span class="token parameter">accessTokenInfo</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">MemberEntity</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> accessTokenInfo<span class="token punctuation">)</span><span class="token punctuation">{</span>

   <span class="token comment">//\u4ECEaccessTokenInfo\u4E2D\u83B7\u53D6\u51FA\u6765\u4E24\u4E2A\u503C access_token \u548C oppenid</span>
   <span class="token comment">//\u628AaccessTokenInfo\u5B57\u7B26\u4E32\u8F6C\u6362\u6210map\u96C6\u5408\uFF0C\u6839\u636Emap\u91CC\u9762\u4E2D\u7684key\u53D6\u51FA\u76F8\u5BF9\u5E94\u7684value</span>
   <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">HashMap</span> accessMap <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>accessTokenInfo<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> accessToken <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> accessMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;access_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> openid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> accessMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;openid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//3\u3001\u62FF\u5230access_token \u548C oppenid\uFF0C\u518D\u53BB\u8BF7\u6C42\u5FAE\u4FE1\u63D0\u4F9B\u56FA\u5B9A\u7684API\uFF0C\u83B7\u53D6\u5230\u626B\u7801\u4EBA\u7684\u4FE1\u606F</span>
   <span class="token comment">//TODO \u67E5\u8BE2\u6570\u636E\u5E93\u5F53\u524D\u7528\u7528\u6237\u662F\u5426\u66FE\u7ECF\u4F7F\u7528\u8FC7\u5FAE\u4FE1\u767B\u5F55</span>

   <span class="token class-name">MemberEntity</span> memberEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;social_uid&quot;</span><span class="token punctuation">,</span> openid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span><span class="token punctuation">(</span>memberEntity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\u65B0\u7528\u6237\u6CE8\u518C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u8BBF\u95EE\u5FAE\u4FE1\u7684\u8D44\u6E90\u670D\u52A1\u5668\uFF0C\u83B7\u53D6\u7528\u6237\u4FE1\u606F</span>
      <span class="token class-name">String</span> baseUserInfoUrl <span class="token operator">=</span> <span class="token string">&quot;https://api.weixin.qq.com/sns/userinfo&quot;</span><span class="token operator">+</span>
            <span class="token string">&quot;?access_token=%s&quot;</span><span class="token operator">+</span>
            <span class="token string">&quot;&amp;openid=%s&quot;</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> userInfoUrl <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>baseUserInfoUrl<span class="token punctuation">,</span> accessToken<span class="token punctuation">,</span> openid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u53D1\u9001\u8BF7\u6C42</span>
      <span class="token class-name">String</span> resultUserInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span><span class="token punctuation">{</span>
         resultUserInfo <span class="token operator">=</span> <span class="token class-name">HttpClientUtils</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userInfoUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;resultUserInfo==========&quot;</span><span class="token operator">+</span>resultUserInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
         e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">//\u89E3\u6790json</span>
      <span class="token class-name">HashMap</span> userInfoMap <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>resultUserInfo<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u6635\u79F0</span>
      <span class="token class-name">String</span> nickName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> userInfoMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;nickname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u6027\u522B</span>
      <span class="token class-name">Double</span> sex <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">)</span> userInfoMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u5FAE\u4FE1\u5934\u50CF</span>
      <span class="token class-name">String</span> headimgurl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> userInfoMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;headimgurl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//\u628A\u626B\u7801\u4EBA\u7684\u4FE1\u606F\u6DFB\u52A0\u5230\u6570\u636E\u5E93\u4E2D</span>
      memberEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      memberEntity<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>nickName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      memberEntity<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>sex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      memberEntity<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>headimgurl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      memberEntity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      memberEntity<span class="token punctuation">.</span><span class="token function">setSocialUid</span><span class="token punctuation">(</span>openid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// register.setExpiresIn(socialUser.getExpires_in());</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>memberEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> memberEntity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3\u3001\u8FDC\u7A0B-\u793E\u4EA4\u7528\u6237\u7684\u767B\u5F55-\u5FAE\u535A" tabindex="-1"><a class="header-anchor" href="#_6-3\u3001\u8FDC\u7A0B-\u793E\u4EA4\u7528\u6237\u7684\u767B\u5F55-\u5FAE\u535A" aria-hidden="true">#</a> 6.3\u3001\u8FDC\u7A0B-\u793E\u4EA4\u7528\u6237\u7684\u767B\u5F55\uFF08\u5FAE\u535A\uFF09</h3><h4 id="\u51C6\u5907" tabindex="-1"><a class="header-anchor" href="#\u51C6\u5907" aria-hidden="true">#</a> \u51C6\u5907</h4><p>https://open.weibo.com/connect</p><h4 id="\u6D41\u7A0B-\u8DF3\u8F6C\u5FAE\u535A\u767B\u5F55-\u6210\u529F\u83B7\u53D6code-\u62FFcode\u6362\u53D6access-token-code\u53EA\u80FD\u7528\u4E00\u6B21-\u4F7F\u7528\u83B7\u5F97\u7684access-token\u8C03\u7528api" tabindex="-1"><a class="header-anchor" href="#\u6D41\u7A0B-\u8DF3\u8F6C\u5FAE\u535A\u767B\u5F55-\u6210\u529F\u83B7\u53D6code-\u62FFcode\u6362\u53D6access-token-code\u53EA\u80FD\u7528\u4E00\u6B21-\u4F7F\u7528\u83B7\u5F97\u7684access-token\u8C03\u7528api" aria-hidden="true">#</a> \u6D41\u7A0B\uFF1A\u8DF3\u8F6C\u5FAE\u535A\u767B\u5F55-&gt;\u6210\u529F\u83B7\u53D6code-&gt;\u62FFcode\u6362\u53D6Access token(code\u53EA\u80FD\u7528\u4E00\u6B21) -&gt;\u4F7F\u7528\u83B7\u5F97\u7684Access Token\u8C03\u7528API</h4><p>web</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;a href=&quot;https://api.weibo.com/oauth2/authorize?client_id=2077705774&amp;response_type=code&amp;redirect_uri=http://auth.yumall.com/oauth2.0/weibo/success&quot;&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="controller-1" tabindex="-1"><a class="header-anchor" href="#controller-1" aria-hidden="true">#</a> controller</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/oauth2.0/weibo/success&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">weibo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>

   <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>SD
   map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;client_id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2077705774&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;client_secret&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;40af02bd1c7e435ba6a6e9cd3bf799fd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;grant_type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;authorization_code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;redirect_uri&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://auth.yumall.com/oauth2.0/weibo/success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//1\u3001\u6839\u636E\u7528\u6237\u6388\u6743\u8FD4\u56DE\u7684code\u6362\u53D6access_token</span>
   <span class="token class-name">HttpResponse</span> response <span class="token operator">=</span> <span class="token class-name">HttpUtils</span><span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span><span class="token string">&quot;https://api.weibo.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/oauth2/access_token&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//2\u3001\u5904\u7406</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u83B7\u53D6\u5230\u4E86access_token,\u8F6C\u4E3A\u901A\u7528\u793E\u4EA4\u767B\u5F55\u5BF9\u8C61</span>
      <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">SocialUser</span> socialUser <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">SocialUser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//\u77E5\u9053\u4E86\u54EA\u4E2A\u793E\u4EA4\u7528\u6237</span>
      <span class="token comment">//1\uFF09\u3001\u5F53\u524D\u7528\u6237\u5982\u679C\u662F\u7B2C\u4E00\u6B21\u8FDB\u7F51\u7AD9\uFF0C\u81EA\u52A8\u6CE8\u518C\u8FDB\u6765\uFF08\u4E3A\u5F53\u524D\u793E\u4EA4\u7528\u6237\u751F\u6210\u4E00\u4E2A\u4F1A\u5458\u4FE1\u606F\uFF0C\u4EE5\u540E\u8FD9\u4E2A\u793E\u4EA4\u8D26\u53F7\u5C31\u5BF9\u5E94\u6307\u5B9A\u7684\u4F1A\u5458\uFF09</span>
      <span class="token comment">//\u767B\u5F55\u6216\u8005\u6CE8\u518C\u8FD9\u4E2A\u793E\u4EA4\u7528\u6237</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>socialUser<span class="token punctuation">.</span><span class="token function">getAccess_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u8C03\u7528\u8FDC\u7A0B\u670D\u52A1</span>
      <span class="token class-name">R</span> oauthLogin <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">oauthLogin</span><span class="token punctuation">(</span>socialUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>oauthLogin<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token class-name">MemberResponseVo</span> data <span class="token operator">=</span> oauthLogin<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberResponseVo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u767B\u5F55\u6210\u529F\uFF1A\u7528\u6237\u4FE1\u606F\uFF1A{}&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">//1\u3001\u7B2C\u4E00\u6B21\u4F7F\u7528session\uFF0C\u547D\u4EE4\u6D4F\u89C8\u5668\u4FDD\u5B58\u5361\u53F7\uFF0CJSESSIONID\u8FD9\u4E2Acookie</span>
         <span class="token comment">//\u4EE5\u540E\u6D4F\u89C8\u5668\u8BBF\u95EE\u54EA\u4E2A\u7F51\u7AD9\u5C31\u4F1A\u5E26\u4E0A\u8FD9\u4E2A\u7F51\u7AD9\u7684cookie</span>
         <span class="token comment">//TODO 1\u3001\u9ED8\u8BA4\u53D1\u7684\u4EE4\u724C\u3002\u5F53\u524D\u57DF\uFF08\u89E3\u51B3\u5B50\u57DFsession\u5171\u4EAB\u95EE\u9898\uFF09</span>
         <span class="token comment">//TODO 2\u3001\u4F7F\u7528JSON\u7684\u5E8F\u5217\u5316\u65B9\u5F0F\u6765\u5E8F\u5217\u5316\u5BF9\u8C61\u5230Redis\u4E2D</span>
         session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>LOGIN_USER<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">//2\u3001\u767B\u5F55\u6210\u529F\u8DF3\u56DE\u9996\u9875</span>
         <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://yumall.com&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>

         <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.yumall.com/login.html&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.yumall.com/login.html&quot;</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u8FDC\u7A0B\u8C03\u7528-1" tabindex="-1"><a class="header-anchor" href="#\u8FDC\u7A0B\u8C03\u7528-1" aria-hidden="true">#</a> \u8FDC\u7A0B\u8C03\u7528</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/member/member/oauth2/login&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">R</span> <span class="token function">oauthLogin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SocialUser</span> socialUser<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="\u4F1A\u5458\u670D\u52A1\u5B9E\u73B0\u5FAE\u535A\u767B\u5F55" tabindex="-1"><a class="header-anchor" href="#\u4F1A\u5458\u670D\u52A1\u5B9E\u73B0\u5FAE\u535A\u767B\u5F55" aria-hidden="true">#</a> \u4F1A\u5458\u670D\u52A1\u5B9E\u73B0\u5FAE\u535A\u767B\u5F55</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u5FAE\u535A\u8BA4\u8BC1
 *
 * <span class="token keyword">@param</span> <span class="token parameter">socialUser</span>
 * <span class="token keyword">@return</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/oauth2/login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">oauthLogin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SocialUser</span> socialUser<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
   <span class="token class-name">MemberEntity</span> memberEntity <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>socialUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>memberEntity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>memberEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span>LOGINACCT_PASSWORD_EXCEPTION<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span>LOGINACCT_PASSWORD_EXCEPTION<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u4E2A\u7528\u6237\u5DF2\u7ECF\u6CE8\u518C\u8FC7,\u66F4\u65B0\u7528\u6237\u7684\u8BBF\u95EE\u4EE4\u724C\u7684\u65F6\u95F4\u548Caccess_token\u3002</p><p>\u6CA1\u6709\u67E5\u5230\u5F53\u524D\u793E\u4EA4\u7528\u6237\u5BF9\u5E94\u7684\u8BB0\u5F55\u6211\u4EEC\u5C31\u9700\u8981\u6CE8\u518C\u4E00\u4E2A,\u67E5\u8BE2\u5F53\u524D\u793E\u4EA4\u7528\u6237\u7684\u793E\u4EA4\u8D26\u53F7\u4FE1\u606F\uFF08\u6635\u79F0\u3001\u6027\u522B\u7B49\uFF09\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u793E\u4EA4\u7528\u6237\u7684\u767B\u5F55 \u5FAE\u535A
 *
 * <span class="token keyword">@param</span> <span class="token parameter">socialUser</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">MemberEntity</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">SocialUser</span> socialUser<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
   <span class="token comment">//\u5177\u6709\u767B\u5F55\u548C\u6CE8\u518C\u903B\u8F91</span>
   <span class="token class-name">String</span> uid <span class="token operator">=</span> socialUser<span class="token punctuation">.</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//1\u3001\u5224\u65AD\u5F53\u524D\u793E\u4EA4\u7528\u6237\u662F\u5426\u5DF2\u7ECF\u767B\u5F55\u8FC7\u7CFB\u7EDF</span>
   <span class="token class-name">MemberEntity</span> memberEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;social_uid&quot;</span><span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span><span class="token punctuation">(</span>memberEntity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u8FD9\u4E2A\u7528\u6237\u5DF2\u7ECF\u6CE8\u518C\u8FC7</span>
      <span class="token comment">//\u66F4\u65B0\u7528\u6237\u7684\u8BBF\u95EE\u4EE4\u724C\u7684\u65F6\u95F4\u548Caccess_token</span>
      <span class="token class-name">MemberEntity</span> update <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      update<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>memberEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      update<span class="token punctuation">.</span><span class="token function">setAccessToken</span><span class="token punctuation">(</span>socialUser<span class="token punctuation">.</span><span class="token function">getAccess_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      update<span class="token punctuation">.</span><span class="token function">setExpiresIn</span><span class="token punctuation">(</span>socialUser<span class="token punctuation">.</span><span class="token function">getExpires_in</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>

      memberEntity<span class="token punctuation">.</span><span class="token function">setAccessToken</span><span class="token punctuation">(</span>socialUser<span class="token punctuation">.</span><span class="token function">getAccess_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      memberEntity<span class="token punctuation">.</span><span class="token function">setExpiresIn</span><span class="token punctuation">(</span>socialUser<span class="token punctuation">.</span><span class="token function">getExpires_in</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> memberEntity<span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">//2\u3001\u6CA1\u6709\u67E5\u5230\u5F53\u524D\u793E\u4EA4\u7528\u6237\u5BF9\u5E94\u7684\u8BB0\u5F55\u6211\u4EEC\u5C31\u9700\u8981\u6CE8\u518C\u4E00\u4E2A</span>
      <span class="token class-name">MemberEntity</span> register <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//3\u3001\u67E5\u8BE2\u5F53\u524D\u793E\u4EA4\u7528\u6237\u7684\u793E\u4EA4\u8D26\u53F7\u4FE1\u606F\uFF08\u6635\u79F0\u3001\u6027\u522B\u7B49\uFF09</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      query<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;access_token&quot;</span><span class="token punctuation">,</span> socialUser<span class="token punctuation">.</span><span class="token function">getAccess_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      query<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;uid&quot;</span><span class="token punctuation">,</span> socialUser<span class="token punctuation">.</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">HttpResponse</span> response <span class="token operator">=</span> <span class="token class-name">HttpUtils</span><span class="token punctuation">.</span><span class="token function">doGet</span><span class="token punctuation">(</span><span class="token string">&quot;https://api.weibo.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/2/users/show.json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token comment">//\u67E5\u8BE2\u6210\u529F</span>
         <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">String</span> name <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">String</span> gender <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">String</span> profileImageUrl <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;profile_image_url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         register<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
         register<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span><span class="token string">&quot;m&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>gender<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         register<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>profileImageUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
         register<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         register<span class="token punctuation">.</span><span class="token function">setSocialUid</span><span class="token punctuation">(</span>socialUser<span class="token punctuation">.</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         register<span class="token punctuation">.</span><span class="token function">setAccessToken</span><span class="token punctuation">(</span>socialUser<span class="token punctuation">.</span><span class="token function">getAccess_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         register<span class="token punctuation">.</span><span class="token function">setExpiresIn</span><span class="token punctuation">(</span>socialUser<span class="token punctuation">.</span><span class="token function">getExpires_in</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">//\u628A\u7528\u6237\u4FE1\u606F\u63D2\u5165\u5230\u6570\u636E\u5E93\u4E2D</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>register<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> register<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7\u3001\u5206\u5E03\u5F0F-session" tabindex="-1"><a class="header-anchor" href="#_7\u3001\u5206\u5E03\u5F0F-session" aria-hidden="true">#</a> 7\u3001\u5206\u5E03\u5F0F session</h2><h2 id="_8\u3001\u5355\u70B9\u767B\u5F55-\u591A\u7CFB\u7EDF" tabindex="-1"><a class="header-anchor" href="#_8\u3001\u5355\u70B9\u767B\u5F55-\u591A\u7CFB\u7EDF" aria-hidden="true">#</a> 8\u3001\u5355\u70B9\u767B\u5F55\uFF1A\u591A\u7CFB\u7EDF</h2><h3 id="_8-1\u3001\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#_8-1\u3001\u5206\u6790" aria-hidden="true">#</a> 8.1\u3001\u5206\u6790</h3><p><img src="`+m+`" alt="image-20210926173348217"></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>127.0.0.1 ssoserver.com
127.0.0.1 client1.com
127.0.0.1 client2.com

http://ssoserver:45001/employees 

	- &gt; \u672A\u767B\u5F55,\u8DF3\u8F6C\u5230\u767B\u5F55\u670D\u52A1\uFF1A&quot;redirect:http://ssoserver.com:45000/login.html?redirect_url=http://client1.com:45001/employees&quot;;
	
	- &gt; \u767B\u5F55\u6210\u529F\u540E\u8DF3\u8F6C\u5230\uFF1Ahttp://client1.com:45001/employees?token=c2360a53-8a42-4896-b642-659a817c7903
	http://ssoserver.com:45000/login.html?redirect_url=http://client2.com:45002/boos
	
	- &gt; \u67E5\u770B\u767B\u5F55\u4FE1\u606F\uFF1Ahttp://ssoserver.com:45000/userinfo?token=c2360a53-8a42-4896-b642-659a817c7903

\u767B\u5F55client1\uFF0C\u8BBF\u95EEclient2\uFF08\u4E0D\u7528\u767B\u5F55\u4E86\uFF09\uFF0C

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u5341\u4E94\u3001\u8D2D\u7269\u8F66-cart" tabindex="-1"><a class="header-anchor" href="#\u5341\u4E94\u3001\u8D2D\u7269\u8F66-cart" aria-hidden="true">#</a> \u5341\u4E94\u3001\u8D2D\u7269\u8F66 cart</h1><h2 id="_1\u3001\u8D2D\u7269\u8F66\u9879\u76EE-cart-\u51C6\u5907config-web\u3001nginx\u3001nacos\u3001redis" tabindex="-1"><a class="header-anchor" href="#_1\u3001\u8D2D\u7269\u8F66\u9879\u76EE-cart-\u51C6\u5907config-web\u3001nginx\u3001nacos\u3001redis" aria-hidden="true">#</a> 1\u3001\u8D2D\u7269\u8F66\u9879\u76EE cart \u51C6\u5907config\uFF0Cweb\u3001nginx\u3001nacos\u3001redis</h2><p>\u4E0D\u9700\u8981SQL\u6570\u636E\u6E90\u3001\u5F00\u542FFeign\u3001nacos\u3001redis-session\u3001Thread</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>config<span class="token operator">:</span>
    <span class="token class-name">CartSentinelConfig</span>
    <span class="token class-name">MyThreadConfig</span>
    <span class="token class-name">SessionConfig</span>
    <span class="token class-name">ThreadPoolConfigProperties</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2\u3001\u5206\u6790\u3001vo\u6A21\u578B" tabindex="-1"><a class="header-anchor" href="#_2\u3001\u5206\u6790\u3001vo\u6A21\u578B" aria-hidden="true">#</a> 2\u3001\u5206\u6790\u3001Vo\u6A21\u578B</h2><p>CartItemVo CartVo SkuInfoVo</p><h2 id="_3\u3001\u53BB\u8D2D\u7269\u8F66\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_3\u3001\u53BB\u8D2D\u7269\u8F66\u9875\u9762" aria-hidden="true">#</a> 3\u3001\u53BB\u8D2D\u7269\u8F66\u9875\u9762</h2><h3 id="web\u62E6\u622A\u5668-\u5728\u6267\u884C\u76EE\u6807\u65B9\u6CD5\u4E4B\u524D-\u5224\u65AD\u7528\u6237\u7684\u767B\u5F55\u72B6\u6001-\u5E76\u5C01\u88C5\u4F20\u9012\u7ED9controller\u76EE\u6807\u8BF7\u6C42-\u4E1A\u52A1\u6267\u884C\u4E4B\u540E-\u5206\u914D\u4E34\u65F6\u7528\u6237\u6765\u6D4F\u89C8\u5668\u4FDD\u5B58" tabindex="-1"><a class="header-anchor" href="#web\u62E6\u622A\u5668-\u5728\u6267\u884C\u76EE\u6807\u65B9\u6CD5\u4E4B\u524D-\u5224\u65AD\u7528\u6237\u7684\u767B\u5F55\u72B6\u6001-\u5E76\u5C01\u88C5\u4F20\u9012\u7ED9controller\u76EE\u6807\u8BF7\u6C42-\u4E1A\u52A1\u6267\u884C\u4E4B\u540E-\u5206\u914D\u4E34\u65F6\u7528\u6237\u6765\u6D4F\u89C8\u5668\u4FDD\u5B58" aria-hidden="true">#</a> web\u62E6\u622A\u5668,\u5728\u6267\u884C\u76EE\u6807\u65B9\u6CD5\u4E4B\u524D\uFF0C\u5224\u65AD\u7528\u6237\u7684\u767B\u5F55\u72B6\u6001.\u5E76\u5C01\u88C5\u4F20\u9012\u7ED9controller\u76EE\u6807\u8BF7\u6C42\uFF0C\u4E1A\u52A1\u6267\u884C\u4E4B\u540E\uFF0C\u5206\u914D\u4E34\u65F6\u7528\u6237\u6765\u6D4F\u89C8\u5668\u4FDD\u5B58</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u6CE8\u518C\u62E6\u622A\u5668</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CartInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u5728\u6267\u884C\u76EE\u6807\u65B9\u6CD5\u4E4B\u524D\uFF0C\u5224\u65AD\u7528\u6237\u7684\u767B\u5F55\u72B6\u6001.\u5E76\u5C01\u88C5\u4F20\u9012\u7ED9controller\u76EE\u6807\u8BF7\u6C42
 * <span class="token keyword">@author</span> kong
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfoTo</span><span class="token punctuation">&gt;</span></span> toThreadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/***
     * \u76EE\u6807\u65B9\u6CD5\u6267\u884C\u4E4B\u524D
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfoTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u83B7\u5F97\u5F53\u524D\u767B\u5F55\u7528\u6237\u7684\u4FE1\u606F</span>
        <span class="token class-name">MemberResponseVo</span> memberResponseVo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MemberResponseVo</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>LOGIN_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>memberResponseVo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u7528\u6237\u767B\u5F55\u4E86</span>
            userInfoTo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>memberResponseVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Cookie</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookies <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cookies <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cookies<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Cookie</span> cookie <span class="token operator">:</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//user-key</span>
                <span class="token class-name">String</span> name <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TEMP_USER_COOKIE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    userInfoTo<span class="token punctuation">.</span><span class="token function">setUserKey</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//\u6807\u8BB0\u4E3A\u5DF2\u662F\u4E34\u65F6\u7528\u6237</span>
                    userInfoTo<span class="token punctuation">.</span><span class="token function">setTempUser</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//\u5982\u679C\u6CA1\u6709\u4E34\u65F6\u7528\u6237\u4E00\u5B9A\u5206\u914D\u4E00\u4E2A\u4E34\u65F6\u7528\u6237</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            userInfoTo<span class="token punctuation">.</span><span class="token function">setUserKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//\u76EE\u6807\u65B9\u6CD5\u6267\u884C\u4E4B\u524D</span>
        toThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userInfoTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u4E1A\u52A1\u6267\u884C\u4E4B\u540E\uFF0C\u5206\u914D\u4E34\u65F6\u7528\u6237\u6765\u6D4F\u89C8\u5668\u4FDD\u5B58
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u83B7\u53D6\u5F53\u524D\u7528\u6237\u7684\u503C</span>
        <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> toThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u5982\u679C\u6CA1\u6709\u4E34\u65F6\u7528\u6237\u4E00\u5B9A\u4FDD\u5B58\u4E00\u4E2A\u4E34\u65F6\u7528\u6237</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getTempUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u521B\u5EFA\u4E00\u4E2Acookie</span>
            <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span>TEMP_USER_COOKIE_NAME<span class="token punctuation">,</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u6269\u5927\u4F5C\u7528\u57DF</span>
            cookie<span class="token punctuation">.</span><span class="token function">setDomain</span><span class="token punctuation">(</span><span class="token string">&quot;yumall.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4</span>
            cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span>TEMP_USER_COOKIE_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1\u3001\u9996\u9875" tabindex="-1"><a class="header-anchor" href="#_3-1\u3001\u9996\u9875" aria-hidden="true">#</a> 3.1\u3001\u9996\u9875</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>	<span class="token doc-comment comment">/**
	 * \u53BB\u8D2D\u7269\u8F66\u9875\u9762\u7684\u8BF7\u6C42
	 * \u6D4F\u89C8\u5668\u6709\u4E00\u4E2Acookie:user-key \u6807\u8BC6\u7528\u6237\u7684\u8EAB\u4EFD\uFF0C\u4E00\u4E2A\u6708\u8FC7\u671F
	 * \u5982\u679C\u7B2C\u4E00\u6B21\u4F7F\u7528jd\u7684\u8D2D\u7269\u8F66\u529F\u80FD\uFF0C\u90FD\u4F1A\u7ED9\u4E00\u4E2A\u4E34\u65F6\u7684\u7528\u6237\u8EAB\u4EFD:
	 * \u6D4F\u89C8\u5668\u4EE5\u540E\u4FDD\u5B58\uFF0C\u6BCF\u6B21\u8BBF\u95EE\u90FD\u4F1A\u5E26\u4E0A\u8FD9\u4E2Acookie\uFF1B
	 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
	 * \u767B\u5F55\uFF1Asession\u6709
	 * \u6CA1\u767B\u5F55\uFF1A\u6309\u7167cookie\u91CC\u9762\u5E26\u6765user-key\u6765\u505A
	 * \u7B2C\u4E00\u6B21\uFF0C\u5982\u679C\u6CA1\u6709\u4E34\u65F6\u7528\u6237\uFF0C\u81EA\u52A8\u521B\u5EFA\u4E00\u4E2A\u4E34\u65F6\u7528\u6237
	 *
	 * <span class="token keyword">@return</span>
	 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/cart.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">cartListPage</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">CartVo</span> cartVo <span class="token operator">=</span> cartService<span class="token punctuation">.</span><span class="token function">getCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u83B7\u53D6\u7528\u6237\u767B\u5F55\u6216\u8005\u672A\u767B\u5F55\u8D2D\u7269\u8F66\u91CC\u6240\u6709\u7684\u6570\u636E</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;cart&quot;</span><span class="token punctuation">,</span>cartVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;cartList&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-\u83B7\u53D6\u8D2D\u7269\u8F66\u91CC\u9762\u7684\u4FE1\u606F-\u83B7\u53D6\u7528\u6237\u767B\u5F55\u6216\u8005\u672A\u767B\u5F55\u8D2D\u7269\u8F66\u91CC\u6240\u6709\u7684\u6570\u636E" tabindex="-1"><a class="header-anchor" href="#_3-2-\u83B7\u53D6\u8D2D\u7269\u8F66\u91CC\u9762\u7684\u4FE1\u606F-\u83B7\u53D6\u7528\u6237\u767B\u5F55\u6216\u8005\u672A\u767B\u5F55\u8D2D\u7269\u8F66\u91CC\u6240\u6709\u7684\u6570\u636E" aria-hidden="true">#</a> 3.2 \u83B7\u53D6\u8D2D\u7269\u8F66\u91CC\u9762\u7684\u4FE1\u606F-\u83B7\u53D6\u7528\u6237\u767B\u5F55\u6216\u8005\u672A\u767B\u5F55\u8D2D\u7269\u8F66\u91CC\u6240\u6709\u7684\u6570\u636E</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">CartVo</span> <span class="token function">getCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">CartVo</span> cartVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CartVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token class-name">CartInterceptor</span><span class="token punctuation">.</span>toThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1\u3001\u767B\u5F55</span>
        <span class="token class-name">String</span> cartKey <span class="token operator">=</span> CART_PREFIX <span class="token operator">+</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u4E34\u65F6\u8D2D\u7269\u8F66\u7684\u952E</span>
        <span class="token class-name">String</span> temptCartKey <span class="token operator">=</span> CART_PREFIX <span class="token operator">+</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2\u3001\u5982\u679C\u4E34\u65F6\u8D2D\u7269\u8F66\u7684\u6570\u636E\u8FD8\u672A\u8FDB\u884C\u5408\u5E76</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> tempCartItems <span class="token operator">=</span> <span class="token function">getCartItems</span><span class="token punctuation">(</span>temptCartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tempCartItems <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u4E34\u65F6\u8D2D\u7269\u8F66\u6709\u6570\u636E\u9700\u8981\u8FDB\u884C\u5408\u5E76\u64CD\u4F5C</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartItemVo</span> item <span class="token operator">:</span> tempCartItems<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">addToCart</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>item<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//\u6E05\u9664\u4E34\u65F6\u8D2D\u7269\u8F66\u7684\u6570\u636E</span>
            <span class="token function">clearCartInfo</span><span class="token punctuation">(</span>temptCartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//3\u3001\u83B7\u53D6\u767B\u5F55\u540E\u7684\u8D2D\u7269\u8F66\u6570\u636E\u3010\u5305\u542B\u5408\u5E76\u8FC7\u6765\u7684\u4E34\u65F6\u8D2D\u7269\u8F66\u7684\u6570\u636E\u548C\u767B\u5F55\u540E\u8D2D\u7269\u8F66\u7684\u6570\u636E\u3011</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> cartItems <span class="token operator">=</span> <span class="token function">getCartItems</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartVo<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>cartItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u6CA1\u767B\u5F55</span>
        <span class="token class-name">String</span> cartKey <span class="token operator">=</span> CART_PREFIX <span class="token operator">+</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u83B7\u53D6\u4E34\u65F6\u8D2D\u7269\u8F66\u91CC\u9762\u7684\u6240\u6709\u8D2D\u7269\u9879</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> cartItems <span class="token operator">=</span> <span class="token function">getCartItems</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartVo<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>cartItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cartVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3\u3001\u83B7\u53D6\u8D2D\u7269\u8F66\u91CC\u9762\u7684\u6570\u636Egetcartitems\u3001\u5220\u9664" tabindex="-1"><a class="header-anchor" href="#_3-3\u3001\u83B7\u53D6\u8D2D\u7269\u8F66\u91CC\u9762\u7684\u6570\u636Egetcartitems\u3001\u5220\u9664" aria-hidden="true">#</a> 3.3\u3001\u83B7\u53D6\u8D2D\u7269\u8F66\u91CC\u9762\u7684\u6570\u636EgetCartItems\u3001\u5220\u9664</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCartItems</span><span class="token punctuation">(</span><span class="token class-name">String</span> cartKey<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//\u83B7\u53D6\u8D2D\u7269\u8F66\u91CC\u9762\u7684\u6240\u6709\u5546\u54C1</span>
   <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> operations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> values <span class="token operator">=</span> operations<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>values <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> values<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> values<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
         <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> obj<span class="token punctuation">;</span>
         <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token class-name">CartItemVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearCartInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> cartKey<span class="token punctuation">)</span><span class="token punctuation">{</span>
   redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4\u3001\u6DFB\u52A0\u5546\u54C1\u5230\u8D2D\u7269\u8F66" tabindex="-1"><a class="header-anchor" href="#_4\u3001\u6DFB\u52A0\u5546\u54C1\u5230\u8D2D\u7269\u8F66" aria-hidden="true">#</a> 4\u3001\u6DFB\u52A0\u5546\u54C1\u5230\u8D2D\u7269\u8F66</h2><h3 id="\u83B7\u53D6\u5230\u6211\u4EEC\u8981\u64CD\u4F5C\u7684\u8D2D\u7269\u8F66-\u662F\u54EA\u4E2A\u8D26\u53F7-getcartops" tabindex="-1"><a class="header-anchor" href="#\u83B7\u53D6\u5230\u6211\u4EEC\u8981\u64CD\u4F5C\u7684\u8D2D\u7269\u8F66-\u662F\u54EA\u4E2A\u8D26\u53F7-getcartops" aria-hidden="true">#</a> \u83B7\u53D6\u5230\u6211\u4EEC\u8981\u64CD\u4F5C\u7684\u8D2D\u7269\u8F66\uFF0C\u662F\u54EA\u4E2A\u8D26\u53F7 getCartOps</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//\u5148\u5F97\u5230\u5F53\u524D\u7528\u6237\u4FE1\u606F</span>
   <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token class-name">CartInterceptor</span><span class="token punctuation">.</span>toThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> cartKey <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//gulimall:cart:1</span>
      cartKey <span class="token operator">=</span> CART_PREFIX<span class="token operator">+</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      cartKey <span class="token operator">=</span> CART_PREFIX<span class="token operator">+</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">//\u7ED1\u5B9A\u6307\u5B9A\u7684key\u64CD\u4F5CRedis</span>
   <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-1\u3001\u6DFB\u52A0\u5546\u54C1\u5230\u8D2D\u7269\u8F66-addcartitem" tabindex="-1"><a class="header-anchor" href="#_4-1\u3001\u6DFB\u52A0\u5546\u54C1\u5230\u8D2D\u7269\u8F66-addcartitem" aria-hidden="true">#</a> 4.1\u3001\u6DFB\u52A0\u5546\u54C1\u5230\u8D2D\u7269\u8F66 addCartItem</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/addCartItem&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addCartItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">,</span>
                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">,</span>
                    <span class="token class-name">RedirectAttributes</span> attributes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
   cartService<span class="token punctuation">.</span><span class="token function">addToCart</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
   attributes<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">,</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://cart.yumall.com/addToCartSuccessPage.html&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">CartItemVo</span> <span class="token function">addToCart</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
   <span class="token comment">//\u62FF\u5230\u8981\u64CD\u4F5C\u7684\u8D2D\u7269\u8F66\u4FE1\u606F</span>
   <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cartOps <span class="token operator">=</span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//\u5224\u65ADRedis\u662F\u5426\u6709\u8BE5\u5546\u54C1\u7684\u4FE1\u606F</span>
   <span class="token class-name">String</span> productRedisValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> cartOps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//\u5982\u679C\u6CA1\u6709\u5C31\u6DFB\u52A0\u6570\u636E</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>productRedisValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//2\u3001\u6DFB\u52A0\u65B0\u7684\u5546\u54C1\u5230\u8D2D\u7269\u8F66(redis)</span>
      <span class="token class-name">CartItemVo</span> cartItemVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CartItemVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u5F00\u542F\u7B2C\u4E00\u4E2A\u5F02\u6B65\u4EFB\u52A1</span>
      <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> getSkuInfoFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
         <span class="token comment">//1\u3001\u8FDC\u7A0B\u67E5\u8BE2\u5F53\u524D\u8981\u6DFB\u52A0\u5546\u54C1\u7684\u4FE1\u606F</span>
         <span class="token class-name">R</span> productSkuInfo <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">SkuInfoVo</span> skuInfo <span class="token operator">=</span> productSkuInfo<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;skuInfo&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoVo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//\u6570\u636E\u8D4B\u503C\u64CD\u4F5C</span>
         cartItemVo<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>skuInfo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         cartItemVo<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>skuInfo<span class="token punctuation">.</span><span class="token function">getSkuTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         cartItemVo<span class="token punctuation">.</span><span class="token function">setImage</span><span class="token punctuation">(</span>skuInfo<span class="token punctuation">.</span><span class="token function">getSkuDefaultImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         cartItemVo<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>skuInfo<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         cartItemVo<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u5F00\u542F\u7B2C\u4E8C\u4E2A\u5F02\u6B65\u4EFB\u52A1</span>
      <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> getSkuAttrValuesFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
         <span class="token comment">//2\u3001\u8FDC\u7A0B\u67E5\u8BE2skuAttrValues\u7EC4\u5408\u4FE1\u606F</span>
         <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> skuSaleAttrValues <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">getSkuSaleAttrValues</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
         cartItemVo<span class="token punctuation">.</span><span class="token function">setSkuAttrValues</span><span class="token punctuation">(</span>skuSaleAttrValues<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u7B49\u5F85\u6240\u6709\u7684\u5F02\u6B65\u4EFB\u52A1\u5168\u90E8\u5B8C\u6210</span>
      <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>getSkuInfoFuture<span class="token punctuation">,</span> getSkuAttrValuesFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> cartItemJson <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>cartItemVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cartOps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cartItemJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> cartItemVo<span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">//\u8D2D\u7269\u8F66\u6709\u6B64\u5546\u54C1\uFF0C\u4FEE\u6539\u6570\u91CF\u5373\u53EF</span>
      <span class="token class-name">CartItemVo</span> cartItemVo <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>productRedisValue<span class="token punctuation">,</span> <span class="token class-name">CartItemVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cartItemVo<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>cartItemVo<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u4FEE\u6539redis\u7684\u6570\u636E</span>
      <span class="token class-name">String</span> cartItemJson <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>cartItemVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cartOps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cartItemJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> cartItemVo<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2\u3001\u8FDC\u7A0B\u67E5\u8BE2\u5F53\u524D\u8981\u6DFB\u52A0\u5546\u54C1\u7684\u4FE1\u606Fgetinfo-skuid-\u8FDC\u7A0B\u67E5\u8BE2skuattrvalues\u7EC4\u5408\u4FE1\u606Fgetskusaleattrvalues-skuid" tabindex="-1"><a class="header-anchor" href="#_4-2\u3001\u8FDC\u7A0B\u67E5\u8BE2\u5F53\u524D\u8981\u6DFB\u52A0\u5546\u54C1\u7684\u4FE1\u606Fgetinfo-skuid-\u8FDC\u7A0B\u67E5\u8BE2skuattrvalues\u7EC4\u5408\u4FE1\u606Fgetskusaleattrvalues-skuid" aria-hidden="true">#</a> 4.2\u3001\u8FDC\u7A0B\u67E5\u8BE2\u5F53\u524D\u8981\u6DFB\u52A0\u5546\u54C1\u7684\u4FE1\u606FgetInfo(skuId);\uFF0C\u8FDC\u7A0B\u67E5\u8BE2skuAttrValues\u7EC4\u5408\u4FE1\u606FgetSkuSaleAttrValues(skuId);</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ProductFeignService</span>\uFF1A
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/product/skusaleattrvalue/stringList/{skuId}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuSaleAttrValues</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u6839\u636EskuId\u67E5\u8BE2pms_sku_sale_attr_value\u8868\u4E2D\u7684\u4FE1\u606F
 *
 * <span class="token keyword">@param</span> <span class="token parameter">skuId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/stringList/{skuId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuSaleAttrValues</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> skuSaleAttrValueService<span class="token punctuation">.</span><span class="token function">getSkuSaleAttrValuesAsStringList</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

getSkuSaleAttrValuesAsStringList<span class="token operator">::</span><span class="token operator">::</span><span class="token operator">:</span>
        <span class="token class-name">SkuSaleAttrValueDao</span> baseMapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">;</span>
        <span class="token keyword">return</span> baseMapper<span class="token punctuation">.</span><span class="token function">getSkuSaleAttrValuesAsStringList</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5\u3001\u8DF3\u8F6C\u5230\u6DFB\u52A0\u8D2D\u7269\u8F66\u6210\u529F\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_5\u3001\u8DF3\u8F6C\u5230\u6DFB\u52A0\u8D2D\u7269\u8F66\u6210\u529F\u9875\u9762" aria-hidden="true">#</a> 5\u3001\u8DF3\u8F6C\u5230\u6DFB\u52A0\u8D2D\u7269\u8F66\u6210\u529F\u9875\u9762</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/addToCartSuccessPage.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addToCartSuccessPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//\u91CD\u5B9A\u5411\u5230\u6210\u529F\u9875\u9762\u3002\u518D\u6B21\u67E5\u8BE2\u8D2D\u7269\u8F66\u6570\u636E\u5373\u53EF</span>
   <span class="token class-name">CartItemVo</span> cartItemVo <span class="token operator">=</span> cartService<span class="token punctuation">.</span><span class="token function">getCartItem</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;cartItem&quot;</span><span class="token punctuation">,</span> cartItemVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CartItemVo</span> <span class="token function">getCartItem</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//\u62FF\u5230\u8981\u64CD\u4F5C\u7684\u8D2D\u7269\u8F66\u4FE1\u606F</span>
   <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cartOps <span class="token operator">=</span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> redisValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> cartOps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>redisValue<span class="token punctuation">,</span> <span class="token class-name">CartItemVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6\u3001\u5546\u54C1\u662F\u5426\u9009\u4E2D" tabindex="-1"><a class="header-anchor" href="#_6\u3001\u5546\u54C1\u662F\u5426\u9009\u4E2D" aria-hidden="true">#</a> 6\u3001\u5546\u54C1\u662F\u5426\u9009\u4E2D</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/checkItem&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">checkItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">,</span>
                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;checked&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> checked<span class="token punctuation">)</span><span class="token punctuation">{</span>
   cartService<span class="token punctuation">.</span><span class="token function">checkItem</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span> checked<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://cart.yumall.com/cart.html&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkItem</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> check<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//\u67E5\u8BE2\u8D2D\u7269\u8F66\u91CC\u9762\u7684\u5546\u54C1</span>
   <span class="token class-name">CartItemVo</span> cartItem <span class="token operator">=</span> <span class="token function">getCartItem</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//\u4FEE\u6539\u5546\u54C1\u72B6\u6001</span>
   cartItem<span class="token punctuation">.</span><span class="token function">setCheck</span><span class="token punctuation">(</span>check <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//\u5E8F\u5217\u5316\u5B58\u5165redis\u4E2D</span>
   <span class="token class-name">String</span> redisValue <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cartOps <span class="token operator">=</span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   cartOps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> redisValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7\u3001\u4FEE\u6539\u8D2D\u7269\u9879\u6570\u91CF" tabindex="-1"><a class="header-anchor" href="#_7\u3001\u4FEE\u6539\u8D2D\u7269\u9879\u6570\u91CF" aria-hidden="true">#</a> 7\u3001\u4FEE\u6539\u8D2D\u7269\u9879\u6570\u91CF</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/countItem&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">countItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">,</span>
                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>
   cartService<span class="token punctuation">.</span><span class="token function">changeItemCount</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://cart.yumall.com/cart.html&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeItemCount</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//\u67E5\u8BE2\u8D2D\u7269\u8F66\u91CC\u9762\u7684\u5546\u54C1</span>
   <span class="token class-name">CartItemVo</span> cartItem <span class="token operator">=</span> <span class="token function">getCartItem</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   cartItem<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cartOps <span class="token operator">=</span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//\u5E8F\u5217\u5316\u5B58\u5165redis\u4E2D</span>
   <span class="token class-name">String</span> redisValue <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
   cartOps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> redisValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8\u3001\u5220\u9664\u5546\u54C1\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#_8\u3001\u5220\u9664\u5546\u54C1\u4FE1\u606F" aria-hidden="true">#</a> 8\u3001\u5220\u9664\u5546\u54C1\u4FE1\u606F</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/deleteItem&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">deleteItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> skuId<span class="token punctuation">)</span><span class="token punctuation">{</span>
   cartService<span class="token punctuation">.</span><span class="token function">deleteIdCartInfo</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://cart.yumall.com/cart.html&quot;</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteIdCartInfo</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> skuId<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cartOps <span class="token operator">=</span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		cartOps<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9\u3001\u83B7\u53D6\u5F53\u524D\u7528\u6237\u7684\u8D2D\u7269\u8F66\u5546\u54C1\u9879" tabindex="-1"><a class="header-anchor" href="#_9\u3001\u83B7\u53D6\u5F53\u524D\u7528\u6237\u7684\u8D2D\u7269\u8F66\u5546\u54C1\u9879" aria-hidden="true">#</a> 9\u3001\u83B7\u53D6\u5F53\u524D\u7528\u6237\u7684\u8D2D\u7269\u8F66\u5546\u54C1\u9879</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/currentUserCartItems&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCurrentCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> cartService<span class="token punctuation">.</span><span class="token function">getUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> cartItemVoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//\u83B7\u53D6\u5F53\u524D\u7528\u6237\u767B\u5F55\u7684\u4FE1\u606F</span>
   <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token class-name">CartInterceptor</span><span class="token punctuation">.</span>toThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//\u5982\u679C\u7528\u6237\u672A\u767B\u5F55\u76F4\u63A5\u8FD4\u56DEnull</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">//\u83B7\u53D6\u8D2D\u7269\u8F66\u9879</span>
      <span class="token class-name">String</span> cartKey <span class="token operator">=</span> CART_PREFIX<span class="token operator">+</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u83B7\u53D6\u6240\u6709\u7684</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> cartItems <span class="token operator">=</span> <span class="token function">getCartItems</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>cartItems <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CartExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//\u7B5B\u9009\u51FA\u9009\u4E2D\u7684</span>
      cartItemVoList <span class="token operator">=</span> cartItems<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>items <span class="token operator">-&gt;</span> items<span class="token punctuation">.</span><span class="token function">getCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
               <span class="token comment">//\u66F4\u65B0\u4E3A\u6700\u65B0\u7684\u4EF7\u683C\uFF08\u67E5\u8BE2\u6570\u636E\u5E93\uFF09</span>
               <span class="token class-name">BigDecimal</span> price <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               item<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span> item<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> cartItemVoList<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u5341\u4E03\u3001\u8BA2\u5355\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#\u5341\u4E03\u3001\u8BA2\u5355\u670D\u52A1" aria-hidden="true">#</a> \u5341\u4E03\u3001\u8BA2\u5355\u670D\u52A1</h1><h2 id="_1\u3001\u914D\u7F6Eweb\u3001nginx\u3001springsession\u3001\u914D\u7F6E\u7EBF\u7A0B\u6C60" tabindex="-1"><a class="header-anchor" href="#_1\u3001\u914D\u7F6Eweb\u3001nginx\u3001springsession\u3001\u914D\u7F6E\u7EBF\u7A0B\u6C60" aria-hidden="true">#</a> 1\u3001\u914D\u7F6Eweb\u3001nginx\u3001springSession\u3001\u914D\u7F6E\u7EBF\u7A0B\u6C60</h2><h2 id="_2\u3001\u8BA2\u5355\u6982\u5FF5\u3001\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#_2\u3001\u8BA2\u5355\u6982\u5FF5\u3001\u5206\u6790" aria-hidden="true">#</a> 2\u3001\u8BA2\u5355\u6982\u5FF5\u3001\u5206\u6790</h2><h3 id="\u8BA2\u5355\u4E2D\u5FC3" tabindex="-1"><a class="header-anchor" href="#\u8BA2\u5355\u4E2D\u5FC3" aria-hidden="true">#</a> \u8BA2\u5355\u4E2D\u5FC3</h3><img src="`+v+'" alt="\u8BA2\u5355\u4E2D\u5FC3" style="zoom:80%;"><h3 id="\u8BA2\u5355\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#\u8BA2\u5355\u6D41\u7A0B" aria-hidden="true">#</a> \u8BA2\u5355\u6D41\u7A0B\uFF1A</h3><p><img src="'+b+`" alt="image-20211004160657576"></p><h3 id="\u5E42\u7B49\u6027\u5904\u7406" tabindex="-1"><a class="header-anchor" href="#\u5E42\u7B49\u6027\u5904\u7406" aria-hidden="true">#</a> \u5E42\u7B49\u6027\u5904\u7406</h3><h3 id="\u8BA2\u5355\u4E1A\u52A1" tabindex="-1"><a class="header-anchor" href="#\u8BA2\u5355\u4E1A\u52A1" aria-hidden="true">#</a> \u8BA2\u5355\u4E1A\u52A1</h3><h2 id="_3\u3001\u767B\u5F55\u62E6\u622A" tabindex="-1"><a class="header-anchor" href="#_3\u3001\u767B\u5F55\u62E6\u622A" aria-hidden="true">#</a> 3\u3001\u767B\u5F55\u62E6\u622A</h2><p>WebConfig</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LoginUserInterceptor</span> loginUserInterceptor<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loginUserInterceptor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Interceptor</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginUserInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberResponseVo</span><span class="token punctuation">&gt;</span></span> loginUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AntPathMatcher</span> antPathMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> match <span class="token operator">=</span> antPathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">&quot;/order/order/status/**&quot;</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> match1 <span class="token operator">=</span> antPathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">&quot;/payed/notify&quot;</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">||</span> match1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//\u83B7\u53D6\u767B\u5F55\u7684\u7528\u6237\u4FE1\u606F</span>
        <span class="token class-name">MemberResponseVo</span> attribute <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MemberResponseVo</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>LOGIN_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attribute <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u628A\u767B\u5F55\u540E\u7528\u6237\u7684\u4FE1\u606F\u653E\u5728ThreadLocal\u91CC\u9762\u8FDB\u884C\u4FDD\u5B58</span>
            loginUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u672A\u767B\u5F55\uFF0C\u8FD4\u56DE\u767B\u5F55\u9875\u9762</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/html;charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;script&gt;alert(&#39;\u8BF7\u5148\u8FDB\u884C\u767B\u5F55\uFF0C\u518D\u8FDB\u884C\u540E\u7EED\u64CD\u4F5C\uFF01&#39;);location.href=&#39;http://auth.yumall.com/login.html&#39;&lt;/script&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// session.setAttribute(&quot;msg&quot;, &quot;\u8BF7\u5148\u8FDB\u884C\u767B\u5F55&quot;);</span>
            <span class="token comment">// response.sendRedirect(&quot;http://auth.yumall.com/login.html&quot;);</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4\u3001\u7531\u8D2D\u7269\u8F66-cart-\u53BB\u7ED3\u7B97\u786E\u8BA4\u9875-confirm" tabindex="-1"><a class="header-anchor" href="#_4\u3001\u7531\u8D2D\u7269\u8F66-cart-\u53BB\u7ED3\u7B97\u786E\u8BA4\u9875-confirm" aria-hidden="true">#</a> 4\u3001\u7531\u8D2D\u7269\u8F66 cart \u53BB\u7ED3\u7B97\u786E\u8BA4\u9875 confirm</h2><p>\u8D2D\u7269\u8F66cart\uFF1AcartList.html\uFF1AtoTrade\uFF1Awindow.location.href = &quot;http://order.yumall.com/toTrade&quot;;</p><p>order\uFF1AOrderWebController\uFF1AtoTrade()</p><p><strong>\u6CE8\u610F\uFF1A</strong> <em>a) \u83B7\u53D6\u5F53\u524D\u7528\u6237\u767B\u5F55\u7684\u4FE1\u606F\uFF0C\u83B7\u53D6\u5F53\u524D\u7EBF\u7A0B\u8BF7\u6C42\u5934\u4FE1\u606F(\u89E3\u51B3Feign\u5F02\u6B65\u8C03\u7528\u4E22\u5931\u8BF7\u6C42\u5934\u95EE\u9898)\uFF1Bb) \u5F00\u542F\u5F02\u6B65\u4EFB\u52A1\uFF1Bc) \u6BCF\u4E00\u4E2A\u7EBF\u7A0B\u90FD\u6765\u5171\u4EAB\u4E4B\u524D\u7684\u8BF7\u6C42\u6570\u636E\uFF1Bd) \u6267\u884C\u5177\u4F53\u4E1A\u52A1\u3002</em></p><h3 id="\u89E3\u51B3feign\u5F02\u6B65\u8C03\u7528-\u4E22\u5931\u8BF7\u6C42\u5934-\u4E0A\u4E0B\u6587-\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#\u89E3\u51B3feign\u5F02\u6B65\u8C03\u7528-\u4E22\u5931\u8BF7\u6C42\u5934-\u4E0A\u4E0B\u6587-\u95EE\u9898" aria-hidden="true">#</a> \u89E3\u51B3Feign\u5F02\u6B65\u8C03\u7528 \u4E22\u5931\u8BF7\u6C42\u5934|\u4E0A\u4E0B\u6587 \u95EE\u9898</h3><p><img src="`+g+'" alt="image-20211004175207905"></p><p><img src="'+f+`" alt="image-20211004180806491"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * feign\u62E6\u622A\u5668\u529F\u80FD
 *
 * <span class="token keyword">@author</span> kong
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignConfig</span><span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;requestInterceptor&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token annotation punctuation">@Override</span>
         <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//1\u3001\u4F7F\u7528RequestContextHolder\u62FF\u5230\u521A\u8FDB\u6765\u7684\u8BF7\u6C42\u6570\u636E</span>
            <span class="token class-name">ServletRequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>requestAttributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
               <span class="token comment">//\u8001\u8BF7\u6C42</span>
               <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> requestAttributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span>request <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                  <span class="token comment">//2\u3001\u540C\u6B65\u8BF7\u6C42\u5934\u7684\u6570\u636E\uFF08\u4E3B\u8981\u662Fcookie\uFF09</span>
                  <span class="token comment">//\u628A\u8001\u8BF7\u6C42\u7684cookie\u503C\u653E\u5230\u65B0\u8BF7\u6C42\u4E0A\u6765\uFF0C\u8FDB\u884C\u4E00\u4E2A\u540C\u6B65</span>
                  <span class="token class-name">String</span> cookie <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie&quot;</span><span class="token punctuation">,</span> cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+h+`" alt="image-20211004181324416"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> addressFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">//\u6BCF\u4E00\u4E2A\u7EBF\u7A0B\u90FD\u6765\u5171\u4EAB\u4E4B\u524D\u7684\u8BF7\u6C42\u6570\u636E,\u4E0A\u4E0B\u6587</span>
<span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//Feign\u5F02\u6B65\u8C03\u7528</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-1\u3001controller\u3001\u6784\u5EFAorderconfirmvo" tabindex="-1"><a class="header-anchor" href="#_4-1\u3001controller\u3001\u6784\u5EFAorderconfirmvo" aria-hidden="true">#</a> 4.1\u3001Controller\u3001\u6784\u5EFAOrderConfirmVo</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u53BB\u7ED3\u7B97\u786E\u8BA4\u9875
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/toTrade&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toTrade</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderConfirmVo</span> confirmVo <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;confirmOrderData&quot;</span><span class="token punctuation">,</span>confirmVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u5C55\u793A\u8BA2\u5355\u786E\u8BA4\u7684\u6570\u636E</span>
    <span class="token keyword">return</span> <span class="token string">&quot;confirm&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6784\u5EFAOrderConfirmVo</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>/**
 * \u8BA2\u5355\u786E\u8BA4\u9875\u9700\u8981\u7528\u7684\u6570\u636E
 */
public class OrderConfirmVo{
   /** \u4F1A\u5458\u6536\u83B7\u5730\u5740\u5217\u8868 **/
   @Getter
   @Setter
   List&lt;MemberAddressVo&gt; memberAddressVos;
   /** \u6240\u6709\u9009\u4E2D\u7684\u8D2D\u7269\u9879 **/
   @Getter
   @Setter
   List&lt;OrderItemVo&gt; items;
   /** \u53D1\u7968\u8BB0\u5F55 **/
   @Getter
   @Setter
   /** \u4F18\u60E0\u5238\uFF08\u4F1A\u5458\u79EF\u5206\uFF09 **/
   private Integer integration;
   /** \u9632\u6B62\u91CD\u590D\u63D0\u4EA4\u7684\u4EE4\u724C **/
   @Getter
   @Setter
   private String orderToken;
   @Getter
   @Setter
   Map&lt;Long, Boolean&gt; stocks;
   public Integer getCount(){
      Integer count = 0;
      if(items != null &amp;&amp; items.size() &gt; 0){
         for(OrderItemVo item : items){
            count += item.getCount();
         }
      }
      return count;
   }

   /** \u8BA2\u5355\u603B\u989D **/
   //BigDecimal total;
   //\u8BA1\u7B97\u8BA2\u5355\u603B\u989D
   public BigDecimal getTotal(){
      BigDecimal totalNum = BigDecimal.ZERO;
      if(items != null &amp;&amp; items.size() &gt; 0){
         for(OrderItemVo item : items){
            //\u8BA1\u7B97\u5F53\u524D\u5546\u54C1\u7684\u603B\u4EF7\u683C
            BigDecimal itemPrice = item.getPrice().multiply(new BigDecimal(item.getCount().toString()));
            //\u518D\u8BA1\u7B97\u5168\u90E8\u5546\u54C1\u7684\u603B\u4EF7\u683C
            totalNum = totalNum.add(itemPrice);
         }
      }
      return totalNum;
   }

   /** \u5E94\u4ED8\u4EF7\u683C **/
   //BigDecimal payPrice;
   public BigDecimal getPayPrice(){
      return getTotal();
   }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u6784\u5EFAOrderConfirmVo</span>
		<span class="token class-name">OrderConfirmVo</span> confirmVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderConfirmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//\u83B7\u53D6\u5F53\u524D\u7528\u6237\u767B\u5F55\u7684\u4FE1\u606F</span>
		<span class="token class-name">MemberResponseVo</span> memberResponseVo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//TODO :\u83B7\u53D6\u5F53\u524D\u7EBF\u7A0B\u8BF7\u6C42\u5934\u4FE1\u606F(\u89E3\u51B3Feign\u5F02\u6B65\u8C03\u7528\u4E22\u5931\u8BF7\u6C42\u5934\u95EE\u9898)</span>
		<span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//\u5F00\u542F\u7B2C\u4E00\u4E2A\u5F02\u6B65\u4EFB\u52A1\uFF1A\u8FDC\u7A0B\u67E5\u8BE2\u6240\u6709\u7684\u6536\u83B7\u5730\u5740\u5217\u8868</span>
		<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> addressFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token comment">//\u6BCF\u4E00\u4E2A\u7EBF\u7A0B\u90FD\u6765\u5171\u4EAB\u4E4B\u524D\u7684\u8BF7\u6C42\u6570\u636E</span>
			<span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//1\u3001\u8FDC\u7A0B\u67E5\u8BE2\u6240\u6709\u7684\u6536\u83B7\u5730\u5740\u5217\u8868</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberAddressVo</span><span class="token punctuation">&gt;</span></span> address <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>memberResponseVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			confirmVo<span class="token punctuation">.</span><span class="token function">setMemberAddressVos</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> threadPoolExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//\u5F00\u542F\u7B2C\u4E8C\u4E2A\u5F02\u6B65\u4EFB\u52A1\uFF1A\u8FDC\u7A0B\u67E5\u8BE2\u8D2D\u7269\u8F66\u6240\u6709\u9009\u4E2D\u7684\u8D2D\u7269\u9879\uFF1A\u67E5\u8BE2\u5546\u54C1\u5E93\u5B58\u4FE1\u606F</span>
		<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> cartInfoFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token comment">//\u6BCF\u4E00\u4E2A\u7EBF\u7A0B\u90FD\u6765\u5171\u4EAB\u4E4B\u524D\u7684\u8BF7\u6C42\u6570\u636E</span>
			<span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//2\u3001\u8FDC\u7A0B\u67E5\u8BE2\u8D2D\u7269\u8F66\u6240\u6709\u9009\u4E2D\u7684\u8D2D\u7269\u9879</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">&gt;</span></span> currentCartItems <span class="token operator">=</span> cartFeignService<span class="token punctuation">.</span><span class="token function">getCurrentCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			confirmVo<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>currentCartItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//feign\u5728\u8FDC\u7A0B\u8C03\u7528\u4E4B\u524D\u8981\u6784\u9020\u8BF7\u6C42\uFF0C\u8C03\u7528\u5F88\u591A\u7684\u62E6\u622A\u5668</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> threadPoolExecutor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenRunAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> confirmVo<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//\u83B7\u53D6\u5168\u90E8\u5546\u54C1\u7684id</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds <span class="token operator">=</span> items<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>itemVo <span class="token operator">-&gt;</span> itemVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//\u8FDC\u7A0B\u67E5\u8BE2\u5546\u54C1\u5E93\u5B58\u4FE1\u606F</span>
			<span class="token class-name">R</span> skuHasStock <span class="token operator">=</span> wmsFeignService<span class="token punctuation">.</span><span class="token function">getSkuHasStock</span><span class="token punctuation">(</span>skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuStockVo</span><span class="token punctuation">&gt;</span></span> skuStockVos <span class="token operator">=</span> skuHasStock<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>skuStockVos <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> skuStockVos<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token comment">//\u5C06skuStockVos\u96C6\u5408\u8F6C\u6362\u4E3Amap</span>
				confirmVo<span class="token punctuation">.</span><span class="token function">setStocks</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> skuStockVos<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">SkuStockVo</span><span class="token operator">::</span><span class="token function">getSkuId</span><span class="token punctuation">,</span> <span class="token class-name">SkuStockVo</span><span class="token operator">::</span><span class="token function">getHasStock</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> threadPoolExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//3\u3001\u67E5\u8BE2\u7528\u6237\u79EF\u5206</span>
		<span class="token class-name">Integer</span> integration <span class="token operator">=</span> memberResponseVo<span class="token punctuation">.</span><span class="token function">getIntegration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		confirmVo<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>integration<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//4\u3001\u4EF7\u683C\u6570\u636E\u81EA\u52A8\u8BA1\u7B97</span>
		<span class="token comment">//TODO 5\u3001\u9632\u91CD\u4EE4\u724C(\u9632\u6B62\u8868\u5355\u91CD\u590D\u63D0\u4EA4)</span>
		<span class="token comment">//\u4E3A\u7528\u6237\u8BBE\u7F6E\u4E00\u4E2Atoken\uFF0C\u4E09\u5341\u5206\u949F\u8FC7\u671F\u65F6\u95F4\uFF08\u5B58\u5728redis\uFF09</span>
		<span class="token class-name">String</span> token <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>USER_ORDER_TOKEN_PREFIX<span class="token operator">+</span>memberResponseVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
		confirmVo<span class="token punctuation">.</span><span class="token function">setOrderToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>addressFuture<span class="token punctuation">,</span> cartInfoFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> confirmVo<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2\u3001memberfeignservice-\u8FDC\u7A0B\u67E5\u8BE2\u6240\u6709\u7684\u6536\u83B7\u5730\u5740\u5217\u8868" tabindex="-1"><a class="header-anchor" href="#_4-2\u3001memberfeignservice-\u8FDC\u7A0B\u67E5\u8BE2\u6240\u6709\u7684\u6536\u83B7\u5730\u5740\u5217\u8868" aria-hidden="true">#</a> 4.2\u3001memberFeignService \u8FDC\u7A0B\u67E5\u8BE2\u6240\u6709\u7684\u6536\u83B7\u5730\u5740\u5217\u8868</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;yumall-member&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MemberFeignService</span><span class="token punctuation">{</span>
   <span class="token doc-comment comment">/**
    * \u67E5\u8BE2\u5F53\u524D\u7528\u6237\u7684\u5168\u90E8\u6536\u8D27\u5730\u5740
    */</span>
   <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/member/memberreceiveaddress/{memberId}/address&quot;</span><span class="token punctuation">)</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberAddressVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;memberId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberReceiveAddressEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token class-name">Long</span> memberId<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberReceiveAddressEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;member_id&quot;</span><span class="token punctuation">,</span> memberId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3\u3001cartfeignservice-\u8FDC\u7A0B\u67E5\u8BE2\u8D2D\u7269\u8F66\u6240\u6709\u9009\u4E2D\u7684\u8D2D\u7269\u9879" tabindex="-1"><a class="header-anchor" href="#_4-3\u3001cartfeignservice-\u8FDC\u7A0B\u67E5\u8BE2\u8D2D\u7269\u8F66\u6240\u6709\u9009\u4E2D\u7684\u8D2D\u7269\u9879" aria-hidden="true">#</a> 4.3\u3001cartFeignService \u8FDC\u7A0B\u67E5\u8BE2\u8D2D\u7269\u8F66\u6240\u6709\u9009\u4E2D\u7684\u8D2D\u7269\u9879</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;yumall-cart&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CartFeignService</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u5F53\u524D\u7528\u6237\u8D2D\u7269\u8F66\u9009\u4E2D\u7684\u5546\u54C1\u9879
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/currentUserCartItems&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCurrentCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4\u3001wmsfeignservice-\u8FDC\u7A0B\u67E5\u8BE2\u5546\u54C1\u5E93\u5B58\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#_4-4\u3001wmsfeignservice-\u8FDC\u7A0B\u67E5\u8BE2\u5546\u54C1\u5E93\u5B58\u4FE1\u606F" aria-hidden="true">#</a> 4.4\u3001wmsFeignService \u8FDC\u7A0B\u67E5\u8BE2\u5546\u54C1\u5E93\u5B58\u4FE1\u606F</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/ware/waresku/hasStock&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">R</span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5\u3001memberresponsevo-\u67E5\u8BE2\u7528\u6237\u79EF\u5206" tabindex="-1"><a class="header-anchor" href="#_4-5\u3001memberresponsevo-\u67E5\u8BE2\u7528\u6237\u79EF\u5206" aria-hidden="true">#</a> 4.5\u3001memberResponseVo \u67E5\u8BE2\u7528\u6237\u79EF\u5206</h3><h3 id="_4-6\u3001\u4E3A\u7528\u6237\u8BBE\u7F6E\u4E00\u4E2Atoken-\u4E09\u5341\u5206\u949F\u8FC7\u671F\u65F6\u95F4-\u5B58\u5728redis-\u9632\u91CD\u4EE4\u724C-\u9632\u6B62\u8868\u5355\u91CD\u590D\u63D0\u4EA4" tabindex="-1"><a class="header-anchor" href="#_4-6\u3001\u4E3A\u7528\u6237\u8BBE\u7F6E\u4E00\u4E2Atoken-\u4E09\u5341\u5206\u949F\u8FC7\u671F\u65F6\u95F4-\u5B58\u5728redis-\u9632\u91CD\u4EE4\u724C-\u9632\u6B62\u8868\u5355\u91CD\u590D\u63D0\u4EA4" aria-hidden="true">#</a> 4.6\u3001\u4E3A\u7528\u6237\u8BBE\u7F6E\u4E00\u4E2Atoken\uFF0C\u4E09\u5341\u5206\u949F\u8FC7\u671F\u65F6\u95F4\uFF08\u5B58\u5728redis\uFF09\u9632\u91CD\u4EE4\u724C(\u9632\u6B62\u8868\u5355\u91CD\u590D\u63D0\u4EA4)</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> token <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">RedisUtils<span class="token punctuation">.</span>String2</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>USER_ORDER_TOKEN_PREFIX<span class="token operator">+</span>memberResponseVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      confirmVo<span class="token punctuation">.</span><span class="token function">setOrderToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-7\u3001\u7ED3\u7B97\u786E\u8BA4\u9875\u6E32\u67D3" tabindex="-1"><a class="header-anchor" href="#_4-7\u3001\u7ED3\u7B97\u786E\u8BA4\u9875\u6E32\u67D3" aria-hidden="true">#</a> 4.7\u3001\u7ED3\u7B97\u786E\u8BA4\u9875\u6E32\u67D3</h3><h2 id="_5\u3001\u786E\u8BA4\u9875\u6A21\u62DF\u8FD0\u8D39\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#_5\u3001\u786E\u8BA4\u9875\u6A21\u62DF\u8FD0\u8D39\u4FE1\u606F" aria-hidden="true">#</a> 5\u3001\u786E\u8BA4\u9875\u6A21\u62DF\u8FD0\u8D39\u4FE1\u606F</h2><p>http://yumall.com/api/ware/wareinfo/fare?addrId=120120</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token class-name">FareVo</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token class-name">Long</span> addrId<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">FareVo</span> fareVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FareVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//\u6536\u83B7\u5730\u5740\u7684\u8BE6\u7EC6\u4FE1\u606F</span>
   <span class="token class-name">R</span> addrInfo <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>addrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">MemberAddressVo</span> memberAddressVo <span class="token operator">=</span> addrInfo<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;memberReceiveAddress&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberAddressVo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>memberAddressVo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">String</span> phone <span class="token operator">=</span> memberAddressVo<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u622A\u53D6\u7528\u6237\u624B\u673A\u53F7\u7801\u6700\u540E\u4E00\u4F4D\u4F5C\u4E3A\u6211\u4EEC\u7684\u8FD0\u8D39\u8BA1\u7B97</span>
      <span class="token comment">//1558022051</span>
      <span class="token class-name">String</span> fare <span class="token operator">=</span> phone<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>phone<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> phone<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">BigDecimal</span> bigDecimal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>fare<span class="token punctuation">)</span><span class="token punctuation">;</span>
      fareVo<span class="token punctuation">.</span><span class="token function">setFare</span><span class="token punctuation">(</span>bigDecimal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      fareVo<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>memberAddressVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> fareVo<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6\u3001\u5E42\u7B49\u6027" tabindex="-1"><a class="header-anchor" href="#_6\u3001\u5E42\u7B49\u6027" aria-hidden="true">#</a> 6\u3001\u5E42\u7B49\u6027</h2><p><img src="`+y+'" alt="image-20211004192550633"></p><h3 id="_6-1\u3001\u6982\u5FF5" tabindex="-1"><a class="header-anchor" href="#_6-1\u3001\u6982\u5FF5" aria-hidden="true">#</a> 6.1\u3001\u6982\u5FF5</h3><p>\u63A5\u53E3\u5E42\u7B49\u6027\u5C31\u662F\u7528\u6237\u5BF9\u4E8E\u540C\u4E00\u64CD\u4F5C\u53D1\u8D77\u7684\u4E00\u6B21\u8BF7\u6C42\u6216\u8005\u591A\u6B21\u8BF7\u6C42\u7684\u7ED3\u679C\u662F\u4E00\u81F4\u7684\uFF0C\u4E0D\u4F1A\u56E0 \u4E3A\u591A\u6B21\u70B9\u51FB\u800C\u4EA7\u751F\u4E86\u526F\u4F5C\u7528:\u6BD4\u5982\u8BF4\u652F\u4ED8\u573A\u666F\uFF0C\u7528\u6237\u8D2D\u4E70\u4E86\u5546\u54C1\u652F\u4ED8\u6263\u6B3E\u6210\u529F\uFF0C\u4F46\u662F\u8FD4\u56DE\u7ED3 \u679C\u7684\u65F6\u5019\u7F51\u7EDC\u5F02\u5E38\uFF0C\u6B64\u65F6\u94B1\u5DF2\u7ECF\u6263\u4E86\uFF0C\u7528\u6237\u518D\u6B21\u70B9\u51FB\u6309\u94AE\uFF0C\u6B64\u65F6\u4F1A\u8FDB\u884C\u7B2C\u4E8C\u6B21\u6263\u6B3E\uFF0C\u8FD4\u56DE\u7ED3 \u679C\u6210\u529F\uFF0C\u7528\u6237\u67E5\u8BE2\u4F59\u989D\u8FD4\u53D1\u73B0\u591A\u6263\u94B1\u4E86\uFF0C\u6D41\u6C34\u8BB0\u5F55\u4E5F\u53D8\u6210\u4E86\u4E24\u6761. . .\uFF0C\u8FD9\u5C31\u6CA1\u6709\u4FDD\u8BC1\u63A5\u53E3 \u7684\u5E42\u7B49\u6027\u3002</p><h3 id="_6-2\u3001\u4F7F\u7528\u573A\u666F" tabindex="-1"><a class="header-anchor" href="#_6-2\u3001\u4F7F\u7528\u573A\u666F" aria-hidden="true">#</a> 6.2\u3001\u4F7F\u7528\u573A\u666F</h3><p>\u7528\u6237\u591A\u6B21\u70B9\u51FB\u6309\u94AE \u7528\u6237\u9875\u9762\u56DE\u9000\u518D\u6B21\u63D0\u4EA4 \u5FAE\u670D\u52A1\u4E92\u76F8\u8C03\u7528\uFF0C\u7531\u4E8E\u7F51\u7EDC\u95EE\u9898\uFF0C\u5BFC\u81F4\u8BF7\u6C42\u5931\u8D25\u3002feign \u89E6\u53D1\u91CD\u8BD5\u673A\u5236 \u5176\u4ED6\u4E1A\u52A1\u60C5\u51B5</p><h3 id="_6-3\u3001\u89E3\u51B3\u65B9\u6848" tabindex="-1"><a class="header-anchor" href="#_6-3\u3001\u89E3\u51B3\u65B9\u6848" aria-hidden="true">#</a> 6.3\u3001\u89E3\u51B3\u65B9\u6848</h3><h2 id="_7\u3001\u8BA2\u5355\u63D0\u4EA4-submitorder" tabindex="-1"><a class="header-anchor" href="#_7\u3001\u8BA2\u5355\u63D0\u4EA4-submitorder" aria-hidden="true">#</a> 7\u3001\u8BA2\u5355\u63D0\u4EA4 submitOrder</h2><p><img src="'+q+`" alt="image-20211004194440103"></p><h3 id="\u5907\u6CE8-redis\u539F\u5B50\u9A8C\u8BC1\u4EE4\u724C\u3001\u6784\u9020\u8BA2\u5355\u6570\u636E\u3001\u8BA2\u5355\u9A8C\u8BC1\u4EF7\u683C\u3001\u4FDD\u5B58\u8BA2\u5355\u6570\u636E\u3001\u5E93\u5B58\u9501\u5B9A-\u53EA\u8981\u6709\u5F02\u5E38-\u56DE\u6EDA\u8BA2\u5355\u6570\u636E\u3001\u8BA2\u5355\u521B\u5EFA\u6210\u529F-\u53D1\u9001\u6D88\u606F\u7ED9mq\u3001\u5220\u9664\u8D2D\u7269\u8F66\u91CC\u7684\u6570\u636E" tabindex="-1"><a class="header-anchor" href="#\u5907\u6CE8-redis\u539F\u5B50\u9A8C\u8BC1\u4EE4\u724C\u3001\u6784\u9020\u8BA2\u5355\u6570\u636E\u3001\u8BA2\u5355\u9A8C\u8BC1\u4EF7\u683C\u3001\u4FDD\u5B58\u8BA2\u5355\u6570\u636E\u3001\u5E93\u5B58\u9501\u5B9A-\u53EA\u8981\u6709\u5F02\u5E38-\u56DE\u6EDA\u8BA2\u5355\u6570\u636E\u3001\u8BA2\u5355\u521B\u5EFA\u6210\u529F-\u53D1\u9001\u6D88\u606F\u7ED9mq\u3001\u5220\u9664\u8D2D\u7269\u8F66\u91CC\u7684\u6570\u636E" aria-hidden="true">#</a> \u5907\u6CE8\uFF1Aredis\u539F\u5B50\u9A8C\u8BC1\u4EE4\u724C\u3001\u6784\u9020\u8BA2\u5355\u6570\u636E\u3001\u8BA2\u5355\u9A8C\u8BC1\u4EF7\u683C\u3001\u4FDD\u5B58\u8BA2\u5355\u6570\u636E\u3001\u5E93\u5B58\u9501\u5B9A\uFF0C\u53EA\u8981\u6709\u5F02\u5E38\uFF0C\u56DE\u6EDA\u8BA2\u5355\u6570\u636E\u3001\u8BA2\u5355\u521B\u5EFA\u6210\u529F\uFF0C\u53D1\u9001\u6D88\u606F\u7ED9MQ\u3001\u5220\u9664\u8D2D\u7269\u8F66\u91CC\u7684\u6570\u636E</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SubmitOrderResponseVo</span> <span class="token function">submitOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderSubmitVo</span> orderSubmitVo<span class="token punctuation">)</span><span class="token punctuation">{</span>
   confirmVoThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>orderSubmitVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">SubmitOrderResponseVo</span> responseVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubmitOrderResponseVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//\u53BB\u521B\u5EFA\u3001\u4E0B\u8BA2\u5355\u3001\u9A8C\u4EE4\u724C\u3001\u9A8C\u4EF7\u683C\u3001\u9501\u5B9A\u5E93\u5B58...</span>
   <span class="token comment">//\u83B7\u53D6\u5F53\u524D\u7528\u6237\u767B\u5F55\u7684\u4FE1\u606F</span>
   <span class="token class-name">MemberResponseVo</span> memberResponseVo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   responseVo<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//1\u3001\u9A8C\u8BC1\u4EE4\u724C\u662F\u5426\u5408\u6CD5\u3010\u4EE4\u724C\u7684\u5BF9\u6BD4\u548C\u5220\u9664\u5FC5\u987B\u4FDD\u8BC1\u539F\u5B50\u6027\u3011</span>
   <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end&quot;</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> orderToken <span class="token operator">=</span> orderSubmitVo<span class="token punctuation">.</span><span class="token function">getOrderToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//\u901A\u8FC7lure\u811A\u672C\u539F\u5B50\u9A8C\u8BC1\u4EE4\u724C\u548C\u5220\u9664\u4EE4\u724C</span>
   <span class="token class-name">Long</span> result <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>USER_ORDER_TOKEN_PREFIX<span class="token operator">+</span>memberResponseVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u4EE4\u724C\u9A8C\u8BC1\u5931\u8D25</span>
      responseVo<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> responseVo<span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">//\u4EE4\u724C\u9A8C\u8BC1\u6210\u529F</span>
      <span class="token comment">//1\u3001\u521B\u5EFA\u8BA2\u5355\u3001\u8BA2\u5355\u9879\u7B49\u4FE1\u606F</span>
      <span class="token class-name">OrderCreateTo</span> order <span class="token operator">=</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//2\u3001\u9A8C\u8BC1\u4EF7\u683C</span>
      <span class="token class-name">BigDecimal</span> payAmount <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPayAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">BigDecimal</span> payPrice <span class="token operator">=</span> orderSubmitVo<span class="token punctuation">.</span><span class="token function">getPayPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>payAmount<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>payPrice<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token comment">//\u91D1\u989D\u5BF9\u6BD4</span>
         <span class="token comment">//3\u3001\u4FDD\u5B58\u8BA2\u5355</span>
         <span class="token function">saveOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//4\u3001\u5E93\u5B58\u9501\u5B9A,\u53EA\u8981\u6709\u5F02\u5E38\uFF0C\u56DE\u6EDA\u8BA2\u5355\u6570\u636E</span>
         <span class="token comment">//\u8BA2\u5355\u53F7\u3001\u6240\u6709\u8BA2\u5355\u9879\u4FE1\u606F(skuId,skuNum,skuName)</span>
         <span class="token class-name">WareSkuLockVo</span> lockVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WareSkuLockVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         lockVo<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//\u83B7\u53D6\u51FA\u8981\u9501\u5B9A\u7684\u5546\u54C1\u6570\u636E\u4FE1\u606F</span>
         <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">&gt;</span></span> orderItemVos <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getOrderItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">OrderItemVo</span> orderItemVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItemVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> orderItemVo<span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         lockVo<span class="token punctuation">.</span><span class="token function">setLocks</span><span class="token punctuation">(</span>orderItemVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// \u8C03\u7528\u8FDC\u7A0B\u9501\u5B9A\u5E93\u5B58\u7684\u65B9\u6CD5</span>
         <span class="token comment">// \u51FA\u73B0\u7684\u95EE\u9898\uFF1A\u6263\u51CF\u5E93\u5B58\u6210\u529F\u4E86\uFF0C\u4F46\u662F\u7531\u4E8E\u7F51\u7EDC\u539F\u56E0\u8D85\u65F6\uFF0C\u51FA\u73B0\u5F02\u5E38\uFF0C\u5BFC\u81F4\u8BA2\u5355\u4E8B\u52A1\u56DE\u6EDA\uFF0C\u5E93\u5B58\u4E8B\u52A1\u4E0D\u56DE\u6EDA(\u89E3\u51B3\u65B9\u6848\uFF1Aseata)</span>
         <span class="token comment">//\u4E3A\u4E86\u4FDD\u8BC1\u9AD8\u5E76\u53D1\uFF0C\u4E0D\u63A8\u8350\u4F7F\u7528seata\uFF0C\u56E0\u4E3A\u662F\u52A0\u9501\uFF0C\u5E76\u884C\u5316\uFF0C\u63D0\u5347\u4E0D\u4E86\u6548\u7387,\u53EF\u4EE5\u53D1\u6D88\u606F\u7ED9\u5E93\u5B58\u670D\u52A1</span>
         <span class="token class-name">R</span> r <span class="token operator">=</span> wmsFeignService<span class="token punctuation">.</span><span class="token function">orderLockStock</span><span class="token punctuation">(</span>lockVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//\u9501\u5B9A\u6210\u529F</span>
            responseVo<span class="token punctuation">.</span><span class="token function">setOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// int i = 10/0;</span>
            <span class="token comment">//\u8BA2\u5355\u521B\u5EFA\u6210\u529F\uFF0C\u53D1\u9001\u6D88\u606F\u7ED9MQ</span>
            rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;order.create.order&quot;</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u5220\u9664\u8D2D\u7269\u8F66\u91CC\u7684\u6570\u636E</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>CART_PREFIX<span class="token operator">+</span>memberResponseVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> responseVo<span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//\u9501\u5B9A\u5931\u8D25</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoStockException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
         responseVo<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> responseVo<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-1\u3001\u63D0\u4EA4\u6D41\u7A0B-createorder\u3001saveorder" tabindex="-1"><a class="header-anchor" href="#_7-1\u3001\u63D0\u4EA4\u6D41\u7A0B-createorder\u3001saveorder" aria-hidden="true">#</a> 7.1\u3001\u63D0\u4EA4\u6D41\u7A0B createOrder\u3001saveOrder</h3><p><img src="`+S+'" alt="image-20211004212537610"></p><p><img src="'+w+`" alt="image-20211004212605590"></p><h3 id="_7-2\u3001\u5E93\u5B58\u9501-wmsfeignservice-orderlockstock" tabindex="-1"><a class="header-anchor" href="#_7-2\u3001\u5E93\u5B58\u9501-wmsfeignservice-orderlockstock" aria-hidden="true">#</a> 7.2\u3001\u5E93\u5B58\u9501 wmsFeignService.orderLockStock()</h3><div class="language-ABAP ext-ABAP line-numbers-mode"><pre class="language-ABAP"><code>\u5E93\u5B58\u89E3\u9501\u7684\u573A\u666F
1\uFF09\u3001\u4E0B\u8BA2\u5355\u6210\u529F\uFF0C\u8BA2\u5355\u8FC7\u671F\u6CA1\u6709\u652F\u4ED8\u88AB\u7CFB\u7EDF\u81EA\u52A8\u53D6\u6D88\u6216\u8005\u88AB\u7528\u6237\u624B\u52A8\u53D6\u6D88\uFF0C\u90FD\u8981\u89E3\u9501\u5E93\u5B58
2\uFF09\u3001\u4E0B\u8BA2\u5355\u6210\u529F\uFF0C\u5E93\u5B58\u9501\u5B9A\u6210\u529F\uFF0C\u63A5\u4E0B\u6765\u7684\u4E1A\u52A1\u8C03\u7528\u5931\u8D25\uFF0C\u5BFC\u81F4\u8BA2\u5355\u56DE\u6EDA\u3002\u4E4B\u524D\u9501\u5B9A\u7684\u5E93\u5B58\u5C31\u8981\u81EA\u52A8\u89E3\u9501
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+I+`" alt="image-20211004214057804"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">orderLockStock</span><span class="token punctuation">(</span><span class="token class-name">WareSkuLockVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     
<span class="token comment">//\u544A\u8BC9MQ\u5E93\u5B58\u9501\u5B9A\u6210\u529F</span>
<span class="token class-name">StockLockedTo</span> lockedTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockLockedTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lockedTo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StockDetailTo</span> detailTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockDetailTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>taskDetailEntity<span class="token punctuation">,</span> detailTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//\u53EA\u53D1id\u4E0D\u884C\uFF0C\u9632\u6B62\u56DE\u6EDA\u4EE5\u540E\u627E\u4E0D\u5230\u6570\u636E   </span>
lockedTo<span class="token punctuation">.</span><span class="token function">setDetailTo</span><span class="token punctuation">(</span>detailTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;stock-event-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;stock.locked&quot;</span><span class="token punctuation">,</span> lockedTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3\u3001\u4F7F\u7528-mq-\u5EF6\u8FDF\u961F\u5217" tabindex="-1"><a class="header-anchor" href="#_7-3\u3001\u4F7F\u7528-mq-\u5EF6\u8FDF\u961F\u5217" aria-hidden="true">#</a> 7.3\u3001\u4F7F\u7528 MQ \u5EF6\u8FDF\u961F\u5217</h3><p><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E7%89%A9">\u524D\u53BB\u5206\u5E03\u5F0F\u4E8B\u7269</a></p><p><a href="#MQ%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97">\u524D\u53BBMQ\u5EF6\u8FDF\u961F\u5217</a></p><h3 id="\u8BA2\u5355\u91CA\u653E-\u5E93\u5B58\u89E3\u9501" tabindex="-1"><a class="header-anchor" href="#\u8BA2\u5355\u91CA\u653E-\u5E93\u5B58\u89E3\u9501" aria-hidden="true">#</a> - - \u8BA2\u5355\u91CA\u653E&amp;\u5E93\u5B58\u89E3\u9501</h3><p><img src="`+_+`" alt="image-20211116210606144"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kong<span class="token punctuation">.</span>yumall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span><span class="token class-name">MyOrderMQConfig</span>
<span class="token doc-comment comment">/**
 * \u8BA2\u5355\u91CA\u653E\u76F4\u63A5\u548C\u5E93\u5B58\u91CA\u653E\u8FDB\u884C\u7ED1\u5B9A
 *
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">orderReleaseOtherBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">&quot;stock.release.stock.queue&quot;</span><span class="token punctuation">,</span>
            <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span>QUEUE<span class="token punctuation">,</span>
            <span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;order.release.other.#&quot;</span><span class="token punctuation">,</span>
            <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4\u3001\u81EA\u52A8\u89E3\u9501\u5E93\u5B58" tabindex="-1"><a class="header-anchor" href="#_7-4\u3001\u81EA\u52A8\u89E3\u9501\u5E93\u5B58" aria-hidden="true">#</a> 7.4\u3001\u81EA\u52A8\u89E3\u9501\u5E93\u5B58</h3><p>yumall/ware/listener/StockReleaseListener.java</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;stock.release.stock.queue&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockReleaseListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WareSkuService</span> wareSkuService<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 1\u3001\u5E93\u5B58\u81EA\u52A8\u89E3\u9501
     *  \u4E0B\u8BA2\u5355\u6210\u529F\uFF0C\u5E93\u5B58\u9501\u5B9A\u6210\u529F\uFF0C\u63A5\u4E0B\u6765\u7684\u4E1A\u52A1\u8C03\u7528\u5931\u8D25\uFF0C\u5BFC\u81F4\u8BA2\u5355\u56DE\u6EDA\u3002\u4E4B\u524D\u9501\u5B9A\u7684\u5E93\u5B58\u5C31\u8981\u81EA\u52A8\u89E3\u9501
     *  2\u3001\u8BA2\u5355\u5931\u8D25
     *      \u5E93\u5B58\u9501\u5B9A\u5931\u8D25
     *   \u53EA\u8981\u89E3\u9501\u5E93\u5B58\u7684\u6D88\u606F\u5931\u8D25\uFF0C\u4E00\u5B9A\u8981\u544A\u8BC9\u670D\u52A1\u89E3\u9501\u5931\u8D25
     * <span class="token keyword">@param</span> <span class="token parameter">to</span>
     * <span class="token keyword">@param</span> <span class="token parameter">message</span>
     * <span class="token keyword">@param</span> <span class="token parameter">channel</span>
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
     */</span>
    <span class="token annotation punctuation">@RabbitHandler</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleStockLockedRelease</span><span class="token punctuation">(</span><span class="token class-name">StockLockedTo</span> <span class="token keyword">to</span><span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;******\u6536\u5230\u89E3\u9501\u5E93\u5B58\u7684\u4FE1\u606F******&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u5F53\u524D\u6D88\u606F\u662F\u5426\u88AB\u7B2C\u4E8C\u6B21\u53CA\u4EE5\u540E\uFF08\u91CD\u65B0\uFF09\u6D3E\u53D1\u8FC7\u6765\u4E86</span>
            <span class="token comment">// Boolean redelivered = message.getMessageProperties().getRedelivered();</span>
            <span class="token comment">//\u89E3\u9501\u5E93\u5B58</span>
            wareSkuService<span class="token punctuation">.</span><span class="token function">unlockStock</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u624B\u52A8\u5220\u9664\u6D88\u606F</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u89E3\u9501\u5931\u8D25 \u5C06\u6D88\u606F\u91CD\u65B0\u653E\u56DE\u961F\u5217\uFF0C\u8BA9\u522B\u4EBA\u6D88\u8D39</span>
            channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * \u8BA2\u5355\u5173\u95ED\uFF08\u53D6\u6D88\uFF09-\u81EA\u52A8\u89E3\u9501
     * <span class="token keyword">@param</span> <span class="token parameter">orderTo</span>
     * <span class="token keyword">@param</span> <span class="token parameter">message</span>
     * <span class="token keyword">@param</span> <span class="token parameter">channel</span>
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
     */</span>
    <span class="token annotation punctuation">@RabbitHandler</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleOrderCloseRelease</span><span class="token punctuation">(</span><span class="token class-name">OrderTo</span> orderTo<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;******\u6536\u5230\u8BA2\u5355\u5173\u95ED\uFF0C\u51C6\u5907\u89E3\u9501\u5E93\u5B58\u7684\u4FE1\u606F******&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            wareSkuService<span class="token punctuation">.</span><span class="token function">unlockOrder</span><span class="token punctuation">(</span>orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u624B\u52A8\u5220\u9664\u6D88\u606F</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u89E3\u9501\u5931\u8D25 \u5C06\u6D88\u606F\u91CD\u65B0\u653E\u56DE\u961F\u5217\uFF0C\u8BA9\u522B\u4EBA\u6D88\u8D39</span>
            channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;stock.release.stock.queue&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;wareSkuService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WareSkuServiceImpl</span>
    
     <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
     * \u89E3\u9501\u5E93\u5B58
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * 1\u3001\u67E5\u8BE2\u6570\u636E\u5E93\u5173\u4E8E\u8FD9\u4E2A\u8BA2\u5355\u9501\u5B9A\u5E93\u5B58\u4FE1\u606F<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * ---\u6709\uFF1A\u8BC1\u660E\u5E93\u5B58\u9501\u5B9A\u6210\u529F\u4E86<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * ------\u89E3\u9501\uFF1A\u8BA2\u5355\u72B6\u51B5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * ---------1\u3001\u6CA1\u6709\u8FD9\u4E2A\u8BA2\u5355\uFF0C\u5FC5\u987B\u89E3\u9501\u5E93\u5B58<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * ---------2\u3001\u6709\u8FD9\u4E2A\u8BA2\u5355\uFF0C\u4E0D\u4E00\u5B9A\u89E3\u9501\u5E93\u5B58<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * ------------\u8BA2\u5355\u72B6\u6001\uFF1A\u5DF2\u53D6\u6D88\uFF1A\u89E3\u9501\u5E93\u5B58<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * ---------------------\u5DF2\u652F\u4ED8\uFF1A\u4E0D\u80FD\u89E3\u9501\u5E93\u5B58<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * ---\u6CA1\u6709<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     *     \u5E93\u5B58\u9501\u5B9A\u5931\u8D25\u4E86\uFF0C\u5E93\u5B58\u56DE\u6EDA\u4E86\u3002\u8FD9\u79CD\u60C5\u51B5\u65E0\u9700\u89E3\u9501
     * <span class="token keyword">@param</span> <span class="token parameter">to</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlockStock</span><span class="token punctuation">(</span><span class="token class-name">StockLockedTo</span> <span class="token keyword">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u5E93\u5B58\u5DE5\u4F5C\u5355\u7684id</span>
        <span class="token class-name">StockDetailTo</span> detail <span class="token operator">=</span> <span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">getDetailTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> detailId <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WareOrderTaskDetailEntity</span> taskDetailInfo <span class="token operator">=</span> wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>detailId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>taskDetailInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u67E5\u51FAwms_ware_order_task\u5DE5\u4F5C\u5355\u7684\u4FE1\u606F</span>
            <span class="token class-name">Long</span> id <span class="token operator">=</span> <span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">WareOrderTaskEntity</span> orderTaskInfo <span class="token operator">=</span> wareOrderTaskService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u83B7\u53D6\u8BA2\u5355\u53F7\u67E5\u8BE2\u8BA2\u5355\u72B6\u6001</span>
            <span class="token class-name">String</span> orderSn <span class="token operator">=</span> orderTaskInfo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u8FDC\u7A0B\u67E5\u8BE2\u8BA2\u5355\u4FE1\u606F</span>
            <span class="token class-name">R</span> orderData <span class="token operator">=</span> orderFeignService<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>orderData<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//\u8BA2\u5355\u6570\u636E\u8FD4\u56DE\u6210\u529F</span>
                <span class="token class-name">OrderVo</span> orderInfo <span class="token operator">=</span> orderData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderVo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u5224\u65AD\u8BA2\u5355\u72B6\u6001\u662F\u5426\u5DF2\u53D6\u6D88\u6216\u8005\u652F\u4ED8\u6216\u8005\u8BA2\u5355\u4E0D\u5B58\u5728</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>orderInfo <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> orderInfo<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//\u8BA2\u5355\u5DF2\u88AB\u53D6\u6D88\uFF0C\u624D\u80FD\u89E3\u9501\u5E93\u5B58</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>taskDetailInfo<span class="token punctuation">.</span><span class="token function">getLockStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//\u5F53\u524D\u5E93\u5B58\u5DE5\u4F5C\u5355\u8BE6\u60C5\u72B6\u60011\uFF0C\u5DF2\u9501\u5B9A\uFF0C\u4F46\u662F\u672A\u89E3\u9501\u624D\u53EF\u4EE5\u89E3\u9501</span>
                        <span class="token function">unLockStock</span><span class="token punctuation">(</span>detail<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> detail<span class="token punctuation">.</span><span class="token function">getWareId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> detail<span class="token punctuation">.</span><span class="token function">getSkuNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> detailId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//\u6D88\u606F\u62D2\u7EDD\u4EE5\u540E\u91CD\u65B0\u653E\u5728\u961F\u5217\u91CC\u9762\uFF0C\u8BA9\u522B\u4EBA\u7EE7\u7EED\u6D88\u8D39\u89E3\u9501</span>
                <span class="token comment">//\u8FDC\u7A0B\u8C03\u7528\u670D\u52A1\u5931\u8D25</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;\u8FDC\u7A0B\u8C03\u7528\u670D\u52A1\u5931\u8D25&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u65E0\u9700\u89E3\u9501</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u89E3\u9501\u5E93\u5B58\u7684\u65B9\u6CD5
 *
 * <span class="token keyword">@param</span> <span class="token parameter">skuId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">wareId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">num</span>
 * <span class="token keyword">@param</span> <span class="token parameter">taskDetailId</span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unLockStock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Long</span> wareId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">,</span> <span class="token class-name">Long</span> taskDetailId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//\u5E93\u5B58\u89E3\u9501</span>
    wareSkuDao<span class="token punctuation">.</span><span class="token function">unLockStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span> wareId<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u66F4\u65B0\u5DE5\u4F5C\u5355\u7684\u72B6\u6001</span>
    <span class="token class-name">WareOrderTaskDetailEntity</span> taskDetailEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    taskDetailEntity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>taskDetailId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u53D8\u4E3A\u5DF2\u89E3\u9501</span>
    taskDetailEntity<span class="token punctuation">.</span><span class="token function">setLockStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>taskDetailEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-5\u3001\u81EA\u52A8\u89E3\u9501\u8BA2\u5355" tabindex="-1"><a class="header-anchor" href="#_7-5\u3001\u81EA\u52A8\u89E3\u9501\u8BA2\u5355" aria-hidden="true">#</a> 7.5\u3001\u81EA\u52A8\u89E3\u9501\u8BA2\u5355</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * \u89E3\u9501\u8BA2\u5355
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * \u9632\u6B62\u8BA2\u5355\u670D\u52A1\u5361\u987F\uFF0C\u5BFC\u81F4\u8BA2\u5355\u72B6\u6001\u6D88\u606F\u4E00\u76F4\u6539\u4E0D\u4E86\uFF0C\u5E93\u5B58\u4F18\u5148\u5230\u671F\uFF0C\u67E5\u8BA2\u5355\u72B6\u6001\u65B0\u5EFA\uFF0C\u4EC0\u4E48\u90FD\u4E0D\u5904\u7406
     * \u5BFC\u81F4\u5361\u987F\u7684\u8BA2\u5355\uFF0C\u6C38\u8FDC\u90FD\u4E0D\u80FD\u89E3\u9501\u5E93\u5B58
     *
     * <span class="token keyword">@param</span> <span class="token parameter">orderTo</span>
     */</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlockOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderTo</span> orderTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> orderSn <span class="token operator">=</span> orderTo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u67E5\u4E00\u4E0B\u6700\u65B0\u7684\u5E93\u5B58\u89E3\u9501\u72B6\u6001\uFF0C\u9632\u6B62\u91CD\u590D\u89E3\u9501\u5E93\u5B58</span>
        <span class="token class-name">WareOrderTaskEntity</span> orderTaskEntity <span class="token operator">=</span> wareOrderTaskService<span class="token punctuation">.</span><span class="token function">getOrderTaskByOrderSn</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u6309\u7167\u5DE5\u4F5C\u5355\u7684id\u627E\u5230\u6240\u6709 \u6CA1\u6709\u89E3\u9501\u7684\u5E93\u5B58\uFF0C\u8FDB\u884C\u89E3\u9501</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> orderTaskEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;task_id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;lock_status&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">WareOrderTaskDetailEntity</span> taskDetailEntity <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">unLockStock</span><span class="token punctuation">(</span>taskDetailEntity<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    taskDetailEntity<span class="token punctuation">.</span><span class="token function">getWareId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    taskDetailEntity<span class="token punctuation">.</span><span class="token function">getSkuNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    taskDetailEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-6\u3001\u5B9A\u65F6\u5173\u95ED\u8BA2\u5355" tabindex="-1"><a class="header-anchor" href="#_7-6\u3001\u5B9A\u65F6\u5173\u95ED\u8BA2\u5355" aria-hidden="true">#</a> 7.6\u3001\u5B9A\u65F6\u5173\u95ED\u8BA2\u5355</h3><p><a href="#%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0">\u8BBE\u8BA1\u6D41\u7A0B\uFF1A\u524D\u53BB \u5EF6\u8FDF\u961F\u5217\u5B9E\u73B0</a></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;order.release.order.queue&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCloseListener</span><span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@RabbitHandler</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> orderEntity<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u6536\u5230\u8FC7\u671F\u7684\u8BA2\u5355\u4FE1\u606F\uFF0C\u51C6\u5907\u5173\u95ED\u8BA2\u5355:{}&quot;</span><span class="token punctuation">,</span>orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span><span class="token punctuation">{</span>
         orderService<span class="token punctuation">.</span><span class="token function">closeOrder</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
         channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
         channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> orderEntity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//\u5173\u95ED\u8BA2\u5355\u4E4B\u524D\u5148\u67E5\u8BE2\u4E00\u4E0B\u6570\u636E\u5E93\uFF0C\u5224\u65AD\u6B64\u8BA2\u5355\u72B6\u6001\u662F\u5426\u5DF2\u652F\u4ED8</span>
    <span class="token class-name">OrderEntity</span> orderInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;order_sn&quot;</span><span class="token punctuation">,</span> orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span>CREATE_NEW<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u4EE3\u4ED8\u6B3E\u72B6\u6001\u8FDB\u884C\u5173\u5355</span>
        <span class="token class-name">OrderEntity</span> orderUpdate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderUpdate<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderUpdate<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span>CANCLED<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>orderUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u53D1\u9001\u6D88\u606F\u7ED9MQ</span>
        <span class="token class-name">OrderTo</span> orderTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">,</span> orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//TODO \u786E\u4FDD\u6BCF\u4E2A\u6D88\u606F\u53D1\u9001\u6210\u529F\uFF0C\u7ED9\u6BCF\u4E2A\u6D88\u606F\u505A\u597D\u65E5\u5FD7\u8BB0\u5F55\uFF0C(\u7ED9\u6570\u636E\u5E93\u4FDD\u5B58\u6BCF\u4E00\u4E2A\u8BE6\u7EC6\u4FE1\u606F)\u4FDD\u5B58\u6BCF\u4E2A\u6D88\u606F\u7684\u8BE6\u7EC6\u4FE1\u606F</span>
            rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;order.release.other&quot;</span><span class="token punctuation">,</span> orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//TODO \u5B9A\u671F\u626B\u63CF\u6570\u636E\u5E93\uFF0C\u91CD\u65B0\u53D1\u9001\u5931\u8D25\u7684\u6D88\u606F</span>
        <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u5341\u4E5D\u3001\u8BA2\u5355\u652F\u4ED8" tabindex="-1"><a class="header-anchor" href="#\u5341\u4E5D\u3001\u8BA2\u5355\u652F\u4ED8" aria-hidden="true">#</a> \u5341\u4E5D\u3001\u8BA2\u5355\u652F\u4ED8</h1><h1 id="" tabindex="-1"><a class="header-anchor" href="#" aria-hidden="true">#</a></h1><h2 id="_1\u3001\u652F\u4ED8\u5B9D\u6C99\u7BB1" tabindex="-1"><a class="header-anchor" href="#_1\u3001\u652F\u4ED8\u5B9D\u6C99\u7BB1" aria-hidden="true">#</a> 1\u3001\u652F\u4ED8\u5B9D\u6C99\u7BB1</h2><p>https://open.alipay.com/platform/home.htm</p><p>\u6C99\u7BB1\u73AF\u5883\u4F7F\u7528\u8BF4\u660E\uFF1Ahttps://opendocs.alipay.com/support/01razc</p><p>\u652F\u4ED8\u5B9Ddemo\uFF1Ahttps://opendocs.alipay.com/open/270/106291/</p><h2 id="_2\u3001\u52A0\u5BC6-\u5BF9\u79F0\u52A0\u5BC6" tabindex="-1"><a class="header-anchor" href="#_2\u3001\u52A0\u5BC6-\u5BF9\u79F0\u52A0\u5BC6" aria-hidden="true">#</a> 2\u3001\u52A0\u5BC6-\u5BF9\u79F0\u52A0\u5BC6</h2><p><img src="`+x+'" alt="image-20211116215716456"></p><h2 id="_3\u3001\u52A0\u5BC6-\u975E\u5BF9\u79F0\u52A0\u5BC6" tabindex="-1"><a class="header-anchor" href="#_3\u3001\u52A0\u5BC6-\u975E\u5BF9\u79F0\u52A0\u5BC6" aria-hidden="true">#</a> 3\u3001\u52A0\u5BC6-\u975E\u5BF9\u79F0\u52A0\u5BC6</h2><p><img src="'+T+'" alt="image-20211116215727891"></p><h2 id="_4\u3001\u7B7E\u540D" tabindex="-1"><a class="header-anchor" href="#_4\u3001\u7B7E\u540D" aria-hidden="true">#</a> 4\u3001\u7B7E\u540D</h2><p><img src="'+E+`" alt="image-20211116220459730"></p><h2 id="_5\u3001\u5185\u7F51\u7A7F\u900F" tabindex="-1"><a class="header-anchor" href="#_5\u3001\u5185\u7F51\u7A7F\u900F" aria-hidden="true">#</a> 5\u3001\u5185\u7F51\u7A7F\u900F</h2><p>1\u3001natapp: https://natapp.cn/</p><p>2\u3001\u7EED\u65AD:www.zhexi.tech</p><p>3\u3001\u82B1\u751F\u58F3:https://www.oray.com/</p><h2 id="_6\u3001\u6574\u5408\u652F\u4ED8\u5B9D-\u8BA2\u5355\u652F\u4ED8" tabindex="-1"><a class="header-anchor" href="#_6\u3001\u6574\u5408\u652F\u4ED8\u5B9D-\u8BA2\u5355\u652F\u4ED8" aria-hidden="true">#</a> 6\u3001\u6574\u5408\u652F\u4ED8\u5B9D-\u8BA2\u5355\u652F\u4ED8</h2><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alipay.sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>alipay-sdk-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.17.9.ALL<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kong<span class="token punctuation">.</span>yumall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;alipay&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AlipayTemplate</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * \u5E94\u7528ID,\u60A8\u7684APPID\uFF0C\u6536\u6B3E\u8D26\u53F7\u65E2\u662F\u60A8\u7684APPID\u5BF9\u5E94\u652F\u4ED8\u5B9D\u8D26\u53F7
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> app_id<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u5546\u6237\u79C1\u94A5\uFF0C\u60A8\u7684PKCS8\u683C\u5F0FRSA2\u79C1\u94A5
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> merchant_private_key<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u652F\u4ED8\u5B9D\u516C\u94A5,\u67E5\u770B\u5730\u5740\uFF1Ahttps://openhome.alipay.com/platform/keyManage.htm \u5BF9\u5E94APPID\u4E0B\u7684\u652F\u4ED8\u5B9D\u516C\u94A5\u3002
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> alipay_public_key<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u670D\u52A1\u5668[\u5F02\u6B65\u901A\u77E5]\u9875\u9762\u8DEF\u5F84  \u9700http://\u683C\u5F0F\u7684\u5B8C\u6574\u8DEF\u5F84\uFF0C\u4E0D\u80FD\u52A0?id=123\u8FD9\u7C7B\u81EA\u5B9A\u4E49\u53C2\u6570\uFF0C\u5FC5\u987B\u5916\u7F51\u53EF\u4EE5\u6B63\u5E38\u8BBF\u95EE
     * \u652F\u4ED8\u5B9D\u4F1A\u6084\u6084\u7684\u7ED9\u6211\u4EEC\u53D1\u9001\u4E00\u4E2A\u8BF7\u6C42\uFF0C\u544A\u8BC9\u6211\u4EEC\u652F\u4ED8\u6210\u529F\u7684\u4FE1\u606F
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> notify_url<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u9875\u9762\u8DF3\u8F6C\u540C\u6B65\u901A\u77E5\u9875\u9762\u8DEF\u5F84 \u9700http://\u683C\u5F0F\u7684\u5B8C\u6574\u8DEF\u5F84\uFF0C\u4E0D\u80FD\u52A0?id=123\u8FD9\u7C7B\u81EA\u5B9A\u4E49\u53C2\u6570\uFF0C\u5FC5\u987B\u5916\u7F51\u53EF\u4EE5\u6B63\u5E38\u8BBF\u95EE
     * \u540C\u6B65\u901A\u77E5\uFF0C\u652F\u4ED8\u6210\u529F\uFF0C\u4E00\u822C\u8DF3\u8F6C\u5230\u6210\u529F\u9875
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> return_url<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u7B7E\u540D\u65B9\u5F0F
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sign_type<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u5B57\u7B26\u7F16\u7801\u683C\u5F0F
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> charset<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u8BA2\u5355\u8D85\u65F6\u65F6\u95F4
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> timeout <span class="token operator">=</span> <span class="token string">&quot;1m&quot;</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u652F\u4ED8\u5B9D\u7F51\u5173\uFF1B https://openapi.alipaydev.com/gateway.do
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> gatewayUrl<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token class-name">PayVo</span> vo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AlipayApiException</span> <span class="token punctuation">{</span>

        <span class="token comment">//AlipayClient alipayClient = new DefaultAlipayClient(AlipayTemplate.gatewayUrl, AlipayTemplate.app_id, AlipayTemplate.merchant_private_key, &quot;json&quot;, AlipayTemplate.charset, AlipayTemplate.alipay_public_key, AlipayTemplate.sign_type);</span>
        <span class="token comment">//1\u3001\u6839\u636E\u652F\u4ED8\u5B9D\u7684\u914D\u7F6E\u751F\u6210\u4E00\u4E2A\u652F\u4ED8\u5BA2\u6237\u7AEF</span>
        <span class="token class-name">AlipayClient</span> alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span>gatewayUrl<span class="token punctuation">,</span>
                app_id<span class="token punctuation">,</span> merchant_private_key<span class="token punctuation">,</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span>
                charset<span class="token punctuation">,</span> alipay_public_key<span class="token punctuation">,</span> sign_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2\u3001\u521B\u5EFA\u4E00\u4E2A\u652F\u4ED8\u8BF7\u6C42 //\u8BBE\u7F6E\u8BF7\u6C42\u53C2\u6570</span>
        <span class="token class-name">AlipayTradePagePayRequest</span> alipayRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradePagePayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        alipayRequest<span class="token punctuation">.</span><span class="token function">setReturnUrl</span><span class="token punctuation">(</span>return_url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        alipayRequest<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span>notify_url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u5546\u6237\u8BA2\u5355\u53F7\uFF0C\u5546\u6237\u7F51\u7AD9\u8BA2\u5355\u7CFB\u7EDF\u4E2D\u552F\u4E00\u8BA2\u5355\u53F7\uFF0C\u5FC5\u586B</span>
        <span class="token class-name">String</span> out_trade_no <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getOut_trade_no</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u4ED8\u6B3E\u91D1\u989D\uFF0C\u5FC5\u586B</span>
        <span class="token class-name">String</span> total_amount <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getTotal_amount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u8BA2\u5355\u540D\u79F0\uFF0C\u5FC5\u586B</span>
        <span class="token class-name">String</span> subject <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u5546\u54C1\u63CF\u8FF0\uFF0C\u53EF\u7A7A</span>
        <span class="token class-name">String</span> body <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        alipayRequest<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span><span class="token string">&quot;{\\&quot;out_trade_no\\&quot;:\\&quot;&quot;</span> <span class="token operator">+</span> out_trade_no <span class="token operator">+</span> <span class="token string">&quot;\\&quot;,&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;\\&quot;total_amount\\&quot;:\\&quot;&quot;</span> <span class="token operator">+</span> total_amount <span class="token operator">+</span> <span class="token string">&quot;\\&quot;,&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;\\&quot;subject\\&quot;:\\&quot;&quot;</span> <span class="token operator">+</span> subject <span class="token operator">+</span> <span class="token string">&quot;\\&quot;,&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;\\&quot;body\\&quot;:\\&quot;&quot;</span> <span class="token operator">+</span> body <span class="token operator">+</span> <span class="token string">&quot;\\&quot;,&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;\\&quot;timeout_express\\&quot;:\\&quot;&quot;</span> <span class="token operator">+</span> timeout <span class="token operator">+</span> <span class="token string">&quot;\\&quot;,&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;\\&quot;product_code\\&quot;:\\&quot;FAST_INSTANT_TRADE_PAY\\&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">pageExecute</span><span class="token punctuation">(</span>alipayRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u4F1A\u6536\u5230\u652F\u4ED8\u5B9D\u7684\u54CD\u5E94\uFF0C\u54CD\u5E94\u7684\u662F\u4E00\u4E2A\u9875\u9762\uFF0C\u53EA\u8981\u6D4F\u89C8\u5668\u663E\u793A\u8FD9\u4E2A\u9875\u9762\uFF0C\u5C31\u4F1A\u81EA\u52A8\u6765\u5230\u652F\u4ED8\u5B9D\u7684\u6536\u94F6\u53F0\u9875\u9762</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\u652F\u4ED8\u5B9D\u7684\u54CD\u5E94\uFF1A&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#\u652F\u4ED8\u5B9D\u76F8\u5173\u7684\u914D\u7F6E</span>
<span class="token key attr-name">alipay.app_id</span><span class="token punctuation">=</span><span class="token value attr-value">2016102600766009</span>
<span class="token key attr-name">alipay.merchant_private_key</span><span class="token punctuation">=</span><span class="token value attr-value">MIIEvQIB</span>
<span class="token key attr-name">alipay.alipay_public_key</span><span class="token punctuation">=</span><span class="token value attr-value">MIIBIjANBgkqhkiG</span>
<span class="token key attr-name">alipay.notify_url</span><span class="token punctuation">=</span><span class="token value attr-value">http://hjl.mynatapp.cc/payed/notify</span>
<span class="token key attr-name">alipay.return_url</span><span class="token punctuation">=</span><span class="token value attr-value">http://member.yumall.com/memberOrder.html</span>
<span class="token key attr-name">alipay.sign_type</span><span class="token punctuation">=</span><span class="token value attr-value">RSA2</span>
<span class="token key attr-name">alipay.charset</span><span class="token punctuation">=</span><span class="token value attr-value">utf-8</span>
<span class="token key attr-name">alipay.gatewayUrl</span><span class="token punctuation">=</span><span class="token value attr-value">https://openapi.alipaydev.com/gateway.do</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u7528\u6237\u4E0B\u5355:\u652F\u4ED8\u5B9D\u652F\u4ED8
 * 1\u3001\u8BA9\u652F\u4ED8\u9875\u8BA9\u6D4F\u89C8\u5668\u5C55\u793A
 * 2\u3001\u652F\u4ED8\u6210\u529F\u4EE5\u540E\uFF0C\u8DF3\u8F6C\u5230\u7528\u6237\u7684\u8BA2\u5355\u5217\u8868\u9875
 * <span class="token keyword">@param</span> <span class="token parameter">orderSn</span>
 * <span class="token keyword">@return</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">AlipayApiException</span></span>
 */</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/aliPayOrder&quot;</span><span class="token punctuation">,</span>produces <span class="token operator">=</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">aliPayOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;orderSn&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderSn<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AlipayApiException</span> <span class="token punctuation">{</span>

    <span class="token class-name">PayVo</span> payVo <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">getOrderPay</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> pay <span class="token operator">=</span> alipayTemplate<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span>payVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pay<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pay<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">PayVo</span> <span class="token function">getOrderPay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderSn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">PayVo</span> payVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderEntity</span> orderInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOrderByOrderSn</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//\u4FDD\u7559\u4E24\u4F4D\u5C0F\u6570\u70B9\uFF0C\u5411\u4E0A\u53D6\u503C</span>
    <span class="token class-name">BigDecimal</span> payAmount <span class="token operator">=</span> orderInfo<span class="token punctuation">.</span><span class="token function">getPayAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span>ROUND_UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    payVo<span class="token punctuation">.</span><span class="token function">setTotal_amount</span><span class="token punctuation">(</span>payAmount<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payVo<span class="token punctuation">.</span><span class="token function">setOut_trade_no</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//\u67E5\u8BE2\u8BA2\u5355\u9879\u7684\u6570\u636E</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">&gt;</span></span> orderItemInfo <span class="token operator">=</span> orderItemService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;order_sn&quot;</span><span class="token punctuation">,</span> orderSn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderItemEntity</span> orderItemEntity <span class="token operator">=</span> orderItemInfo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payVo<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>orderItemEntity<span class="token punctuation">.</span><span class="token function">getSkuAttrsVals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    payVo<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>orderItemEntity<span class="token punctuation">.</span><span class="token function">getSkuName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> payVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7\u3001\u8BA2\u5355\u652F\u4ED8\u6210\u529F\u76D1\u542C\u5668-\u901A\u77E5" tabindex="-1"><a class="header-anchor" href="#_7\u3001\u8BA2\u5355\u652F\u4ED8\u6210\u529F\u76D1\u542C\u5668-\u901A\u77E5" aria-hidden="true">#</a> 7\u3001\u8BA2\u5355\u652F\u4ED8\u6210\u529F\u76D1\u542C\u5668\uFF08\u901A\u77E5\uFF09</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderPayedListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AlipayTemplate</span> alipayTemplate<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/payed/notify&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleAlipayed</span><span class="token punctuation">(</span><span class="token class-name">PayAsyncVo</span> asyncVo<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AlipayApiException</span><span class="token punctuation">,</span> <span class="token class-name">UnsupportedEncodingException</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u53EA\u8981\u6536\u5230\u652F\u4ED8\u5B9D\u7684\u5F02\u6B65\u901A\u77E5\uFF0C\u8FD4\u56DE success \u652F\u4ED8\u5B9D\u4FBF\u4E0D\u518D\u901A\u77E5</span>
        <span class="token comment">// \u83B7\u53D6\u652F\u4ED8\u5B9DPOST\u8FC7\u6765\u53CD\u9988\u4FE1\u606F</span>
        <span class="token comment">//TODO \u9700\u8981\u9A8C\u7B7E</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> name <span class="token operator">:</span> requestParams<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> valueStr <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                valueStr <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> values<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                        <span class="token operator">:</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//\u4E71\u7801\u89E3\u51B3\uFF0C\u8FD9\u6BB5\u4EE3\u7801\u5728\u51FA\u73B0\u4E71\u7801\u65F6\u4F7F\u7528</span>
            <span class="token comment">// valueStr = new String(valueStr.getBytes(&quot;ISO-8859-1&quot;), &quot;utf-8&quot;);</span>
            params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> valueStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> signVerified <span class="token operator">=</span> <span class="token class-name">AlipaySignature</span><span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> alipayTemplate<span class="token punctuation">.</span><span class="token function">getAlipay_public_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                alipayTemplate<span class="token punctuation">.</span><span class="token function">getCharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alipayTemplate<span class="token punctuation">.</span><span class="token function">getSign_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u8C03\u7528SDK\u9A8C\u8BC1\u7B7E\u540D</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>signVerified<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\u7B7E\u540D\u9A8C\u8BC1\u6210\u529F...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u53BB\u4FEE\u6539\u8BA2\u5355\u72B6\u6001</span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">handlePayResult</span><span class="token punctuation">(</span>asyncVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\u7B7E\u540D\u9A8C\u8BC1\u5931\u8D25...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/pay/notify&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">asyncNotify</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">String</span> notifyData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u5F02\u6B65\u901A\u77E5\u7ED3\u679C</span>
        <span class="token keyword">return</span> orderService<span class="token punctuation">.</span><span class="token function">asyncNotify</span><span class="token punctuation">(</span>notifyData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>location /static/ {
       root   /usr/share/nginx/html;
    }
    location /payed/  {
       proxy_set_header Host order.gulimall.com;
       proxy_pass http://gulimall;
    }

    location / {
       proxy_set_header Host $host;
       proxy_pass http://gulimall;
    }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8\u3001\u5FAE\u4FE1\u652F\u4ED8" tabindex="-1"><a class="header-anchor" href="#_8\u3001\u5FAE\u4FE1\u652F\u4ED8" aria-hidden="true">#</a> 8\u3001\u5FAE\u4FE1\u652F\u4ED8</h2><h2 id="-1" tabindex="-1"><a class="header-anchor" href="#-1" aria-hidden="true">#</a></h2><h1 id="\u4E8C\u5341\u3001\u79D2\u6740\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#\u4E8C\u5341\u3001\u79D2\u6740\u670D\u52A1" aria-hidden="true">#</a> \u4E8C\u5341\u3001\u79D2\u6740\u670D\u52A1</h1><p><img src="`+C+'" alt="image-20211118125418053"></p><h2 id="_1\u3001\u5B9A\u65F6\u4EFB\u52A1-cron" tabindex="-1"><a class="header-anchor" href="#_1\u3001\u5B9A\u65F6\u4EFB\u52A1-cron" aria-hidden="true">#</a> 1\u3001\u5B9A\u65F6\u4EFB\u52A1 cron</h2><p>http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html</p><p>\u8BED\u6CD5: \u79D2 \u5206 \u65F6 \u65E5 \u6708 \u5468 \u5E74(Spring\u4E0D\u652F\u6301)</p><p><img src="'+j+'" alt="image-20211118130052716"></p><p><img src="'+V+'" alt="image-20211118130031288"></p><img src="'+O+`" alt="image-20211118130142204" style="zoom:95%;"><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u5B9A\u65F6\u4EFB\u52A1
 * 1\u3001@EnableScheduling \u5F00\u542F\u5B9A\u65F6\u4EFB\u52A1
 * 2\u3001@Scheduled\u5F00\u542F\u4E00\u4E2A\u5B9A\u65F6\u4EFB\u52A1
 * 3\u3001\u81EA\u52A8\u914D\u7F6E\u7C7BTaskSchedulingAutoConfiguration
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * \u5F02\u6B65\u4EFB\u52A1
 * 1\u3001@EnableAsync:\u5F00\u542F\u5F02\u6B65\u4EFB\u52A1
 * 2\u3001@Async\uFF1A\u7ED9\u5E0C\u671B\u5F02\u6B65\u6267\u884C\u7684\u65B9\u6CD5\u6807\u6CE8
 * 3\u3001\u81EA\u52A8\u914D\u7F6E\u7C7BTaslExecutionAutoConfiguration
 */</span>
<span class="token doc-comment comment">/**
 * 1\u3001\u5728Spring\u4E2D\u8868\u8FBE\u5F0F\u662F6\u4F4D\u7EC4\u6210\uFF0C\u4E0D\u5141\u8BB8\u7B2C\u4E03\u4F4D\u7684\u5E74\u4EFD
 * 2\u3001\u5728\u5468\u51E0\u7684\u7684\u4F4D\u7F6E,1-7\u4EE3\u8868\u5468\u4E00\u5230\u5468\u65E5
 * 3\u3001\u5B9A\u65F6\u4EFB\u52A1\u4E0D\u8BE5\u963B\u585E\u3002\u9ED8\u8BA4\u662F\u963B\u585E\u7684
 *      1\uFF09\u3001\u53EF\u4EE5\u8BA9\u4E1A\u52A1\u4EE5\u5F02\u6B65\u7684\u65B9\u5F0F\uFF0C\u81EA\u5DF1\u63D0\u4EA4\u5230\u7EBF\u7A0B\u6C60
 *              CompletableFuture.runAsync(() -&gt; <span class="token punctuation">{</span>
 *         <span class="token punctuation">}</span>,execute);
 *
 *      2\uFF09\u3001\u652F\u6301\u5B9A\u65F6\u4EFB\u52A1\u7EBF\u7A0B\u6C60\uFF1B\u8BBE\u7F6E TaskSchedulingProperties
 *        spring.task.scheduling.pool.size: 5
 *
 *      3\uFF09\u3001\u8BA9\u5B9A\u65F6\u4EFB\u52A1\u5F02\u6B65\u6267\u884C
 *          \u5F02\u6B65\u4EFB\u52A1
 *
 *      \u89E3\u51B3\uFF1A\u4F7F\u7528\u5F02\u6B65\u4EFB\u52A1 + \u5B9A\u65F6\u4EFB\u52A1\u6765\u5B8C\u6210\u5B9A\u65F6\u4EFB\u52A1\u4E0D\u963B\u585E\u7684\u529F\u80FD
 *
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token comment">// @EnableAsync</span>
<span class="token annotation punctuation">@EnableScheduling</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloScheduled</span> <span class="token punctuation">{</span>
     <span class="token annotation punctuation">@Async</span>
     <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;*/5 * * ? * 4&quot;</span><span class="token punctuation">)</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;hello...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2\u3001\u4E0A\u67B6\u79D2\u6740\u5546\u54C1" tabindex="-1"><a class="header-anchor" href="#_2\u3001\u4E0A\u67B6\u79D2\u6740\u5546\u54C1" aria-hidden="true">#</a> 2\u3001\u4E0A\u67B6\u79D2\u6740\u5546\u54C1</h2><h3 id="\u5B9A\u65F6\u4EFB\u52A1-seckillscheduled" tabindex="-1"><a class="header-anchor" href="#\u5B9A\u65F6\u4EFB\u52A1-seckillscheduled" aria-hidden="true">#</a> \u5B9A\u65F6\u4EFB\u52A1 SeckillScheduled</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u79D2\u6740\u5546\u54C1\u5B9A\u65F6\u4E0A\u67B6
 * \u6BCF\u5929\u665A\u4E0A3\u70B9\uFF0C\u4E0A\u67B6\u6700\u8FD1\u4E09\u5929\u9700\u8981\u4E09\u5929\u79D2\u6740\u7684\u5546\u54C1
 * \u5F53\u592900:00:00 - 23:59:59
 * \u660E\u592900:00:00 - 23:59:59
 * \u540E\u592900:00:00 - 23:59:59
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillScheduled</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SeckillService</span> seckillService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

    <span class="token comment">//\u79D2\u6740\u5546\u54C1\u4E0A\u67B6\u529F\u80FD\u7684\u9501</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> upload_lock <span class="token operator">=</span> <span class="token string">&quot;seckill:upload:lock&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">//TODO \u4FDD\u8BC1\u5E42\u7B49\u6027\u95EE\u9898</span>
    <span class="token comment">// @Scheduled(cron = &quot;*/5 * * * * ? &quot;)</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0 0 1/1 * * ? &quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadSeckillSkuLatest3Days</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1\u3001\u91CD\u590D\u4E0A\u67B6\u65E0\u9700\u5904\u7406</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u4E0A\u67B6\u79D2\u6740\u7684\u5546\u54C1...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u5206\u5E03\u5F0F\u9501</span>
        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span>upload_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u52A0\u9501</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            seckillService<span class="token punctuation">.</span><span class="token function">uploadSeckillSkuLatest3Days</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u8981\u53C2\u52A0\u4E09\u5929\u7684\u5546\u54C1\u79D2\u6740\u6D3B\u52A8-uploadseckillskulatest3days" tabindex="-1"><a class="header-anchor" href="#\u8981\u53C2\u52A0\u4E09\u5929\u7684\u5546\u54C1\u79D2\u6740\u6D3B\u52A8-uploadseckillskulatest3days" aria-hidden="true">#</a> \u8981\u53C2\u52A0\u4E09\u5929\u7684\u5546\u54C1\u79D2\u6740\u6D3B\u52A8 uploadSeckillSkuLatest3Days</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadSeckillSkuLatest3Days</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//1\u3001\u626B\u63CF\u6700\u8FD1\u4E09\u5929\u7684\u5546\u54C1\u9700\u8981\u53C2\u52A0\u79D2\u6740\u7684\u6D3B\u52A8</span>
    <span class="token class-name">R</span> lates3DaySession <span class="token operator">=</span> couponFeignService<span class="token punctuation">.</span><span class="token function">getLates3DaySession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lates3DaySession<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u4E0A\u67B6\u5546\u54C1</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionWithSkusVo</span><span class="token punctuation">&gt;</span></span> sessionData <span class="token operator">=</span> lates3DaySession<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionWithSkusVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u7F13\u5B58\u5230Redis</span>
        <span class="token comment">//1\u3001\u7F13\u5B58\u6D3B\u52A8\u4FE1\u606F</span>
        <span class="token function">saveSessionInfos</span><span class="token punctuation">(</span>sessionData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2\u3001\u7F13\u5B58\u6D3B\u52A8\u7684\u5173\u8054\u5546\u54C1\u4FE1\u606F</span>
        <span class="token function">saveSessionSkuInfo</span><span class="token punctuation">(</span>sessionData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * \u7F13\u5B58\u79D2\u6740\u6D3B\u52A8\u4FE1\u606F
 *
 * <span class="token keyword">@param</span> <span class="token parameter">sessions</span>
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveSessionInfos</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionWithSkusVo</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    sessions<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>session <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

        <span class="token comment">//\u83B7\u53D6\u5F53\u524D\u6D3B\u52A8\u7684\u5F00\u59CB\u548C\u7ED3\u675F\u65F6\u95F4\u7684\u65F6\u95F4\u6233</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> endTime <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u5B58\u5165\u5230Redis\u4E2D\u7684key</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> SESSION__CACHE_PREFIX <span class="token operator">+</span> startTime <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> endTime<span class="token punctuation">;</span>

        <span class="token comment">//\u5224\u65ADRedis\u4E2D\u662F\u5426\u6709\u8BE5\u4FE1\u606F\uFF0C\u5982\u679C\u6CA1\u6709\u624D\u8FDB\u884C\u6DFB\u52A0</span>
        <span class="token class-name">Boolean</span> hasKey <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u7F13\u5B58\u6D3B\u52A8\u4FE1\u606F</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u83B7\u53D6\u5230\u6D3B\u52A8\u4E2D\u6240\u6709\u5546\u54C1\u7684skuId</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> skuIds <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getRelationSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getPromotionSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> item<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">leftPushAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * \u7F13\u5B58\u79D2\u6740\u6D3B\u52A8\u6240\u5173\u8054\u7684\u5546\u54C1\u4FE1\u606F
 *
 * <span class="token keyword">@param</span> <span class="token parameter">sessions</span>
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveSessionSkuInfo</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionWithSkusVo</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    sessions<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>session <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u51C6\u5907hash\u64CD\u4F5C\uFF0C\u7ED1\u5B9Ahash</span>
        <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> operations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span>SECKILL_CHARE_PREFIX<span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">getRelationSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>seckillSkuVo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u751F\u6210\u968F\u673A\u7801</span>
            <span class="token class-name">String</span> token <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> redisKey <span class="token operator">=</span> seckillSkuVo<span class="token punctuation">.</span><span class="token function">getPromotionSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> seckillSkuVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>operations<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">//\u7F13\u5B58\u6211\u4EEC\u5546\u54C1\u4FE1\u606F</span>
                <span class="token class-name">SeckillSkuRedisTo</span> redisTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Long</span> skuId <span class="token operator">=</span> seckillSkuVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//1\u3001\u5148\u67E5\u8BE2sku\u7684\u57FA\u672C\u4FE1\u606F\uFF0C\u8C03\u7528\u8FDC\u7A0B\u670D\u52A1</span>
                <span class="token class-name">R</span> info <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">getSkuInfo</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SkuInfoVo</span> skuInfo <span class="token operator">=</span> info<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;skuInfo&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoVo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    redisTo<span class="token punctuation">.</span><span class="token function">setSkuInfo</span><span class="token punctuation">(</span>skuInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//2\u3001sku\u7684\u79D2\u6740\u4FE1\u606F</span>
                <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>seckillSkuVo<span class="token punctuation">,</span> redisTo<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//3\u3001\u8BBE\u7F6E\u5F53\u524D\u5546\u54C1\u7684\u79D2\u6740\u65F6\u95F4\u4FE1\u606F</span>
                redisTo<span class="token punctuation">.</span><span class="token function">setStartTime</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                redisTo<span class="token punctuation">.</span><span class="token function">setEndTime</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//4\u3001\u8BBE\u7F6E\u5546\u54C1\u7684\u968F\u673A\u7801\uFF08\u9632\u6B62\u6076\u610F\u653B\u51FB\uFF09</span>
                redisTo<span class="token punctuation">.</span><span class="token function">setRandomCode</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//\u5E8F\u5217\u5316json\u683C\u5F0F\u5B58\u5165Redis\u4E2D</span>
                <span class="token class-name">String</span> seckillValue <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>redisTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                operations<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>seckillSkuVo<span class="token punctuation">.</span><span class="token function">getPromotionSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> seckillSkuVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seckillValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//\u5982\u679C\u5F53\u524D\u8FD9\u4E2A\u573A\u6B21\u7684\u5546\u54C1\u5E93\u5B58\u4FE1\u606F\u5DF2\u7ECF\u4E0A\u67B6\u5C31\u4E0D\u9700\u8981\u4E0A\u67B6</span>
                <span class="token comment">//5\u3001\u4F7F\u7528\u5E93\u5B58\u4F5C\u4E3A\u5206\u5E03\u5F0FRedisson\u4FE1\u53F7\u91CF\uFF08\u9650\u6D41\uFF09</span>
                <span class="token comment">// \u4F7F\u7528\u5E93\u5B58\u4F5C\u4E3A\u5206\u5E03\u5F0F\u4FE1\u53F7\u91CF</span>
                <span class="token class-name">RSemaphore</span> semaphore <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span>SKU_STOCK_SEMAPHORE <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u5546\u54C1\u53EF\u4EE5\u79D2\u6740\u7684\u6570\u91CF\u4F5C\u4E3A\u4FE1\u53F7\u91CF</span>
                semaphore<span class="token punctuation">.</span><span class="token function">trySetPermits</span><span class="token punctuation">(</span>seckillSkuVo<span class="token punctuation">.</span><span class="token function">getSeckillCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>@FeignClient(&quot;yumall-coupon&quot;)---------coupon/seckillsession/Lates3DaySession</p><h3 id="\u67E5\u8BE2\u6700\u8FD1\u4E09\u5929\u9700\u8981\u53C2\u52A0\u79D2\u6740\u5546\u54C1\u7684\u4FE1\u606F-getlates3daysession" tabindex="-1"><a class="header-anchor" href="#\u67E5\u8BE2\u6700\u8FD1\u4E09\u5929\u9700\u8981\u53C2\u52A0\u79D2\u6740\u5546\u54C1\u7684\u4FE1\u606F-getlates3daysession" aria-hidden="true">#</a> \u67E5\u8BE2\u6700\u8FD1\u4E09\u5929\u9700\u8981\u53C2\u52A0\u79D2\u6740\u5546\u54C1\u7684\u4FE1\u606F getLates3DaySession</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLates3DaySession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//\u8BA1\u7B97\u6700\u8FD1\u4E09\u5929</span>
<span class="token comment">//\u67E5\u51FA\u8FD9\u4E09\u5929\u53C2\u4E0E\u79D2\u6740\u6D3B\u52A8\u7684\u5546\u54C1</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionEntity</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token string">&quot;start_time&quot;</span><span class="token punctuation">,</span> <span class="token function">startTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">endTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionEntity</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>session <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u67E5\u51FAsms_seckill_sku_relation\u8868\u4E2D\u5173\u8054\u7684skuId</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRelationEntity</span><span class="token punctuation">&gt;</span></span> relationSkus <span class="token operator">=</span> seckillSkuRelationService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRelationEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;promotion_session_id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">setRelationSkus</span><span class="token punctuation">(</span>relationSkus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> session<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> collect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token doc-comment comment">/**
     * \u5F53\u524D\u65F6\u95F4
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">startTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LocalDate</span> now <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalTime</span> min <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span>MIN<span class="token punctuation">;</span>
        <span class="token class-name">LocalDateTime</span> start <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> min<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u683C\u5F0F\u5316\u65F6\u95F4</span>
        <span class="token keyword">return</span> start<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u7ED3\u675F\u65F6\u95F4
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">endTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LocalDate</span> now <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalDate</span> plus <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalTime</span> max <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span>MAX<span class="token punctuation">;</span>
        <span class="token class-name">LocalDateTime</span> end <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>plus<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u683C\u5F0F\u5316\u65F6\u95F4</span>
        <span class="token keyword">return</span> end<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3\u3001\u83B7\u53D6\u5230\u5F53\u524D\u53EF\u4EE5\u53C2\u52A0\u79D2\u6740\u5546\u54C1\u7684\u4FE1\u606F-getcurrentseckillskus" tabindex="-1"><a class="header-anchor" href="#_3\u3001\u83B7\u53D6\u5230\u5F53\u524D\u53EF\u4EE5\u53C2\u52A0\u79D2\u6740\u5546\u54C1\u7684\u4FE1\u606F-getcurrentseckillskus" aria-hidden="true">#</a> 3\u3001\u83B7\u53D6\u5230\u5F53\u524D\u53EF\u4EE5\u53C2\u52A0\u79D2\u6740\u5546\u54C1\u7684\u4FE1\u606F getCurrentSeckillSkus</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;getCurrentSeckillSkusResource&quot;</span><span class="token punctuation">,</span> blockHandler <span class="token operator">=</span> <span class="token string">&quot;blockHandler&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCurrentSeckillSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">&quot;seckillSkus&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1\u3001\u786E\u5B9A\u5F53\u524D\u5C5E\u4E8E\u54EA\u4E2A\u79D2\u6740\u573A\u6B21</span>
        <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u4ECERedis\u4E2D\u67E5\u8BE2\u5230\u6240\u6709key\u4EE5seckill:sessions\u5F00\u5934\u7684\u6240\u6709\u6570\u636E</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>SESSION__CACHE_PREFIX <span class="token operator">+</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//seckill:sessions:1594396764000_1594453242000</span>
            <span class="token class-name">String</span> replace <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>SESSION__CACHE_PREFIX<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> replace<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u83B7\u53D6\u5B58\u5165Redis\u5546\u54C1\u7684\u5F00\u59CB\u65F6\u95F4</span>
            <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u83B7\u53D6\u5B58\u5165Redis\u5546\u54C1\u7684\u7ED3\u675F\u65F6\u95F4</span>
            <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u5224\u65AD\u662F\u5426\u662F\u5F53\u524D\u79D2\u6740\u573A\u6B21</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">&gt;=</span> startTime <span class="token operator">&amp;&amp;</span> currentTime <span class="token operator">&lt;=</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//2\u3001\u83B7\u53D6\u8FD9\u4E2A\u79D2\u6740\u573A\u6B21\u9700\u8981\u7684\u6240\u6709\u5546\u54C1\u4FE1\u606F</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> range <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hasOps <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span>SECKILL_CHARE_PREFIX<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">assert</span> range <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> listValue <span class="token operator">=</span> hasOps<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>listValue <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> listValue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> listValue<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token class-name">String</span> items <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> item<span class="token punctuation">;</span>
                        <span class="token class-name">SeckillSkuRedisTo</span> redisTo <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> <span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// redisTo.setRandomCode(null);\u5F53\u524D\u79D2\u6740\u5F00\u59CB\u9700\u8981\u968F\u673A\u7801</span>
                        <span class="token keyword">return</span> redisTo<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> collect<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u8D44\u6E90\u88AB\u9650\u6D41{}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> <span class="token function">blockHandler</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;getCurrentSeckillSkusResource\u88AB\u9650\u6D41\u4E86,{}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4\u3001\u6839\u636Eskuid\u67E5\u8BE2\u5546\u54C1\u662F\u5426\u53C2\u52A0\u79D2\u6740\u6D3B\u52A8" tabindex="-1"><a class="header-anchor" href="#_4\u3001\u6839\u636Eskuid\u67E5\u8BE2\u5546\u54C1\u662F\u5426\u53C2\u52A0\u79D2\u6740\u6D3B\u52A8" aria-hidden="true">#</a> 4\u3001\u6839\u636EskuId\u67E5\u8BE2\u5546\u54C1\u662F\u5426\u53C2\u52A0\u79D2\u6740\u6D3B\u52A8</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SeckillSkuRedisTo</span> <span class="token function">getSkuSeckilInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//1\u3001\u627E\u5230\u6240\u6709\u9700\u8981\u79D2\u6740\u7684\u5546\u54C1\u7684key\u4FE1\u606F---seckill:skus</span>
    <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hashOps <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span>SECKILL_CHARE_PREFIX<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//\u62FF\u5230\u6240\u6709\u7684key</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> hashOps<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keys <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//4-45 \u6B63\u5219\u8868\u8FBE\u5F0F\u8FDB\u884C\u5339\u914D</span>
        <span class="token class-name">String</span> reg <span class="token operator">=</span> <span class="token string">&quot;\\\\d-&quot;</span> <span class="token operator">+</span> skuId<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u5982\u679C\u5339\u914D\u4E0A\u4E86</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//\u4ECERedis\u4E2D\u53D6\u51FA\u6570\u636E\u6765</span>
                <span class="token class-name">String</span> redisValue <span class="token operator">=</span> hashOps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8FDB\u884C\u5E8F\u5217\u5316</span>
                <span class="token class-name">SeckillSkuRedisTo</span> redisTo <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>redisValue<span class="token punctuation">,</span> <span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//\u968F\u673A\u7801</span>
                <span class="token class-name">Long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Long</span> startTime <span class="token operator">=</span> redisTo<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Long</span> endTime <span class="token operator">=</span> redisTo<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u5982\u679C\u5F53\u524D\u65F6\u95F4\u5927\u4E8E\u7B49\u4E8E\u79D2\u6740\u6D3B\u52A8\u5F00\u59CB\u65F6\u95F4\u5E76\u4E14\u8981\u5C0F\u4E8E\u6D3B\u52A8\u7ED3\u675F\u65F6\u95F4</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">&gt;=</span> startTime <span class="token operator">&amp;&amp;</span> currentTime <span class="token operator">&lt;=</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> redisTo<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                redisTo<span class="token punctuation">.</span><span class="token function">setRandomCode</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> redisTo<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5\u3001\u5F53\u524D\u5546\u54C1\u8FDB\u884C\u79D2\u6740-\u79D2\u6740\u5F00\u59CB" tabindex="-1"><a class="header-anchor" href="#_5\u3001\u5F53\u524D\u5546\u54C1\u8FDB\u884C\u79D2\u6740-\u79D2\u6740\u5F00\u59CB" aria-hidden="true">#</a> 5\u3001\u5F53\u524D\u5546\u54C1\u8FDB\u884C\u79D2\u6740\uFF08\u79D2\u6740\u5F00\u59CB\uFF09</h2><p><img src="`+R+`" alt="image-20211118141952959"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">kill</span><span class="token punctuation">(</span><span class="token class-name">String</span> killId<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

    <span class="token keyword">long</span> s1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u83B7\u53D6\u5F53\u524D\u7528\u6237\u7684\u4FE1\u606F</span>
    <span class="token class-name">MemberResponseVo</span> user <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//1\u3001\u83B7\u53D6\u5F53\u524D\u79D2\u6740\u5546\u54C1\u7684\u8BE6\u7EC6\u4FE1\u606F\u4ECERedis\u4E2D\u83B7\u53D6</span>
    <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hashOps <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span>SECKILL_CHARE_PREFIX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> skuInfoValue <span class="token operator">=</span> hashOps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>killId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>skuInfoValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//(\u5408\u6CD5\u6027\u6548\u9A8C)</span>
    <span class="token class-name">SeckillSkuRedisTo</span> redisTo <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>skuInfoValue<span class="token punctuation">,</span> <span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> startTime <span class="token operator">=</span> redisTo<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> endTime <span class="token operator">=</span> redisTo<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u5224\u65AD\u5F53\u524D\u8FD9\u4E2A\u79D2\u6740\u8BF7\u6C42\u662F\u5426\u5728\u6D3B\u52A8\u65F6\u95F4\u533A\u95F4\u5185(\u6548\u9A8C\u65F6\u95F4\u7684\u5408\u6CD5\u6027)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">&gt;=</span> startTime <span class="token operator">&amp;&amp;</span> currentTime <span class="token operator">&lt;=</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//2\u3001\u6548\u9A8C\u968F\u673A\u7801\u548C\u5546\u54C1id</span>
        <span class="token class-name">String</span> randomCode <span class="token operator">=</span> redisTo<span class="token punctuation">.</span><span class="token function">getRandomCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> skuId <span class="token operator">=</span> redisTo<span class="token punctuation">.</span><span class="token function">getPromotionSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> redisTo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>randomCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> killId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//3\u3001\u9A8C\u8BC1\u8D2D\u7269\u6570\u91CF\u662F\u5426\u5408\u7406\u548C\u5E93\u5B58\u91CF\u662F\u5426\u5145\u8DB3</span>
            <span class="token class-name">Integer</span> seckillLimit <span class="token operator">=</span> redisTo<span class="token punctuation">.</span><span class="token function">getSeckillLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//\u83B7\u53D6\u4FE1\u53F7\u91CF</span>
            <span class="token class-name">String</span> seckillCount <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>SKU_STOCK_SEMAPHORE <span class="token operator">+</span> randomCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>seckillCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u5224\u65AD\u4FE1\u53F7\u91CF\u662F\u5426\u5927\u4E8E0,\u5E76\u4E14\u4E70\u7684\u6570\u91CF\u4E0D\u80FD\u8D85\u8FC7\u5E93\u5B58</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> num <span class="token operator">&lt;=</span> seckillLimit <span class="token operator">&amp;&amp;</span> count <span class="token operator">&gt;</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//4\u3001\u9A8C\u8BC1\u8FD9\u4E2A\u4EBA\u662F\u5426\u5DF2\u7ECF\u4E70\u8FC7\u4E86\uFF08\u5E42\u7B49\u6027\u5904\u7406\uFF09,\u5982\u679C\u79D2\u6740\u6210\u529F\uFF0C\u5C31\u53BB\u5360\u4F4D\u3002userId-sessionId-skuId</span>
                <span class="token comment">//SETNX \u539F\u5B50\u6027\u5904\u7406</span>
                <span class="token class-name">String</span> redisKey <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> skuId<span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6E\u81EA\u52A8\u8FC7\u671F(\u6D3B\u52A8\u7ED3\u675F\u65F6\u95F4-\u5F53\u524D\u65F6\u95F4)</span>
                <span class="token class-name">Long</span> ttl <span class="token operator">=</span> endTime <span class="token operator">-</span> currentTime<span class="token punctuation">;</span>
                <span class="token class-name">Boolean</span> aBoolean <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> num<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>aBoolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//\u5360\u4F4D\u6210\u529F\u8BF4\u660E\u4ECE\u6765\u6CA1\u6709\u4E70\u8FC7,\u5206\u5E03\u5F0F\u9501(\u83B7\u53D6\u4FE1\u53F7\u91CF-1)</span>
                    <span class="token class-name">RSemaphore</span> semaphore <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span>SKU_STOCK_SEMAPHORE <span class="token operator">+</span> randomCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//TODO \u79D2\u6740\u6210\u529F\uFF0C\u5FEB\u901F\u4E0B\u5355</span>
                    <span class="token keyword">boolean</span> semaphoreCount <span class="token operator">=</span> semaphore<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//\u4FDD\u8BC1Redis\u4E2D\u8FD8\u6709\u5546\u54C1\u5E93\u5B58</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>semaphoreCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//\u521B\u5EFA\u8BA2\u5355\u53F7\u548C\u8BA2\u5355\u4FE1\u606F\u53D1\u9001\u7ED9MQ</span>
                        <span class="token comment">// \u79D2\u6740\u6210\u529F \u5FEB\u901F\u4E0B\u5355 \u53D1\u9001\u6D88\u606F\u5230 MQ \u6574\u4E2A\u64CD\u4F5C\u65F6\u95F4\u5728 10ms \u5DE6\u53F3</span>
                        <span class="token class-name">String</span> timeId <span class="token operator">=</span> <span class="token class-name">IdWorker</span><span class="token punctuation">.</span><span class="token function">getTimeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">SeckillOrderTo</span> orderTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeckillOrderTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        orderTo<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>timeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        orderTo<span class="token punctuation">.</span><span class="token function">setMemberId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        orderTo<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        orderTo<span class="token punctuation">.</span><span class="token function">setPromotionSessionId</span><span class="token punctuation">(</span>redisTo<span class="token punctuation">.</span><span class="token function">getPromotionSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        orderTo<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>redisTo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        orderTo<span class="token punctuation">.</span><span class="token function">setSeckillPrice</span><span class="token punctuation">(</span>redisTo<span class="token punctuation">.</span><span class="token function">getSeckillPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;order.seckill.order&quot;</span><span class="token punctuation">,</span> orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">long</span> s2 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u8017\u65F6...&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>s2 <span class="token operator">-</span> s1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> timeId<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> s3 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u8017\u65F6...&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>s3 <span class="token operator">-</span> s1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6\u3001mq-\u79D2\u6740\u76D1\u542C" tabindex="-1"><a class="header-anchor" href="#_6\u3001mq-\u79D2\u6740\u76D1\u542C" aria-hidden="true">#</a> 6\u3001MQ \u79D2\u6740\u76D1\u542C</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;order.seckill.order.queue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderSeckillListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RabbitHandler</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token class-name">SeckillOrderTo</span> orderTo<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u51C6\u5907\u521B\u5EFA\u79D2\u6740\u5355\u7684\u8BE6\u7EC6\u4FE1\u606F...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u521B\u5EFA\u79D2\u6740\u5355</span>
            orderService<span class="token punctuation">.</span><span class="token function">createSeckillOrder</span><span class="token punctuation">(</span>orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createSeckillOrder</span><span class="token punctuation">(</span><span class="token class-name">SeckillOrderTo</span> orderTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//TODO \u4FDD\u5B58\u8BA2\u5355\u4FE1\u606F</span>
    <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>orderTo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setMemberId</span><span class="token punctuation">(</span>orderTo<span class="token punctuation">.</span><span class="token function">getMemberId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BigDecimal</span> totalPrice <span class="token operator">=</span> orderTo<span class="token punctuation">.</span><span class="token function">getSeckillPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>orderTo<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setPayAmount</span><span class="token punctuation">(</span>totalPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span>CREATE_NEW<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//\u4FDD\u5B58\u8BA2\u5355</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//\u4FDD\u5B58\u8BA2\u5355\u9879\u4FE1\u606F</span>
    <span class="token class-name">OrderItemEntity</span> orderItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItemEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderItem<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>orderTo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderItem<span class="token punctuation">.</span><span class="token function">setRealAmount</span><span class="token punctuation">(</span>totalPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>

    orderItem<span class="token punctuation">.</span><span class="token function">setSkuQuantity</span><span class="token punctuation">(</span>orderTo<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//\u4FDD\u5B58\u5546\u54C1\u7684spu\u4FE1\u606F</span>
    <span class="token class-name">R</span> spuInfo <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">getSpuInfoBySkuId</span><span class="token punctuation">(</span>orderTo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SpuInfoVo</span> spuInfoData <span class="token operator">=</span> spuInfo<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpuInfoVo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderItem<span class="token punctuation">.</span><span class="token function">setSpuId</span><span class="token punctuation">(</span>spuInfoData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderItem<span class="token punctuation">.</span><span class="token function">setSpuName</span><span class="token punctuation">(</span>spuInfoData<span class="token punctuation">.</span><span class="token function">getSpuName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderItem<span class="token punctuation">.</span><span class="token function">setSpuBrand</span><span class="token punctuation">(</span>spuInfoData<span class="token punctuation">.</span><span class="token function">getBrandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderItem<span class="token punctuation">.</span><span class="token function">setCategoryId</span><span class="token punctuation">(</span>spuInfoData<span class="token punctuation">.</span><span class="token function">getCatalogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//\u4FDD\u5B58\u8BA2\u5355\u9879\u6570\u636E</span>
    orderItemService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7\u3001\u79D2\u6740-\u9AD8\u5E76\u53D1-\u5173\u6CE8\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_7\u3001\u79D2\u6740-\u9AD8\u5E76\u53D1-\u5173\u6CE8\u95EE\u9898" aria-hidden="true">#</a> 7\u3001\u79D2\u6740\uFF08\u9AD8\u5E76\u53D1\uFF09\u5173\u6CE8\u95EE\u9898</h2><p><img src="`+A+'" alt="image-20211118141137454"></p><p><img src="'+L+'" alt="image-20211118141454410"></p>',395),U=[M];function D(B,N){return s(),a("div",null,U)}var W=n(P,[["render",D],["__file","spring-cloud-alibaba-note-high-level.html.vue"]]);export{W as default};
